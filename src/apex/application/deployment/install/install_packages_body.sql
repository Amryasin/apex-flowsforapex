prompt --application/deployment/install/install_packages_body
begin
--   Manifest
--     INSTALL: INSTALL-Packages Body
--   Manifest End
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.create_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_install_id=>wwv_flow_api.id(14200193318202500)
,p_name=>'Packages Body'
,p_sequence=>50
,p_script_type=>'INSTALL'
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'create or replace package body flow_api_pkg',
'as',
'',
'  function get_dgrm_name',
'  (',
'    p_prcs_id in flow_processes.prcs_id%type',
'  ) return varchar2',
'  is',
'    l_dgrm_name flow_diagrams.dgrm_name%type;',
'  begin',
'',
'    select dgrm.dgrm_name',
'      into l_dgrm_name',
'      from flow_processes prcs',
'      join flow_diagrams dgrm',
'        on dgrm.dgrm_id = prcs.prcs_dgrm_id',
'     where prcs.prcs_id = p_prcs_id',
'    ;',
'         ',
'    return l_dgrm_name;',
'  end get_dgrm_name;',
'  ',
'  function get_dgrm_id    --- FFA50 currently also exists in flow_engine - delete once function next_multistep_exists deleted',
'  (',
'    p_prcs_id in flow_processes.prcs_id%type',
'  ) return flow_processes.prcs_dgrm_id%type',
'  as',
'    l_prcs_dgrm_id flow_processes.prcs_dgrm_id%type;',
'  begin',
'    ',
'    select prcs.prcs_dgrm_id',
'      into l_prcs_dgrm_id',
'      from flow_processes prcs',
'     where prcs.prcs_id = p_prcs_id',
'    ;',
'    ',
'    return l_prcs_dgrm_id;',
'    ',
'  end get_dgrm_id;',
'',
'  function flow_create',
'  (',
'    pi_dgrm_name in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version in flow_diagrams.dgrm_version%type default null',
'  , pi_prcs_name in flow_processes.prcs_name%type',
'  ) return flow_processes.prcs_id%type',
'  as',
'    l_dgrm_id flow_diagrams.dgrm_id%type;',
'    l_dgrm_version flow_diagrams.dgrm_version%type;',
'  begin',
'  ',
'    if pi_dgrm_version is null then',
'      -- look for the ''released'' version of the diagram',
'      begin',
'          select dgrm_id ',
'            into l_dgrm_id',
'            from flow_diagrams',
'          where dgrm_name = pi_dgrm_name',
'            and dgrm_status = flow_constants_pkg.gc_dgrm_status_released',
'          ;',
'      exception',
'        when no_data_found then',
'          -- look for the version 0 (default) of ''draft'' of the diagram',
'          begin',
'              select dgrm_id',
'                into l_dgrm_id',
'                from flow_diagrams',
'              where dgrm_name = pi_dgrm_name',
'                and dgrm_status = flow_constants_pkg.gc_dgrm_status_draft',
'                and dgrm_version = ''0''',
'              ;',
'          exception',
'            when no_data_found then',
'                apex_error.add_error',
'                ( p_message => ''Cannot find released diagram or draft version 0 of diagram - please specify a version or diagram_id''',
'                , p_display_location => apex_error.c_on_error_page',
'                );  ',
'          end;',
'      end;            ',
'    else -- dgrm_version was specified',
'      select dgrm_id',
'        into l_dgrm_id',
'        from flow_diagrams',
'       where dgrm_name = pi_dgrm_name',
'         and dgrm_version = pi_dgrm_version',
'      ;',
'    end if;',
'',
'    return',
'      flow_instances.create_process',
'      (',
'        p_dgrm_id   => l_dgrm_id',
'      , p_prcs_name => pi_prcs_name',
'      )',
'    ;',
'  ',
'  end flow_create;',
'',
'  function flow_create',
'  (',
'    pi_dgrm_id   in flow_diagrams.dgrm_id%type',
'  , pi_prcs_name in flow_processes.prcs_name%type',
'  ) return flow_processes.prcs_id%type',
'  is',
'    l_ret flow_processes.prcs_id%type;',
'  begin',
'    return flow_instances.create_process',
'           ( p_dgrm_id => pi_dgrm_id',
'           , p_prcs_name => pi_prcs_name',
'           )',
'    ;',
'  end flow_create;',
'',
'  procedure flow_create',
'  (',
'    pi_dgrm_name in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version in flow_diagrams.dgrm_version%type default null',
'  , pi_prcs_name in flow_processes.prcs_name%type',
'  )',
'  as',
'    l_prcs_id flow_processes.prcs_id%type;',
'  begin',
'    l_prcs_id :=',
'      flow_create',
'      (',
'        pi_dgrm_name => pi_dgrm_name',
'      , pi_dgrm_version => pi_dgrm_version',
'      , pi_prcs_name => pi_prcs_name',
'      );',
'  end flow_create;',
'',
'  procedure flow_create',
'  (',
'    pi_dgrm_id   in flow_diagrams.dgrm_id%type',
'  , pi_prcs_name in flow_processes.prcs_name%type',
'  )',
'  as',
'    l_prcs_id flow_processes.prcs_id%type;',
'  begin',
'    l_prcs_id :=',
'      flow_instances.create_process',
'      (',
'        p_dgrm_id   => pi_dgrm_id',
'      , p_prcs_name => pi_prcs_name',
'      );',
'  end flow_create;',
'',
'  procedure flow_start',
'    ( p_process_id in flow_processes.prcs_id%type',
'    )',
'    is',
'    begin  ',
'        apex_debug.message(p_message => ''Begin flow_start'', p_level => 3) ;',
'',
'        flow_globals.set_context',
'        ( pi_prcs_id => p_process_id',
'        );',
'  ',
'        flow_instances.start_process ',
'        ( p_process_id => p_process_id',
'        );',
'  end flow_start;',
'',
'  procedure flow_reserve_step',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_reservation   in flow_subflows.sbfl_reservation%type',
'  )',
'  is ',
'  begin',
'',
'    flow_reservations.reserve_step',
'    ( p_process_id  => p_process_id',
'    , p_subflow_id  => p_subflow_id',
'    , p_reservation => p_reservation',
'    );',
'  end flow_reserve_step;',
'',
'  procedure flow_release_step',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  )',
'  is ',
'  begin',
'',
'    flow_reservations.release_step',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );',
'  end flow_release_step;',
'',
'  procedure flow_start_step',
'  (',
'    p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  )',
'  is ',
'  begin',
'    flow_engine.start_step',
'    ( p_process_id  => p_process_id',
'    , p_subflow_id  => p_subflow_id',
'    );',
'  end flow_start_step;',
'',
'  procedure flow_restart_step',
'  (',
'    p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_comment       in flow_instance_event_log.lgpr_comment%type default null',
'  )',
'  is ',
'  begin ',
'    flow_globals.set_context',
'    ( pi_prcs_id => p_process_id',
'    , pi_sbfl_id => p_subflow_id',
'    );',
'    flow_engine.restart_step',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_comment => p_comment',
'    );',
'  end flow_restart_step;',
'',
'',
'  procedure flow_complete_step',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  )',
'  is ',
'  begin',
'    flow_globals.set_context',
'    ( pi_prcs_id => p_process_id',
'    , pi_sbfl_id => p_subflow_id',
'    );',
'    flow_engine.flow_complete_step',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_recursive_call => false',
'    );',
'end flow_complete_step;',
'',
'  procedure flow_reset',
'  ( p_process_id in flow_processes.prcs_id%type',
'  , p_comment     in flow_instance_event_log.lgpr_comment%type default null',
'  )',
'  is',
'  begin',
'    apex_debug.enter ',
'    ( p_routine_name => ''flow_reset''',
'    );',
'    flow_instances.reset_process ',
'    ( p_process_id  => p_process_id',
'    , p_comment     => p_comment',
'    );',
'  end flow_reset;',
'',
'  procedure flow_terminate',
'  ( p_process_id  in flow_processes.prcs_id%type',
'  , p_comment     in flow_instance_event_log.lgpr_comment%type default null',
'  )',
'  is',
'  begin',
'    apex_debug.enter ',
'    ( p_routine_name => ''flow_terminate''',
'    );',
'    flow_instances.terminate_process ',
'    ( p_process_id => p_process_id',
'    , p_comment    => p_comment',
'    );',
'  end flow_terminate;',
'',
'  procedure flow_delete',
'  ( p_process_id  in flow_processes.prcs_id%type',
'  , p_comment     in flow_instance_event_log.lgpr_comment%type default null',
'  )',
'  is',
'  begin',
'    apex_debug.enter',
'    (p_routine_name => ''flow_delete''',
'    );',
'    flow_instances.delete_process ',
'    ( p_process_id => p_process_id',
'    , p_comment    => p_comment',
'    );',
'  end flow_delete;',
'',
'  function get_current_usertask_url',
'  (',
'    p_process_id in flow_processes.prcs_id%type',
'  , p_subflow_id in flow_subflows.sbfl_id%type',
'  ) return varchar2',
'  as',
'    l_objt_id flow_objects.objt_id%type;',
'  begin',
'    apex_debug.trace ( p_message => ''Entering GET_CURRENT_USERTASK_URL'' );',
'',
'    select objt.objt_id',
'      into l_objt_id',
'      from flow_subflows sbfl',
'      join flow_processes prcs',
'        on prcs.prcs_id = sbfl.sbfl_prcs_id',
'      join flow_objects objt',
'        on objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'       and objt.objt_bpmn_id = sbfl.sbfl_current',
'     where sbfl.sbfl_prcs_id = p_process_id',
'       and sbfl.sbfl_id = p_subflow_id',
'       and objt.objt_tag_name = flow_constants_pkg.gc_bpmn_usertask',
'    ;',
'',
'    apex_debug.trace( p_message => ''Found OBJT_ID %s'', p0 => l_objt_id );',
'',
'    return ',
'      flow_usertask_pkg.get_url',
'      (',
'        pi_prcs_id => p_process_id',
'      , pi_sbfl_id => p_subflow_id',
'      , pi_objt_id => l_objt_id',
'      );',
'  end get_current_usertask_url;',
'',
'end flow_api_pkg;',
'/',
'',
'create or replace package body flow_boundary_events',
'is ',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'  procedure set_boundary_timers',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  )',
'  is ',
'    l_new_non_int_timer_sbfl  flow_subflows.sbfl_id%type;',
'    l_parent_tag              varchar2(50);',
'  begin',
'    apex_debug.enter ',
'    ( ''set_boundary_timers''',
'    , ''subflow'', p_subflow_id',
'    );',
'    begin',
'      for boundary_timers in ',
'        (',
'        select objt.objt_bpmn_id as objt_bpmn_id ',
'             , objt.objt_interrupting as objt_interrupting',
'             , sbfl.sbfl_process_level as sbfl_process_level',
'             , sbfl.sbfl_dgrm_id as sbfl_dgrm_id',
'             , sbfl.sbfl_current as parent_current_object',
'          from flow_objects objt',
'          join flow_subflows sbfl ',
'            on sbfl.sbfl_current = objt.objt_attached_to',
'          join flow_processes prcs ',
'            on prcs.prcs_id = sbfl.sbfl_prcs_id',
'           and prcs.prcs_dgrm_id = objt.objt_dgrm_id',
'         where objt.objt_tag_name = flow_constants_pkg.gc_bpmn_boundary_event  ',
'           and objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition',
'           and sbfl.sbfl_id = p_subflow_id',
'           and prcs.prcs_id = p_process_id',
'        )',
'      loop',
'        case boundary_timers.objt_interrupting',
'        when 1 then',
'          -- interupting timer.  set timer on current object in current subflow',
'          flow_timers_pkg.start_timer',
'          ( pi_prcs_id => p_process_id',
'          , pi_sbfl_id => p_subflow_id',
'          );',
'          l_parent_tag := '':SIT'';  -- (Self, Interrupting, Timer)',
'        when 0 then',
'          -- non-interupting timer.  create child subflow starting at boundary event and start timer',
'          l_new_non_int_timer_sbfl := flow_engine_util.subflow_start',
'          ( p_process_id => p_process_id',
'          , p_parent_subflow => p_subflow_id',
'          , p_starting_object => boundary_timers.objt_bpmn_id',
'          , p_current_object => boundary_timers.objt_bpmn_id',
'          , p_route => ''boundary_timer''',
'          , p_last_completed => boundary_timers.parent_current_object ',
'          , p_status => flow_constants_pkg.gc_sbfl_status_waiting_timer',
'          , p_parent_sbfl_proc_level => boundary_timers.sbfl_process_level',
'          , p_new_proc_level => false',
'          , p_dgrm_id => boundary_timers.sbfl_dgrm_id',
'          );',
'',
'          flow_timers_pkg.start_timer',
'          ( pi_prcs_id => p_process_id',
'          , pi_sbfl_id => l_new_non_int_timer_sbfl',
'          );',
'          -- set timer flag on child (Self, Noninterrupting, Timer)',
'          update flow_subflows sbfl',
'              set sbfl.sbfl_has_events = sbfl.sbfl_has_events||'':SNT''',
'            where sbfl.sbfl_id = l_new_non_int_timer_sbfl',
'              and sbfl.sbfl_prcs_id = p_process_id',
'          ;',
'          l_parent_tag := '':CNT'';  -- (Child, Noninterrupting, Timer)',
'        end case;',
'        --- set timer flag on parent (it can get more than 1)',
'        update flow_subflows sbfl',
'          set sbfl.sbfl_has_events = sbfl.sbfl_has_events||l_parent_tag',
'        where sbfl.sbfl_id = p_subflow_id',
'          and sbfl.sbfl_prcs_id = p_process_id',
'        ;',
'      end loop;',
'    exception',
'      when no_data_found then',
'        return;',
'    end;',
'  end set_boundary_timers;',
'',
'  procedure unset_boundary_timers',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  )',
'  is ',
'    l_non_int_timer_sbfl  flow_subflows.sbfl_id%type;',
'    l_return_code         number;',
'  begin',
'    apex_debug.enter ',
'    ( ''unset_boundary_timers''',
'    , ''subflow'', p_subflow_id',
'    );',
'    begin',
'      for boundary_timers in ',
'        (',
'        select objt.objt_bpmn_id as objt_bpmn_id ',
'             , objt.objt_interrupting as objt_interrupting',
'          from flow_objects objt',
'          join flow_subflows sbfl ',
'            on sbfl.sbfl_current = objt.objt_attached_to',
'          join flow_processes prcs ',
'            on prcs.prcs_id = sbfl.sbfl_prcs_id',
'           and prcs.prcs_dgrm_id = objt.objt_dgrm_id',
'         where objt.objt_tag_name = flow_constants_pkg.gc_bpmn_boundary_event  ',
'           and objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition',
'           and sbfl.sbfl_id = p_subflow_id',
'           and prcs.prcs_id = p_process_id',
'        )',
'      loop',
'        case boundary_timers.objt_interrupting',
'        when 1 then',
'          -- interupting timer.  terminate timer on current object in current subflow',
'          flow_timers_pkg.terminate_timer',
'          ( pi_prcs_id => p_process_id',
'          , pi_sbfl_id => p_subflow_id',
'          , po_return_code => l_return_code',
'          );',
'        when 0 then',
'          -- non-interupting timer.  find child subflow starting at boundary event and delete if not yet fired',
'          -- timer will delete cascade',
'          delete from flow_subflows',
'          where sbfl_starting_object = boundary_timers.objt_bpmn_id',
'          and sbfl_sbfl_id = p_subflow_id',
'          and sbfl_prcs_id = p_process_id',
'          and sbfl_status = flow_constants_pkg.gc_sbfl_status_waiting_timer',
'          ;',
'        end case;',
'      end loop;',
'      -- remove the event flags from the subflow',
'      update flow_subflows sbfl',
'         set sbfl_has_events = ''''',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'    exception',
'      when no_data_found then',
'        return;',
'    end;',
'  end unset_boundary_timers;',
'',
'  procedure lock_child_boundary_timers',
'  ( p_process_id          in flow_processes.prcs_id%type',
'  , p_subflow_id          in flow_subflows.sbfl_id%type',
'  , p_parent_objt_bpmn_id in flow_objects.objt_bpmn_id%type',
'  ) ',
'  is ',
'    cursor c is ',
'        select child_sbfl.sbfl_id, child_timr.timr_id',
'          from flow_subflows child_sbfl',
'          join flow_timers child_timr',
'            on child_timr.timr_prcs_id = child_sbfl.sbfl_prcs_id',
'           and child_timr.timr_sbfl_id = child_sbfl.sbfl_id',
'         where child_sbfl.sbfl_starting_object = p_parent_objt_bpmn_id ',
'           and child_sbfl.sbfl_current = p_parent_objt_bpmn_id ',
'           and child_sbfl.sbfl_prcs_id = p_process_id',
'           and child_sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_waiting_timer',
'         order by child_sbfl.sbfl_id',
'        for update of child_sbfl.sbfl_id, child_timr.timr_id;',
'  begin ',
'    open c;',
'    close c;',
'  exception ',
'    when lock_timeout then',
'      apex_error.add_error',
'      ( p_message => ''Child Boundary Subflows or Timers of ''||p_subflow_id||'' currently locked by another user.  Retry your transaction later.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'  end lock_child_boundary_timers; ',
'',
'  procedure handle_interrupting_boundary_event',
'    ( p_process_id in flow_processes.prcs_id%type',
'    , p_subflow_id in flow_subflows.sbfl_id%type',
'    ) ',
'  is',
'    l_boundary_objt_bpmn_id  flow_objects.objt_bpmn_id%type;',
'    l_parent_objt_tag        flow_objects.objt_tag_name%type;',
'    l_parent_objt_bpmn_id    flow_objects.objt_bpmn_id%type;',
'    l_child_process_level    flow_subflows.sbfl_process_level%type;',
'  begin',
'    apex_debug.enter ',
'    ( ''handle_interrupting_boundary_event''',
'    , ''subflow'', p_subflow_id',
'    );',
'',
'    select boundary_objt.objt_bpmn_id',
'         , main_objt.objt_tag_name',
'         , main_objt.objt_bpmn_id',
'      into l_boundary_objt_bpmn_id',
'         , l_parent_objt_tag',
'         , l_parent_objt_bpmn_id',
'      from flow_subflows sbfl',
'      join flow_processes prcs',
'        on prcs.prcs_id = sbfl.sbfl_prcs_id',
'      join flow_objects main_objt',
'        on main_objt.objt_bpmn_id = sbfl.sbfl_current',
'       and main_objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'      join flow_objects boundary_objt',
'        on boundary_objt.objt_attached_to = main_objt.objt_bpmn_id',
'       and boundary_objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'     where sbfl.sbfl_id = p_subflow_id',
'       and prcs.prcs_id = p_process_id',
'       and boundary_objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition',
'       and boundary_objt.objt_interrupting = 1',
'        ;',
'    if l_parent_objt_tag = flow_constants_pkg.gc_bpmn_subprocess',
'    then',
'       -- if the boundary event is on a subprocess (rather than a task type), terminate the subprocess level',
'       -- find the process level inside the subprocess and then stop all processing at that level and below',
'      select distinct sbfl.sbfl_process_level',
'        into l_child_process_level',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_sbfl_id = p_subflow_id',
'       ;',
'       if l_child_process_level is not null ',
'       then ',
'          flow_engine_util.terminate_level',
'          ( p_process_id    => p_process_id',
'          , p_process_level => l_child_process_level',
'          );',
'       end if;',
'    end if;',
'    -- clean up any other boundary timers on the object',
'    flow_boundary_events.unset_boundary_timers ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );',
'    -- switch processing onto boundaryEvent path and do next step',
'    update flow_subflows sbfl',
'       set sbfl.sbfl_current = l_boundary_objt_bpmn_id',
'         , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'         , sbfl.sbfl_last_completed = l_parent_objt_bpmn_id',
'         , sbfl.sbfl_last_update = systimestamp ',
'     where sbfl.sbfl_id = p_subflow_id ',
'       and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- process on-event variable expressions for the boundary event',
'    flow_expressions.process_expressions',
'    ( pi_objt_bpmn_id => l_boundary_objt_bpmn_id  ',
'    , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'    , pi_prcs_id      => p_process_id',
'    , pi_sbfl_id      => p_subflow_id',
'    );',
'    -- step off on new path',
'    flow_engine.flow_complete_step ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );',
'',
'  end handle_interrupting_boundary_event;',
'',
'  procedure get_boundary_event',
'  ( pi_dgrm_id                  in  flow_diagrams.dgrm_id%type',
'  , pi_throw_objt_bpmn_id       in  flow_objects.objt_bpmn_id%type',
'  , pi_par_sbfl                 in  flow_subflows.sbfl_id%type',
'  , pi_sub_tag_name             in  flow_objects.objt_sub_tag_name%type ',
'  , po_boundary_objt            out flow_objects.objt_bpmn_id%type',
'  , po_interrupting             out flow_objects.objt_interrupting%type',
'  )',
'is ',
'begin',
'    -- in later release if named errors and escalations are supported, change this to look for specific event',
'    select boundary_objt.objt_bpmn_id',
'         , boundary_objt.objt_interrupting',
'      into po_boundary_objt',
'         , po_interrupting',
'      from flow_objects boundary_objt',
'      join flow_subflows parent_sbfl',
'        on parent_sbfl.sbfl_current = boundary_objt.objt_attached_to',
'      join flow_processes prcs',
'        on prcs.prcs_id = parent_sbfl.sbfl_prcs_id',
'       and prcs.prcs_dgrm_id = boundary_objt.objt_dgrm_id',
'     where parent_sbfl.sbfl_id = pi_par_sbfl',
'       and boundary_objt.objt_sub_tag_name = pi_sub_tag_name',
'       and boundary_objt.objt_dgrm_id = pi_dgrm_id',
'        ;',
'exception',
'  when no_data_found then',
'      -- no boundary event found -- returned flow should continue from normal return',
'      po_boundary_objt := null;',
'      if pi_sub_tag_name in (flow_constants_pkg.gc_bpmn_error_event_definition) then',
'         po_interrupting := 1;',
'      else ',
'         po_interrupting := 0;',
'      end if;',
'  when too_many_rows then',
'      apex_error.add_error',
'      ( p_message => ''More than one ''||pi_sub_tag_name||'' boundaryEvent found on sub process.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'end get_boundary_event;',
'',
'',
'procedure process_boundary_event',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_step_info     in flow_types_pkg.flow_step_info',
'  , p_par_sbfl      in flow_subflows.sbfl_id%type',
'  , p_process_level in flow_subflows.sbfl_process_level%type',
'  )',
'is ',
'  l_next_objt             flow_objects.objt_bpmn_id%type;',
'  l_interrupting          flow_objects.objt_interrupting%type;',
'  l_new_sbfl              flow_subflows.sbfl_id%type;',
'  l_parent_processs_level flow_subflows.sbfl_process_level%type;',
'  l_parent_dgrm_id        flow_diagrams.dgrm_id%type;',
'begin ',
'  apex_debug.enter ',
'  ( ''process_boundary_event''',
'  , ''subflow'', p_subflow_id',
'  );',
'  -- set the throwing event to completed',
'  flow_logging.log_step_completion   ',
'  ( p_process_id => p_process_id',
'  , p_subflow_id => p_subflow_id',
'  , p_completed_object => p_step_info.target_objt_ref',
'  );',
'  -- find matching boundary event of its type',
'  get_boundary_event',
'  ( pi_dgrm_id => p_step_info.dgrm_id',
'  , pi_throw_objt_bpmn_id => p_step_info.target_objt_ref',
'  , pi_par_sbfl => p_par_sbfl',
'  , pi_sub_tag_name => p_step_info.target_objt_subtag',
'  , po_boundary_objt => l_next_objt',
'  , po_interrupting => l_interrupting',
'  );',
'  if l_next_objt is null then',
'    apex_error.add_error',
'    ( p_message => ''No boundaryEvent of type ''||p_step_info.target_objt_subtag||'' found to catch event.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'  end if;',
'  if l_interrupting = 1 then',
'    -- first remove any non-interrupting timers that are on the parent event',
'    unset_boundary_timers (p_process_id, p_par_sbfl);',
'    -- stop processing in sub process and all child levels',
'    flow_engine_util.terminate_level',
'    ( p_process_id => p_process_id',
'    , p_process_level => p_process_level',
'    );        ',
'    -- set parent subflow to boundary event and do flow_complete_step',
'    update flow_subflows sbfl',
'        set sbfl.sbfl_current = l_next_objt',
'          , sbfl.sbfl_last_completed = p_step_info.target_objt_ref ',
'          , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'      where sbfl.sbfl_id = p_par_sbfl',
'        and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- process on-event expressions for boundary event',
'    flow_expressions.process_expressions',
'    ( pi_objt_bpmn_id => l_next_objt  ',
'    , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'    , pi_prcs_id      => p_process_id',
'    , pi_sbfl_id      => p_par_sbfl',
'    );',
'',
'    if p_step_info.target_objt_tag = flow_constants_pkg.gc_bpmn_intermediate_throw_event  ',
'    then ',
'      flow_engine.flow_complete_step',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_par_sbfl',
'      ); ',
'    end if;',
'',
'  else ',
'      -- non interrupting.  ',
'      select par_sbfl.sbfl_process_level',
'           , par_sbfl.sbfl_dgrm_id',
'        into l_parent_processs_level ',
'           , l_parent_dgrm_id',
'        from flow_subflows par_sbfl',
'        where par_sbfl.sbfl_id = p_par_sbfl',
'          and par_sbfl.sbfl_prcs_id = p_process_id',
'          ;',
'      -- start new subflow starting at the boundary event and step to next task',
'      l_new_sbfl := flow_engine_util.subflow_start',
'      ( p_process_id => p_process_id',
'      , p_parent_subflow => p_par_sbfl',
'      , p_starting_object => l_next_objt',
'      , p_current_object => l_next_objt',
'      , p_route => ''from ''||l_next_objt',
'      , p_last_completed => p_step_info.target_objt_ref -- even thou it hasnt yet completed ',
'      , p_status => flow_constants_pkg.gc_sbfl_status_running',
'      , p_parent_sbfl_proc_level => l_parent_processs_level',
'      , p_new_proc_level => false',
'      , p_dgrm_id => l_parent_dgrm_id',
'      );',
'      -- process on-event expressions for boundary event',
'      flow_expressions.process_expressions',
'      ( pi_objt_bpmn_id => l_next_objt  ',
'      , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'      , pi_prcs_id      => p_process_id',
'      , pi_sbfl_id      => l_new_sbfl',
'      );     ',
'      -- step forward from boundary event',
'      flow_engine.flow_complete_step ',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => l_new_sbfl',
'      );',
'      apex_debug.message',
'      (',
'        p_message => ''process_boundary_event.  target_objt_tag :''||p_step_info.target_objt_subtag',
'      , p_level => 3',
'      );',
'  ',
'      if p_step_info.target_objt_tag = flow_constants_pkg.gc_bpmn_intermediate_throw_event  ',
'      then ',
'          -- do next_step on triggering subflow if an ITE ',
'          flow_engine.flow_complete_step ',
'          ( p_process_id => p_process_id',
'          , p_subflow_id => p_subflow_id',
'          );',
'      elsif p_step_info.target_objt_tag = flow_constants_pkg.gc_bpmn_end_event  ',
'      then',
'          -- normal end event',
'          flow_engine_util.subflow_complete',
'          ( p_process_id => p_process_id',
'          , p_subflow_id => p_subflow_id',
'          );',
'      end if;',
'    end if;',
'  end process_boundary_event;',
'',
'',
'end flow_boundary_events;',
'/',
'',
'create or replace package body flow_bpmn_parser_pkg',
'as',
'',
'  -- Standard Data Types to use',
'  subtype t_vc200 is varchar2(200 char);',
'',
'  -- Types for temporary storage of parsing result',
'  type t_objt_rec is',
'    record',
'    (',
'      objt_name           t_vc200',
'    , objt_tag_name       flow_types_pkg.t_bpmn_id',
'    , objt_parent_bpmn_id flow_types_pkg.t_bpmn_id',
'    , objt_sub_tag_name   flow_types_pkg.t_bpmn_id',
'    , objt_attached_to    flow_types_pkg.t_bpmn_id',
'    , objt_interrupting   number',
'    );',
'  type t_objt_tab is table of t_objt_rec index by flow_types_pkg.t_bpmn_id;',
'',
'  type t_obat_rec is',
'    record',
'    (',
'      obat_key            flow_object_attributes.obat_key%type',
'    , obat_num_value      flow_object_attributes.obat_num_value%type',
'    , obat_date_value     flow_object_attributes.obat_date_value%type',
'    , obat_vc_value       flow_object_attributes.obat_vc_value%type',
'    , obat_clob_value     flow_object_attributes.obat_clob_value%type',
'    );',
'  type t_obat_tab is table of t_obat_rec index by pls_integer;',
'',
'  type t_objt_obat_rec is',
'    record',
'    (',
'      obat_sub_tag_name   flow_objects.objt_sub_tag_name%type',
'    , obat_tab            t_obat_tab',
'    );',
'  type t_objt_obat_tab is table of t_objt_obat_rec index by flow_types_pkg.t_bpmn_id;',
'',
'  type t_expr_rec is',
'    record',
'    (',
'      expr_set        flow_object_expressions.expr_set%type',
'    , expr_order      flow_object_expressions.expr_order%type',
'    , expr_var_name   flow_object_expressions.expr_var_name%type',
'    , expr_var_type   flow_object_expressions.expr_var_type%type',
'    , expr_type       flow_object_expressions.expr_type%type',
'    , expr_expression flow_object_expressions.expr_expression%type',
'    );',
'  type t_expr_tab is table of t_expr_rec index by pls_integer;',
'  type t_objt_expr_tab is table of t_expr_tab index by flow_types_pkg.t_bpmn_id;',
'',
'  type t_conn_rec is',
'    record',
'    (',
'      conn_name        t_vc200',
'    , conn_src_bpmn_id flow_types_pkg.t_bpmn_id',
'    , conn_tgt_bpmn_id flow_types_pkg.t_bpmn_id',
'    , conn_tag_name    flow_types_pkg.t_bpmn_id',
'    , conn_origin      flow_types_pkg.t_bpmn_id',
'    );',
'  type t_conn_tab is table of t_conn_rec index by flow_types_pkg.t_bpmn_id;',
'',
'  type t_bpmn_ref_tab is table of flow_types_pkg.t_bpmn_id index by flow_types_pkg.t_bpmn_id;',
'  type t_bpmn_id_tab is table of number index by flow_types_pkg.t_bpmn_id;',
'',
'  type t_id_lookup_tab is table of number index by flow_types_pkg.t_bpmn_id;',
'',
'  -- Variables to hold data during parse run',
'  g_dgrm_id        flow_diagrams.dgrm_id%type;',
'  g_objects        t_objt_tab;',
'  g_obj_attribs    t_objt_obat_tab;',
'  g_objt_expr      t_objt_expr_tab;',
'  g_connections    t_conn_tab;',
'  g_lane_refs      t_bpmn_ref_tab;',
'  g_default_cons   t_bpmn_id_tab;',
'  g_objt_lookup    t_id_lookup_tab;',
'',
'',
'  procedure register_object',
'  (',
'    pi_objt_bpmn_id        in flow_objects.objt_bpmn_id%type',
'  , pi_objt_name           in flow_objects.objt_name%type default null',
'  , pi_objt_tag_name       in flow_objects.objt_tag_name%type default null',
'  , pi_objt_sub_tag_name   in flow_objects.objt_sub_tag_name%type default null',
'  , pi_objt_parent_bpmn_id in flow_objects.objt_bpmn_id%type default null',
'  , pi_objt_attached_to    in flow_objects.objt_attached_to%type default null ',
'  , pi_objt_interrupting   in flow_objects.objt_interrupting%type default null',
'  )',
'  as',
'    l_objt_rec t_objt_rec;',
'  begin',
'    if pi_objt_bpmn_id is not null then',
'      l_objt_rec.objt_name           := pi_objt_name;',
'      l_objt_rec.objt_tag_name       := pi_objt_tag_name;',
'      l_objt_rec.objt_sub_tag_name   := pi_objt_sub_tag_name;',
'      l_objt_rec.objt_parent_bpmn_id := pi_objt_parent_bpmn_id;',
'      l_objt_rec.objt_attached_to    := pi_objt_attached_to;',
'      l_objt_rec.objt_interrupting   := pi_objt_interrupting;',
'',
'      g_objects( pi_objt_bpmn_id ) := l_objt_rec;',
'    end if;',
'  end register_object;',
'',
'  procedure register_object_attributes',
'  (',
'    pi_objt_bpmn_id       in flow_objects.objt_bpmn_id%type',
'  , pi_objt_sub_tag_name  in flow_objects.objt_sub_tag_name%type default null',
'  , pi_obat_key           in flow_object_attributes.obat_key%type',
'  , pi_obat_num_value     in flow_object_attributes.obat_num_value%type default null',
'  , pi_obat_date_value    in flow_object_attributes.obat_date_value%type default null',
'  , pi_obat_vc_value      in flow_object_attributes.obat_vc_value%type default null',
'  , pi_obat_clob_value    in flow_object_attributes.obat_clob_value%type default null',
'  )',
'  as',
'    l_objt_sub_tag_name     flow_objects.objt_sub_tag_name%type;',
'',
'    l_obat_rec              t_obat_rec;',
'    l_obat_idx              pls_integer;',
'	l_objt_obat_idx_exists  boolean := false;',
'  begin',
'    if pi_objt_bpmn_id is not null then',
'',
'	  -- check, if the index already exists',
'	  begin',
'	     l_objt_sub_tag_name := g_obj_attribs(pi_objt_bpmn_id).obat_sub_tag_name;',
'		 l_objt_obat_idx_exists := tru'))
);
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'e;',
'	  exception',
'	    when no_data_found then',
'		 l_objt_obat_idx_exists := false;',
'	  end;',
'',
'	  -- fill attributes record',
'	  l_obat_rec.obat_key        := pi_obat_key;',
'	  l_obat_rec.obat_num_value  := pi_obat_num_value;',
'	  l_obat_rec.obat_date_value := pi_obat_date_value;',
'	  l_obat_rec.obat_vc_value   := pi_obat_vc_value;',
'	  l_obat_rec.obat_clob_value := pi_obat_clob_value;',
'	  ',
'      if not l_objt_obat_idx_exists then',
'        g_obj_attribs(pi_objt_bpmn_id).obat_sub_tag_name := pi_objt_sub_tag_name;',
'		g_obj_attribs(pi_objt_bpmn_id).obat_tab(1) := l_obat_rec;',
'	  else',
'        l_obat_idx := coalesce(g_obj_attribs(pi_objt_bpmn_id).obat_tab.last,0);',
'        g_obj_attribs(pi_objt_bpmn_id).obat_tab(l_obat_idx + 1) := l_obat_rec;',
'	  end if;',
'',
'    end if;',
'  end register_object_attributes;',
'',
'  procedure register_object_expression',
'  (',
'    pi_objt_bpmn_id    in flow_objects.objt_bpmn_id%type',
'  , pi_expr_set        in flow_object_expressions.expr_set%type',
'  , pi_expr_order      in flow_object_expressions.expr_order%type',
'  , pi_expr_var_name   in flow_object_expressions.expr_var_name%type',
'  , pi_expr_var_type   in flow_object_expressions.expr_var_type%type',
'  , pi_expr_type       in flow_object_expressions.expr_type%type',
'  , pi_expr_expression in flow_object_expressions.expr_expression%type',
'  )',
'  as',
'    l_object_expression t_expr_rec;',
'    l_insert_index      pls_integer := 0;',
'  begin',
'    if pi_objt_bpmn_id is not null then',
'      l_object_expression.expr_set        := pi_expr_set;',
'      l_object_expression.expr_order      := pi_expr_order;',
'      l_object_expression.expr_var_name   := pi_expr_var_name;',
'      l_object_expression.expr_var_type   := pi_expr_var_type;',
'      l_object_expression.expr_type       := pi_expr_type;',
'      l_object_expression.expr_expression := pi_expr_expression;    ',
'',
'      -- Verify if we already have some variable expression for same object',
'      if g_objt_expr.exists(pi_objt_bpmn_id) then',
'        l_insert_index := g_objt_expr(pi_objt_bpmn_id).count + 1;',
'      else',
'        l_insert_index := 1;',
'      end if;',
'',
'      g_objt_expr(pi_objt_bpmn_id)(l_insert_index) := l_object_expression;',
'    end if;',
'  end register_object_expression;',
'',
'  procedure register_connection',
'  (',
'    pi_conn_bpmn_id     in flow_connections.conn_bpmn_id%type',
'  , pi_conn_name        in flow_connections.conn_name%type',
'  , pi_conn_src_bpmn_id in flow_objects.objt_bpmn_id%type',
'  , pi_conn_tgt_bpmn_id in flow_objects.objt_bpmn_id%type',
'  , pi_conn_tag_name    in flow_connections.conn_tag_name%type',
'  , pi_conn_origin      in flow_connections.conn_origin%type',
'  )',
'  as',
'    l_conn_rec t_conn_rec;',
'  begin',
'    if pi_conn_bpmn_id is not null then',
'      l_conn_rec.conn_name        := pi_conn_name;',
'      l_conn_rec.conn_src_bpmn_id := pi_conn_src_bpmn_id;',
'      l_conn_rec.conn_tgt_bpmn_id := pi_conn_tgt_bpmn_id;',
'      l_conn_rec.conn_tag_name    := pi_conn_tag_name;',
'      l_conn_rec.conn_origin      := pi_conn_origin;',
'',
'      g_connections( pi_conn_bpmn_id ) := l_conn_rec;',
'    end if;',
'  end register_connection;',
'',
'  procedure insert_object',
'  (',
'    pi_objt_bpmn_id       in flow_objects.objt_bpmn_id%type',
'  , pi_objt_name          in flow_objects.objt_name%type default null',
'  , pi_objt_tag_name      in flow_objects.objt_tag_name%type default null',
'  , pi_objt_objt_id       in flow_objects.objt_objt_id%type default null',
'  , pi_objt_sub_tag_name  in flow_objects.objt_sub_tag_name%type default null',
'  , pi_objt_objt_lane_id  in flow_objects.objt_objt_lane_id%type default null',
'  , pi_objt_attached_to   in flow_objects.objt_attached_to%type default null',
'  , pi_objt_interrupting  in flow_objects.objt_interrupting%type default null',
'  , po_objt_id           out nocopy flow_objects.objt_id%type',
'  )',
'  as',
'  begin',
'    insert',
'      into flow_objects',
'           (',
'             objt_dgrm_id',
'           , objt_bpmn_id',
'           , objt_name',
'           , objt_tag_name',
'           , objt_sub_tag_name',
'           , objt_objt_id',
'           , objt_objt_lane_id',
'           , objt_attached_to',
'           , objt_interrupting',
'           )',
'    values (',
'             g_dgrm_id',
'           , pi_objt_bpmn_id',
'           , pi_objt_name',
'           , pi_objt_tag_name',
'           , pi_objt_sub_tag_name',
'           , pi_objt_objt_id',
'           , pi_objt_objt_lane_id',
'           , pi_objt_attached_to',
'           , pi_objt_interrupting',
'           )',
'      returning objt_id into po_objt_id',
'    ;',
'  end insert_object;',
'',
'  procedure insert_object_attributes',
'  (',
'    pi_objt_id          in flow_object_attributes.obat_objt_id%type',
'  , pi_obat_key         in flow_object_attributes.obat_key%type',
'  , pi_obat_num_value   in flow_object_attributes.obat_num_value%type default null',
'  , pi_obat_date_value  in flow_object_attributes.obat_date_value%type default null',
'  , pi_obat_vc_value    in flow_object_attributes.obat_vc_value%type default null',
'  , pi_obat_clob_value  in flow_object_attributes.obat_clob_value%type default null',
'  )',
'  as',
'  begin',
'    insert',
'      into flow_object_attributes',
'           (',
'             obat_objt_id',
'           , obat_key',
'           , obat_num_value',
'           , obat_date_value',
'           , obat_vc_value',
'           , obat_clob_value',
'           )',
'    values (',
'             pi_objt_id',
'           , pi_obat_key',
'           , pi_obat_num_value',
'           , pi_obat_date_value',
'           , pi_obat_vc_value',
'           , pi_obat_clob_value',
'           )',
'    ;',
'  end insert_object_attributes;',
'',
'  procedure insert_object_expression',
'  (',
'    pi_expr_objt_id    in flow_object_expressions.expr_objt_id%type',
'  , pi_expr_set        in flow_object_expressions.expr_set%type',
'  , pi_expr_order      in flow_object_expressions.expr_order%type',
'  , pi_expr_var_name   in flow_object_expressions.expr_var_name%type',
'  , pi_expr_var_type   in flow_object_expressions.expr_var_type%type',
'  , pi_expr_type       in flow_object_expressions.expr_type%type',
'  , pi_expr_expression in flow_object_expressions.expr_expression%type',
'  )',
'  as',
'  begin',
'    insert',
'      into flow_object_expressions',
'           (',
'             expr_objt_id',
'           , expr_set',
'           , expr_order',
'           , expr_var_name',
'           , expr_var_type',
'           , expr_type',
'           , expr_expression',
'           )',
'    values (',
'             pi_expr_objt_id',
'           , pi_expr_set',
'           , pi_expr_order',
'           , pi_expr_var_name',
'           , upper(pi_expr_var_type)',
'           , pi_expr_type',
'           , pi_expr_expression',
'           )',
'    ;',
'  end insert_object_expression;',
'',
'  procedure insert_connection',
'  (',
'    pi_conn_bpmn_id      in flow_connections.conn_bpmn_id%type',
'  , pi_conn_name         in flow_connections.conn_name%type',
'  , pi_conn_src_objt_id  in flow_connections.conn_src_objt_id%type',
'  , pi_conn_tgt_objt_id  in flow_connections.conn_tgt_objt_id%type',
'  , pi_conn_tag_name     in flow_connections.conn_tag_name%type',
'  , pi_conn_origin       in flow_connections.conn_origin%type -- ?? needed ??',
'  , po_conn_id          out flow_connections.conn_id%type',
'  )',
'  as',
'    l_conn_is_default flow_connections.conn_is_default%type := 0;',
'  begin',
'    l_conn_is_default := case when g_default_cons.exists(pi_conn_bpmn_id) then 1 else 0 end;',
'    insert',
'      into flow_connections',
'            (',
'              conn_dgrm_id',
'            , conn_bpmn_id',
'            , conn_name',
'            , conn_src_objt_id',
'            , conn_tgt_objt_id',
'            , conn_tag_name',
'            , conn_origin',
'            , conn_is_default',
'            )',
'    values (',
'              g_dgrm_id',
'            , pi_conn_bpmn_id',
'            , pi_conn_name',
'            , pi_conn_src_objt_id',
'            , pi_conn_tgt_objt_id',
'            , pi_conn_tag_name',
'            , pi_conn_origin',
'            , l_conn_is_default ',
'            )',
'      returning conn_id into po_conn_id',
'    ;',
'  end insert_connection;',
'',
'  procedure process_object_attributes',
'  (',
'    pi_objt_id       in flow_object_attributes.obat_objt_id%type',
'  , pi_objt_bpmn_id  in flow_types_pkg.t_bpmn_id',
'  )',
'  as',
'    l_obat_tab      t_obat_tab;',
'    l_obat_rec      t_obat_rec;',
'    l_obat_exists   boolean;',
'    l_cur_obat_idx  pls_integer;',
'    l_next_obat_idx pls_integer;',
'  begin',
'',
'    -- check, if there are attributes for the object',
'    begin',
'      l_obat_tab := g_obj_attribs(pi_objt_bpmn_id).obat_tab;',
'      l_obat_exists := true;',
'    exception',
'      when no_data_found then',
'        l_obat_exists := false;',
'    end;',
'',
'    if l_obat_exists then',
'      l_cur_obat_idx := l_obat_tab.first;',
'      while l_cur_obat_idx is not null',
'      loop',
'        l_obat_rec := l_obat_tab( l_cur_obat_idx );',
'',
'        insert_object_attributes',
'        (',
'          pi_objt_id         => pi_objt_id',
'        , pi_obat_key        => l_obat_rec.obat_key',
'        , pi_obat_num_value  => l_obat_rec.obat_num_value',
'        , pi_obat_date_value => l_obat_rec.obat_date_value',
'        , pi_obat_vc_value   => l_obat_rec.obat_vc_value',
'        , pi_obat_clob_value => l_obat_rec.obat_clob_value',
'        );',
'',
'        l_next_obat_idx := l_obat_tab.next( l_cur_obat_idx );',
'        l_cur_obat_idx := l_next_obat_idx;',
'      end loop;',
'    end if;',
'',
'  end process_object_attributes;',
'',
'  procedure process_object_expressions',
'  (',
'    pi_objt_id       in flow_object_expressions.expr_objt_id%type',
'  , pi_objt_bpmn_id  in flow_types_pkg.t_bpmn_id    ',
'  )',
'  as',
'    l_cur_expressions t_expr_tab;',
'    l_cur_index       pls_integer;',
'  begin',
'    if g_objt_expr.exists(pi_objt_bpmn_id) then',
'      l_cur_index       := g_objt_expr(pi_objt_bpmn_id).first;',
'      while l_cur_index is not null loop',
'        insert_object_expression',
'        (',
'          pi_expr_objt_id    => pi_objt_id',
'        , pi_expr_set        => g_objt_expr(pi_objt_bpmn_id)(l_cur_index).expr_set',
'        , pi_expr_order      => g_objt_expr(pi_objt_bpmn_id)(l_cur_index).expr_order',
'        , pi_expr_var_name   => g_objt_expr(pi_objt_bpmn_id)(l_cur_index).expr_var_name',
'        , pi_expr_var_type   => g_objt_expr(pi_objt_bpmn_id)(l_cur_index).expr_var_type',
'        , pi_expr_type       => g_objt_expr(pi_objt_bpmn_id)(l_cur_index).expr_type',
'        , pi_expr_expression => g_objt_expr(pi_objt_bpmn_id)(l_cur_index).expr_expression',
'        );',
'        l_cur_index := g_objt_expr(pi_objt_bpmn_id).next(l_cur_index);',
'      end loop;',
'    end if;',
'  end process_object_expressions;',
'',
'  procedure process_objects',
'  as',
'    l_cur_objt_bpmn_id  flow_types_pkg.t_bpmn_id;',
'    l_next_objt_bpmn_id flow_types_pkg.t_bpmn_id;',
'    l_cur_object        t_objt_rec;',
'    l_objt_id           flow_objects.objt_id%type;',
'    l_parent_check      boolean;',
'    l_lane_check        boolean;',
'  begin',
'',
'    l_cur_objt_bpmn_id := g_objects.first;',
'    while l_cur_objt_bpmn_id is not null',
'    loop',
'      -- reset object id, we get it if insert done',
'      l_objt_id      := null;',
'      l_cur_object   := g_objects( l_cur_objt_bpmn_id );',
'',
'      -- check possible parent and lane',
'      -- either not set or ID already known',
'      l_parent_check :=',
'           l_cur_object.objt_parent_bpmn_id is null',
'        or (   l_cur_object.objt_parent_bpmn_id is not null',
'           and g_objt_lookup.exists( l_cur_object.objt_parent_bpmn_id )',
'           )',
'      ;',
'      l_lane_check :=',
'           not g_lane_refs.exists( l_cur_objt_bpmn_id )',
'        or ( g_lane_refs.exists( l_cur_objt_bpmn_id )',
'           and g_objt_lookup.exists( g_lane_refs( l_cur_objt_bpmn_id ) )',
'           )',
'      ;',
'',
'      -- checks passed insert into table',
'      if l_parent_check and l_lane_check then',
'',
'        insert_object',
'        (',
'          pi_objt_bpmn_id      => l_cur_objt_bpmn_id',
'        , pi_objt_name         => l_cur_object.objt_name',
'        , pi_objt_tag_name     => l_cur_object.objt_tag_name',
'        , pi_objt_objt_id      => case when l_cur_object.objt_parent_bpmn_id is not null then g_objt_lookup( l_cur_object.objt_parent_bpmn_id ) else null end',
'        , pi_objt_objt_lane_id => case when g_lane_refs.exists( l_cur_objt_bpmn_id ) then g_objt_lookup( g_lane_refs( l_cur_objt_bpmn_id ) ) else null end',
'        , pi_objt_sub_tag_name => l_cur_object.objt_sub_tag_name',
'        , pi_objt_attached_to  => l_cur_object.objt_attached_to',
'        , pi_objt_interrupting => l_cur_object.objt_interrupting',
'        , po_objt_id           => l_objt_id',
'        );',
'',
'        process_object_attributes',
'        (',
'          pi_objt_id           => l_objt_id',
'        , pi_objt_bpmn_id      => l_cur_objt_bpmn_id',
'        );',
'',
'        process_object_expressions',
'        (',
'          pi_objt_id      => l_objt_id',
'        , pi_objt_bpmn_id => l_cur_objt_bpmn_id',
'        );',
'',
'      -- checks not passed skip record for now',
'      else',
'        null;',
'      end if;',
'',
'      -- Get next ID for lookup and if object was processed',
'      -- put it into lookup and remove from things to process',
'      l_next_objt_bpmn_id := g_objects.next( l_cur_objt_bpmn_id );',
'      if l_objt_id is not null then',
'',
'        g_objt_lookup( l_cur_objt_bpmn_id ) := l_objt_id;',
'        g_objects.delete( l_cur_objt_bpmn_id );',
'',
'      end if;',
'',
'      l_cur_objt_bpmn_id := l_next_objt_bpmn_id;',
'    end loop;',
'',
'    -- restart with remaining set if still objects to process',
'    if g_objects.count > 0 then',
'      process_objects;',
'    end if;',
'  end process_objects;',
'',
'  procedure process_connections',
'  as',
'    l_cur_conn_bpmn_id flow_types_pkg.t_bpmn_id;',
'    l_cur_conn         t_conn_rec;',
'    l_conn_id          flow_connections.conn_id%type;',
'  begin',
'',
'    l_cur_conn_bpmn_id := g_connections.first;',
'    while l_cur_conn_bpmn_id is not null',
'    loop',
'      l_conn_id  := null;',
'      l_cur_conn := g_connections( l_cur_conn_bpmn_id );',
'',
'      -- verify if we know the IDs for source and target connection if set',
'      -- anything strange stop all processing and raise error',
'      if (  ( l_cur_conn.conn_src_bpmn_id is not null and not g_objt_lookup.exists( l_cur_conn.conn_src_bpmn_id ) )',
'         or ( l_cur_conn.conn_tgt_bpmn_id is not null and not g_objt_lookup.exists( l_cur_conn.conn_tgt_bpmn_id ) )',
'         )',
'      then',
'        raise_application_error(-20000, ''Connection Source or Target not found!'');',
'      else',
'        insert_connection',
'        (',
'          pi_conn_bpmn_id      => l_cur_conn_bpmn_id',
'        , pi_conn_name         => l_cur_conn.conn_name',
'        , pi_conn_src_objt_id  => case when l_cur_conn.conn_src_bpmn_id is not null then g_objt_lookup( l_cur_conn.conn_src_bpmn_id ) else null end',
'        , pi_conn_tgt_objt_id  => case when l_cur_conn.conn_tgt_bpmn_id is not null then g_objt_lookup( l_cur_conn.conn_tgt_bpmn_id ) else null end',
'        , pi_conn_tag_name     => l_cur_conn.conn_tag_name',
'        , pi_conn_origin       => l_cur_conn.conn_origin',
'        , po_conn_id           => l_conn_id',
'        );',
'      end if;',
'',
'      l_cur_conn_bpmn_id := g_connections.next( l_cur_conn_bpmn_id );',
'    end loop;',
'',
'  end process_connections;',
'',
'  procedure finalize',
'  as',
'  begin',
'',
'    process_objects;',
'    process_connections;',
'',
'  end finalize;',
'',
'  function upload_diagram',
'  (',
'    pi_dgrm_name     in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version  in flow_diagrams.dgrm_version%type',
'  , pi_dgrm_category in flow_diagrams.dgrm_category%type',
'  , pi_dgrm_content  in flow_diagrams.dgrm_content%type',
'  , pi_dgrm_status   in flow_diagrams.dgrm_status%type default flow_constants_pkg.gc_dgrm_status_draft',
'  , pi_force_overwrite in boolean default false',
'  )',
'    return flow_diagrams.dgrm_id%type',
'  as',
'    l_cnt     number;',
'    l_dgrm_id flow_diagrams.dgrm_id%type;',
'  begin',
'',
'    begin',
'      select dgrm_id',
'        into l_dgrm_id',
'        from flow_diagrams',
'       where dgrm_name = pi_dgrm_name',
'         and dgrm_version = pi_dgrm_version',
'      ;',
'    exception',
'      when no_data_found then',
'        l_dgrm_id := null;',
'    end;',
'',
'    if l_dgrm_id is null then',
'      insert',
'        into flow_diagrams ( dgrm_name, dgrm_version, dgrm_category, dgrm_status, dgrm_last_update, dgrm_content )',
'        values ( pi_dgrm_name, pi_dgrm_version, pi_dgrm_category, ',
'                 pi_dgrm_status,  systimestamp, pi_dgrm_content )',
'      returning dgrm_id into l_dgrm_id',
'      ;',
'    else',
'      if (pi_force_overwrite) then',
'        update flow_diagrams',
'          set dgrm_content = pi_dgrm_content',
'            , dgrm_last_update = systimestamp',
'            , dgrm_status  = pi_dgrm_status',
'        where dgrm_id = l_dgrm_id',
'        ;',
'      end if;',
'    end if;',
'',
'    return l_dgrm_id;',
'',
'  end upload_diagram;',
'',
'  procedure upload_diagram',
'  (',
'    pi_dgrm_name     in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version  in flow_diagrams.dgrm_version%type',
'  , pi_dgrm_category in flow_diagrams.dgrm_category%type',
'  , pi_dgrm_content  in flow_diagrams.dgrm_content%type',
'  , pi_dgrm_status   in flow_diagrams.dgrm_status%type default flow_constants_pkg.gc_dgrm_status_draft',
'  , pi_force_overwrite in boolean default false',
'  )',
'  as',
'  begin',
'    g_dgrm_id := upload_diagram( pi_dgrm_name => pi_dgrm_name, pi_dgrm_version => pi_dgrm_version,',
'                                 pi_dgrm_category => pi_dgrm_category, pi_dgrm_content => pi_dgrm_content,',
'                                 pi_dgrm_status => pi_dgrm_status, pi_force_overwrite => pi_force_overwrite',
'                                  );',
'  end upload_diagram;',
'',
'  procedure cleanup_parsing_tables',
'  as',
'  begin',
'    delete',
'      from flow_connections conn',
'     where conn.conn_dgrm_id = g_dgrm_id',
'    ;',
'',
'    delete',
'      from flow_objects objt',
'     where objt.objt_dgrm_id = g_dgrm_id',
'    ;',
'  end cleanup_parsing_tables;',
'',
'  procedure parse_lanes',
'  (',
'    pi_laneset_xml  in xmltype',
'  , pi_objt_bpmn_id in flow_types_pkg.t_bpmn_id',
'  )',
'  as',
'  begin',
'    for lane_rec in (',
'      select lanes.lane_id',
'           , lanes.lane_name',
'           , lanes.lane_type',
'           , lanes.child_elements',
'        from xmltable',
'             (',
'               xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'             , ''*'' passing pi_laneset_xml',
'               columns',
'                 lane_id   varchar2(50 char) path ''@id''',
'               , lane_name varchar2(50 char) path ''@name''',
'               , lane_type varchar2(50 char) path ''name()''',
'               , child_elements xmltype path ''*''',
'             ) lanes',
'    ) loop',
'',
'      register_object',
'      (',
'        pi_objt_bpmn_id        => lane_rec.lane_id',
'      , pi_objt_name           => lane_rec.lane_name',
'      , pi_objt_tag_name       => lane_rec.lane_type',
'      , pi_objt_parent_bpmn_id => pi_objt_bpmn_id',
'      );',
'',
'      for node_rec in (',
'        select nodes.node_ref',
'          from xmltable',
'             (',
'               xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'             , ''*'' passing lane_rec.child_elements',
'               columns',
'                 node_ref   varchar2(50 char) path ''text()''',
'             ) nodes',
'      ) loop',
'        g_lane_refs( node_rec.node_ref ) := lane_rec.lane_id;',
'      end loop;',
'',
'    end loop;',
'',
'  end parse_lanes;',
'',
'  function find_subtag_name',
'  (',
'    pi_xml in xmltype',
'  )',
'    return flow_types_pkg.t_bpmn_id',
'  as',
'    c_nsmap        constant t_vc200 := flow_constants_pkg.gc_nsmap;',
'    l_return                flow_types_pkg.t_bpmn_id;',
'  begin',
'',
'    if pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_bpmn_terminate_event_definition, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_bpmn_terminate_event_definition;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_bpmn_timer_event_definition, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_bpmn_timer_event_definition;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_timer_type_date, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_timer_type_date;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_timer_type_duration, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_timer_type_duration;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_timer_type_cycle, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_timer_type_cycle;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_bpmn_error_event_definition, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_bpmn_error_event_definition;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_bpmn_escalation_event_definition, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_bpmn_escalation_event_definition;',
'    elsif pi_xml.existsNode( xpath => ''/'' || flow_constants_pkg.gc_bpmn_link_event_definition, nsmap => c_nsmap ) = 1 then',
'      l_return := flow_constants_pkg.gc_bpmn_link_event_definition;    ',
'    end if;',
'',
'    return l_return;',
'  end find_subtag_name;',
'',
'  procedure parse_child_elements',
'  (',
'    pi_objt_bpmn_id in flow_types_pkg.t_bpmn_id',
'  , pi_xml          in xmltype',
'  )',
'  as',
'    l_child_type         flow_types_pkg.t_bpmn_id;',
'    l_child_id           flow_types_pkg.t_bpmn_id;',
'    l_child_value        flow_object_attributes.obat_vc_value%type;',
'    l_child_details      xmltype;',
'    l_detail_type        flow_types_pkg.t_bpmn_id;',
'    l_detail_id          flow_types_pkg.t_bpmn_id;',
'    l_detail_value       flow_object_attributes.obat_vc_value%type;',
'  begin',
'',
'    for rec in (',
'                select children.child_type',
'                     , children.child_id',
'                     , children.child_value',
'                     , children.child_details',
'                  from xmltable',
'                       (',
'                         xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn"',
'                                      , ''http://www.apex.mt-ag.com'' as "apex")',
'                       , ''*'' passing pi_xml',
'                         columns',
'                           child_type     varchar2(50 char)    path ''name()''',
'                         , child_id       varchar2(50 char)    path ''@id''',
'                         , child_value    varchar2(4000 char)  path ''text()''',
'                         , child_details  xmltype              path ''* except bpmn:incoming except bpmn:outgoing''',
'                       ) children',
'               )',
'    loop',
'',
'      if rec.child_details is null then',
'        -- register the child which does not have details',
'        if rec.child_value is not null then',
'          -- if needed distinguish here between different attributes',
'          register_object_attributes',
'          (',
'            pi_objt_bpmn_id      => pi_objt_bpmn_id',
'          , pi_obat_key          => rec.child_type',
'          , pi_obat_vc_value     => rec.child_value',
'        );',
'        end if;',
'      else',
'        -- register the child which has details',
'        if rec.child_type = flow_constants_pkg.gc_bpmn_timer_event_definition then',
'    	  begin',
'    	    select details.detail_type',
'    			 , details.detail_id',
'    			 , details.detail_value',
'              into l_detail_type',
'                 , l_detail_id',
'                 , l_detail_value',
'              from xmltable',
'                   (',
'                     xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'                   , ''*'' passing rec.child_details',
'                     columns',
'                       detail_type   varchar2(50 char)    path ''name()''',
'                     , detail_id     varchar2(50 char)    path ''@id''',
'                     , detail_value  varchar2(4000 char)  path ''text()''',
'                   ) details;',
'          end;',
'',
'          -- register the timer type',
'          register_object_attributes',
'          (',
'            pi_objt_bpmn_id      => pi_objt_bpmn_id',
'          , pi_objt_sub_tag_name => rec.child_type',
'          , pi_obat_key          => flow_constants_pkg.gc_timer_type_key',
'          , pi_obat_vc_value     => l_detail_type',
'          );',
'		',
'          -- register the timer definition',
'          register_object_attributes',
'          (',
'            pi_objt_bpmn_id      => pi_objt_bpmn_id',
'          , pi_objt_sub_tag_name => rec.child_type',
'          , pi_obat_key          => flow_constants_pkg.gc_timer_def_key',
'          , pi_obat_vc_value     => l_detail_value',
'          );',
'		',
'        elsif rec.child_type = flow_constants_pkg.gc_bpmn_terminate_event_definition then',
'          select details.detail_type',
'               , details.detail_value',
'            into l_detail_type',
'               , l_detail_value',
'            from xmltable',
'                 (',
'                   xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'                 , ''*'' passing rec.child_details',
'                   columns',
'                     detail_type  varchar2(50 char) path   ''name()''',
'                   , detail_value varchar2(4000 char) path ''text()''',
'                 ) details',
'          ;',
'          if l_detail_type = flow_constants_pkg.gc_apex_process_status then',
'            register_object_attributes',
'            (',
'              pi_objt_bpmn_id      => pi_objt_bpmn_id',
'            , pi_objt_sub_tag_name => rec.child_type',
'            , pi_obat_key          => flow_constants_pkg.gc_terminate_result',
'            , pi_obat_vc_value     => l_detail_value',
'            );',
'          end if;',
'	    end if;',
'',
'      end if;',
'',
'    end loop;',
'',
'  end parse_child_elements;',
'',
'  procedure parse_extension_elements',
'  (',
'    pi_bpmn_id       in flow_types_pkg.t_bpmn_id',
'  , pi_extension_xml in xmltype',
'  )',
'  as',
'  begin',
'    for rec in (',
'                select replace(xtab1.run_scope, ''apex:'') as run_scope',
'                     , xtab2.variable_sequence',
'                     , xtab2.variable_name',
'                     , xtab2.variable_type',
'                     , xtab2.expression_type',
'                     , xtab2.expression_value',
'                     , xtab1.procvars',
'                  from xmltable',
'                       (',
'                         xmlnamespaces ( ''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn", ''http://www.apex.mt-ag.com'' as "apex" )',
'                       , ''/bpmn:extensionElements/*'' passing pi_extension_xml',
'                         columns',
'                           run_scope varchar2(20 char) path ''name()''',
'                         , procvars  xmltype           path ''apex:processVariable''',
'                       ) xtab1',
'                     , xmltable',
'                       (',
'                         xmlnamespaces ( ''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn", ''http://www.apex.mt-ag.com'' as "apex" )',
'                       , ''*'' passing xtab1.procvars',
'                         columns',
'                           variable_sequence number              path ''apex:varSequence''',
'                         , variable_name     varchar2(50 char)   path ''apex:varName''',
'                         , variable_type     varchar2(50 char)   path ''apex:varDataType''',
'                         , expression_type   varchar2(200 char)  path ''apex:varExpressionType''',
'                         , expression_value  varchar2(4000 char) path ''apex:varExpression''',
'                       ) xtab2',
'               )',
'    loop',
'      -- only pick things for variable expressions for now',
'      if rec.run_scope in ( flow_constants_pkg.gc_expr_set_before_task, flow_constants_pkg.gc_expr_set_after_task',
'                          , flow_constants_pkg.gc_expr_set_before_split, flow_constants_pkg.gc_expr_set_after_merge',
'                          , flow_constants_pkg.gc_expr_set_before_event, flow_constants_pkg.gc_expr_set_on_event',
'                          )',
'      then',
'        register_object_expression',
'        (',
'          pi_objt_bpmn_id    => pi_bpmn_id',
'        , pi_expr_set        => rec.run_scope',
'        , pi_expr_order      => rec.variable_sequence',
'        , pi_expr_var_name   => rec.variable_name',
'        , pi_expr_var_type   => rec.variable_type',
'        , pi_expr_type       => rec.expression_type',
'        , pi_expr_expression => rec.expression_value',
'        );',
'      end if;',
'    end loop;',
'  end parse_extension_elements;',
'',
'  procedure parse_steps',
'  (',
'    pi_xml          in xmltype',
'  , pi_proc_type    in flow_types_pkg.t_bpmn_id',
'  , pi_proc_bpmn_id in flow_types_pkg.t_bpmn_id',
'  )',
'  as',
'    l_objt_sub_tag_name flow_objects.objt_sub_tag_name%type;',
'  begin',
'    for rec in (',
'                select steps.steps_type',
'                     , steps.steps_name',
'                     , steps.steps_id',
'                     , steps.source_ref',
'                     , steps.target_ref',
'                     , steps.default_conn',
'                     , steps.attached_to',
'                     , case steps.interrupting when ''false'' then 0 else 1 end as interrupting',
'                     , steps.child_elements',
'                     , steps.extension_elements',
'                  from xmltable',
'                       (',
'                         xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'                       , ''*'' passing pi_xml',
'                         columns',
'                           steps_type         varchar2(50 char)  path ''name()''',
'                         , steps_name         varchar2(200 char) path ''@name''',
'                         , steps_id           varchar2(50 char)  path ''@id''',
'                         , source_ref         varchar2(50 char)  path ''@sourceRef''',
'                         , target_ref         varchar2(50 char)  path ''@targetRef''',
'                         , default_conn       varchar2(50 char)  path ''@default''',
'                         , attached_to        varchar2(50 char)  path ''@attachedToRef''',
'                         , interrupting       varchar2(50 char)  path ''@cancelActivity''',
'                         , child_elements     xmltype            '))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'path ''* except bpmn:incoming except bpmn:outgoing except bpmn:extensionElements''',
'                         , extension_elements xmltype            path ''bpmn:extensionElements''',
'                       ) steps',
'               )',
'    loop',
'',
'      if rec.source_ref is null then -- assume objects don''t have a sourceRef attribute',
'',
'',
'        -- Parse additional information from child elements',
'        -- relevant for e.g. terminateEndEvent',
'        -- Additionally collect generic attributes if possible',
'        if rec.child_elements is not null then',
'          l_objt_sub_tag_name := find_subtag_name( pi_xml => rec.child_elements );',
'          parse_child_elements',
'          (',
'            pi_objt_bpmn_id => rec.steps_id',
'          , pi_xml          => rec.child_elements',
'          );',
'        else',
'          l_objt_sub_tag_name := null;',
'        end if;',
'',
'        if rec.extension_elements is not null then',
'          parse_extension_elements',
'          ( ',
'            pi_bpmn_id       => rec.steps_id',
'          , pi_extension_xml => rec.extension_elements',
'          );',
'        end if;',
'',
'        if rec.default_conn is not null then',
'          g_default_cons(rec.default_conn) := 1;',
'        end if;',
'',
'        register_object',
'        (',
'          pi_objt_bpmn_id        => rec.steps_id',
'        , pi_objt_name           => rec.steps_name',
'        , pi_objt_tag_name       => rec.steps_type',
'        , pi_objt_sub_tag_name   => l_objt_sub_tag_name',
'        , pi_objt_parent_bpmn_id => pi_proc_bpmn_id',
'        , pi_objt_attached_to    => rec.attached_to',
'        , pi_objt_interrupting   => rec.interrupting',
'        );',
'',
'        -- Register Object on Lane if parent belongs to a lane',
'        -- Those connections are not directly visible in the XML',
'        -- but BPMN defines inheritance for these.',
'        if g_lane_refs.exists( pi_proc_bpmn_id ) and rec.steps_id is not null then',
'          g_lane_refs( rec.steps_id ) := g_lane_refs( pi_proc_bpmn_id );',
'        end if;',
'',
'        if rec.steps_type = ''bpmn:laneSet'' then',
'          parse_lanes',
'          (',
'            pi_laneset_xml  => rec.child_elements',
'          , pi_objt_bpmn_id => rec.steps_id',
'          );',
'        end if;',
'      else',
'        register_connection',
'        (',
'          pi_conn_bpmn_id     => rec.steps_id',
'        , pi_conn_name        => rec.steps_name',
'        , pi_conn_src_bpmn_id => rec.source_ref',
'        , pi_conn_tgt_bpmn_id => rec.target_ref',
'        , pi_conn_tag_name    => rec.steps_type',
'        , pi_conn_origin      => pi_proc_bpmn_id',
'        );        ',
'      end if;',
'    end loop;  ',
'  end parse_steps;',
'',
'  procedure parse_xml',
'  (',
'    pi_xml       in xmltype',
'  , pi_parent_id in flow_types_pkg.t_bpmn_id',
'  )',
'  as',
'  begin',
'    if pi_parent_id is null then',
'      for rec in (',
'                 select proc.proc_id',
'                      , case proc.proc_type when ''bpmn:subProcess'' then ''SUB_PROCESS'' else ''PROCESS'' end as proc_type_rem',
'                      , proc.proc_type',
'                      , proc.proc_steps',
'                      , proc.proc_sub_procs',
'                      , proc.proc_name',
'                      , proc.proc_laneset',
'                   from xmltable',
'                      (',
'                        xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'                      , ''/bpmn:definitions/bpmn:process'' passing pi_xml',
'                        columns',
'                          proc_id        varchar2(50 char) path ''@id''',
'                        , proc_type      varchar2(50 char) path ''name()''',
'                        , proc_name      varchar2(50 char) path ''@name''',
'                        , proc_steps     xmltype           path ''* except bpmn:subProcess''',
'                        , proc_sub_procs xmltype           path ''bpmn:subProcess''',
'                        , proc_laneset   xmltype           path ''bpmn:laneSet''',
'                      ) proc',
'                 )',
'      loop',
'',
'        -- register each process as an object so we can reference later',
'        register_object',
'        (',
'          pi_objt_bpmn_id        => rec.proc_id',
'        , pi_objt_tag_name       => rec.proc_type',
'        , pi_objt_name           => rec.proc_name',
'        , pi_objt_parent_bpmn_id => pi_parent_id',
'        );',
'',
'        -- parse immediate steps        ',
'        parse_steps',
'        ( ',
'          pi_xml          => rec.proc_steps',
'        , pi_proc_type    => rec.proc_type_rem',
'        , pi_proc_bpmn_id => rec.proc_id',
'        );',
'',
'        -- recurse if sub processes found',
'        if rec.proc_sub_procs is not null then',
'',
'          parse_xml',
'          ( ',
'            pi_xml => rec.proc_sub_procs',
'          , pi_parent_id => rec.proc_id',
'          );',
'',
'        end if;',
'',
'      end loop;',
'    else',
'      for rec in (',
'                 select proc.proc_id',
'                      , case proc.proc_type when ''bpmn:subProcess'' then ''SUB_PROCESS'' else ''PROCESS'' end as proc_type_rem',
'                      , proc.proc_type',
'                      , proc.proc_steps',
'                      , proc.proc_sub_procs',
'                      , proc.proc_name',
'                   from xmltable',
'                      (',
'                        xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'                      , ''bpmn:subProcess'' passing pi_xml',
'                        columns',
'                          proc_id        varchar2(50 char) path ''@id''',
'                        , proc_name      varchar2(50 char) path ''@name''',
'                        , proc_type      varchar2(50 char) path ''name()''',
'                        , proc_steps     xmltype           path ''* except bpmn:subProcess''',
'                        , proc_sub_procs xmltype           path ''bpmn:subProcess''',
'                      ) proc',
'                 )',
'      loop',
'        -- We add an entry for a sub process here,',
'        -- as it is an object within the master process',
'        register_object',
'        (',
'          pi_objt_bpmn_id        => rec.proc_id',
'        , pi_objt_tag_name       => rec.proc_type',
'        , pi_objt_name           => rec.proc_name',
'        , pi_objt_parent_bpmn_id => pi_parent_id',
'        );',
'',
'        -- Register Object on Lane if parent belongs to a lane',
'        -- Those connections are not directly visible in the XML',
'        -- but BPMN defines inheritance for these.',
'        if g_lane_refs.exists( pi_parent_id ) and rec.proc_id is not null then',
'          g_lane_refs( rec.proc_id ) := g_lane_refs( pi_parent_id );',
'        end if;',
'',
'        -- parse any immediate steps',
'        parse_steps',
'        ( ',
'          pi_xml          => rec.proc_steps',
'        , pi_proc_type    => rec.proc_type_rem',
'        , pi_proc_bpmn_id => rec.proc_id',
'        );',
'',
'        -- recurse if we found any sub process',
'        if rec.proc_sub_procs is not null then',
'          parse_xml',
'          (',
'            pi_xml       => rec.proc_sub_procs',
'          , pi_parent_id => rec.proc_id',
'          );',
'        end if;        ',
'      end loop;',
'    end if;',
'  end parse_xml;',
'',
'  procedure parse_collaboration',
'  (',
'    pi_xml in xmltype',
'  )',
'  as',
'',
'  begin',
'    for rec in (',
'                 select colab_id',
'                      , colab_name',
'                      , colab_type',
'                      , colab_src_ref',
'                      , colab_tgt_ref',
'                   from xmltable',
'                        (',
'                          xmlnamespaces (''http://www.omg.org/spec/BPMN/20100524/MODEL'' as "bpmn")',
'                        , ''/bpmn:definitions/bpmn:collaboration/*'' passing pi_xml',
'                          columns',
'                            colab_id      varchar2(50 char)  path ''@id''',
'                          , colab_name    varchar2(200 char) path ''@name''',
'                          , colab_type    varchar2(50 char)  path ''name()''',
'                          , colab_src_ref varchar2(50 char)  path ''@sourceRef''',
'                          , colab_tgt_ref varchar2(50 char)  path ''@targetRef''',
'                        ) colab',
'    ) loop',
'',
'      case',
'        when rec.colab_src_ref is null then',
'          register_object',
'          (',
'            pi_objt_bpmn_id        => rec.colab_id',
'          , pi_objt_tag_name       => rec.colab_type',
'          , pi_objt_name           => rec.colab_name',
'          );',
'        else',
'          register_connection',
'          (',
'            pi_conn_bpmn_id     => rec.colab_id',
'          , pi_conn_name        => rec.colab_name',
'          , pi_conn_src_bpmn_id => rec.colab_src_ref',
'          , pi_conn_tgt_bpmn_id => rec.colab_tgt_ref',
'          , pi_conn_tag_name    => rec.colab_type',
'          , pi_conn_origin      => null',
'          );',
'',
'      end case;',
'',
'    end loop;',
'',
'  end parse_collaboration;',
'',
'  procedure reset',
'  as',
'  begin',
'    g_dgrm_id := null;',
'    g_objects.delete;',
'    g_obj_attribs.delete;',
'    g_objt_expr.delete;',
'    g_connections.delete;',
'    g_objt_lookup.delete;',
'  end reset;',
'',
'  procedure parse',
'  as',
'    l_dgrm_content clob;',
'  begin',
'    -- delete any existing parsed information before parsing again',
'    cleanup_parsing_tables;',
'',
'    -- get the CLOB content',
'    select dgrm_content',
'      into l_dgrm_content',
'      from flow_diagrams',
'     where dgrm_id = g_dgrm_id',
'    ;',
'',
'    -- parse out collaboration part first',
'    parse_collaboration( pi_xml => xmltype(l_dgrm_content) );',
'    -- start recursive processsing of xml',
'    parse_xml( pi_xml => xmltype(l_dgrm_content), pi_parent_id => null );',
'',
'    -- finally insert all parsed data',
'    finalize;',
'',
'  end parse;',
'',
'  procedure parse',
'  (',
'    pi_dgrm_id in flow_diagrams.dgrm_id%type',
'  )',
'  as',
'  begin',
'    reset;',
'    g_dgrm_id := pi_dgrm_id;',
'    parse;',
'  end parse;',
'',
'  procedure parse',
'  (',
'    pi_dgrm_name in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version  in flow_diagrams.dgrm_version%type',
'  )',
'  as',
'  begin',
'    reset;',
'    select dgrm_id',
'      into g_dgrm_id',
'      from flow_diagrams',
'     where dgrm_name = pi_dgrm_name',
'       and dgrm_version = pi_dgrm_version',
'    ;',
'    parse;',
'  end parse;',
'',
'  procedure upload_and_parse',
'  (',
'    pi_dgrm_name     in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version  in flow_diagrams.dgrm_version%type',
'  , pi_dgrm_category in flow_diagrams.dgrm_category%type',
'  , pi_dgrm_content  in flow_diagrams.dgrm_content%type',
'  , pi_dgrm_status   in flow_diagrams.dgrm_status%type default flow_constants_pkg.gc_dgrm_status_draft',
'  , pi_force_overwrite in boolean default false',
'  )',
'  as',
'  begin',
'    reset;',
'',
'    upload_diagram( pi_dgrm_name => pi_dgrm_name, pi_dgrm_version => pi_dgrm_version,',
'                    pi_dgrm_category => pi_dgrm_category, pi_dgrm_content => pi_dgrm_content,',
'                    pi_dgrm_status => pi_dgrm_status, pi_force_overwrite => pi_force_overwrite',
'                  );',
'    parse;',
'',
'  end upload_and_parse;',
'',
'  procedure update_diagram',
'  (',
'    pi_dgrm_id      in flow_diagrams.dgrm_id%type',
'  , pi_dgrm_content in flow_diagrams.dgrm_content%type',
'  )',
'  as',
'  begin',
'    reset;',
'    g_dgrm_id := pi_dgrm_id;',
'',
'    update flow_diagrams',
'       set dgrm_content = pi_dgrm_content',
'         , dgrm_last_update = systimestamp',
'     where dgrm_id = g_dgrm_id',
'    ;',
'',
'    parse;',
'  end update_diagram;',
'',
'end flow_bpmn_parser_pkg;',
'/ ',
'',
'create or replace package body flow_engine_util',
'as ',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'  function get_dgrm_id',
'  (',
'    p_prcs_id in flow_processes.prcs_id%type',
'  ) return flow_processes.prcs_dgrm_id%type',
'  as',
'    l_prcs_dgrm_id flow_processes.prcs_dgrm_id%type;',
'  begin',
'    ',
'    select prcs.prcs_dgrm_id',
'      into l_prcs_dgrm_id',
'      from flow_processes prcs',
'     where prcs.prcs_id = p_prcs_id',
'    ;',
'    ',
'    return l_prcs_dgrm_id;',
'    ',
'  end get_dgrm_id;',
'',
'  function get_config_value',
'  ( ',
'    p_config_key    in flow_configuration.cfig_key%type',
'  , p_default_value in flow_configuration.cfig_value%type',
'  ) return flow_configuration.cfig_value%type',
'  as  ',
'    l_config_value   flow_configuration.cfig_value%type;',
'  begin ',
'    select cfig.cfig_value',
'      into l_config_value',
'      from flow_configuration cfig',
'     where cfig.cfig_key = p_config_key',
'    ;',
'    return l_config_value;',
'  exception ',
'    when no_data_found then ',
'      return p_default_value;',
'  end get_config_value;',
'',
'  function check_subflow_exists',
'  ( ',
'    p_process_id in flow_processes.prcs_id%type',
'  , p_subflow_id in flow_subflows.sbfl_id%type',
'  ) return boolean',
'  is',
'    l_cnt number;',
'  begin',
'    select count(*)',
'      into l_cnt',
'      from flow_subflows sbfl',
'     where sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    return ( l_cnt = 1 );',
'  end check_subflow_exists;',
'',
'',
'function get_subprocess_parent_subflow',
'  ( p_process_id in flow_processes.prcs_id%type',
'  , p_subflow_id in flow_subflows.sbfl_id%type',
'  , p_current    in flow_objects.objt_bpmn_id%type -- an object in the subprocess',
'  ) return number',
'  is',
'    l_parent_subflow          flow_subflows.sbfl_id%type;',
'    l_parent_subproc_activity flow_objects.objt_bpmn_id%type;',
'    l_dgrm_id                 flow_diagrams.dgrm_id%type;',
'  begin',
'',
'    l_dgrm_id := flow_engine_util.get_dgrm_id( p_prcs_id => p_process_id );  ',
'',
'    -- get parent bpmn:subProcess object',
'    select par_objt.objt_bpmn_id',
'      into l_parent_subproc_activity',
'      from flow_objects objt',
'      join flow_objects par_objt',
'        on par_objt.objt_id = objt.objt_objt_id',
'     where objt.objt_bpmn_id = p_current',
'       and objt.objt_dgrm_id = l_dgrm_id',
'    ;',
'    -- try to get parent subflow',
'    begin',
'      select sbfl.sbfl_id',
'        into l_parent_subflow',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_current = l_parent_subproc_activity',
'         and sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_in_subprocess',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'    exception',
'      when no_data_found then',
'        -- no subflow found running the parent process ',
'        l_parent_subflow := null;',
'    end;',
'    return l_parent_subflow;',
'  end get_subprocess_parent_subflow;',
'',
'procedure get_number_of_connections ',
'    ( pi_dgrm_id                  in flow_diagrams.dgrm_id%type',
'    , pi_target_objt_id           in flow_connections.conn_tgt_objt_id%type',
'    , pi_conn_type                in flow_connections.conn_tag_name%type  ',
'    , po_num_forward_connections  out number',
'    , po_num_back_connections     out number',
'    )',
'  is ',
'  begin   ',
'    select count(*)',
'      into po_num_back_connections',
'      from flow_connections conn ',
'     where conn.conn_tgt_objt_id = pi_target_objt_id',
'       and conn.conn_tag_name = pi_conn_type',
'       and conn.conn_dgrm_id = pi_dgrm_id',
'    ;',
'    select count(*)',
'      into po_num_forward_connections',
'      from flow_connections conn ',
'     where conn.conn_src_objt_id = pi_target_objt_id',
'       and conn.conn_tag_name = pi_conn_type',
'       and conn.conn_dgrm_id = pi_dgrm_id',
'    ;',
'  end get_number_of_connections;',
'',
'  function get_subflow_info',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_lock_subflow  in boolean default false',
'  , p_lock_process  in boolean default false',
'  ) return flow_subflows%rowtype',
'  is ',
'    l_sbfl_rec          flow_subflows%rowtype;',
'    l_prcs_check_id     flow_processes.prcs_id%type;',
'  begin',
'    begin ',
'      if p_lock_process then',
'        begin',
'          select prcs.prcs_id',
'            into l_prcs_check_id',
'            from flow_processes prcs',
'          where prcs.prcs_id = p_process_id',
'          ;',
'        exception',
'          when no_data_found then',
'            apex_error.add_error',
'            ( p_message   =>  apex_string.format ',
'                              ( p_message => ''Application Error: Process ID %0 not found).''',
'                              , p0 =>  p_process_id',
'                              )',
'            , p_display_location => apex_error.c_on_error_page',
'            );',
'        end;',
'      end if;',
'      if p_lock_subflow then ',
'        select *',
'        into l_sbfl_rec',
'        from flow_subflows sbfl',
'        where sbfl.sbfl_prcs_id = p_process_id',
'        and sbfl.sbfl_id = p_subflow_id',
'        for update wait 2',
'        ;',
'      else ',
'        select *',
'        into l_sbfl_rec',
'        from flow_subflows sbfl',
'        where sbfl.sbfl_prcs_id = p_process_id',
'        and sbfl.sbfl_id = p_subflow_id',
'        ;',
'      end if;',
'    exception',
'      when no_data_found then',
'        -- check if subflow valid in process',
'        select sbfl.sbfl_prcs_id',
'          into l_prcs_check_id',
'          from flow_subflows sbfl',
'         where sbfl.sbfl_id = p_subflow_id',
'         ;',
'        if l_prcs_check_id != p_process_id then',
'            apex_error.add_error',
'            ( p_message => apex_string.format',
'                           ( p_message => ''Application Error: Subflow ID supplied ( %0 ) exists but is not child of Process ID Supplied ( %1 ).''',
'                           , p0 => p_subflow_id',
'                           , p1 => p_process_id',
'                           )',
'            , p_display_location => apex_error.c_on_error_page',
'            );',
'        end if;',
'      when lock_timeout then',
'        apex_error.add_error',
'        ( p_message => apex_string.format ',
'                       ( p_message => ''Unable to lock items as another user is modifying.  Try again later.  Process: %0 Subflow: %1''',
'                       , p0 => p_process_id',
'                       , p1 => p_subflow_id',
'                       )',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    end;',
'    return l_sbfl_rec;',
'  exception',
'    when no_data_found then',
'            apex_error.add_error',
'            ( p_message =>  apex_string.format',
'                            ( ''Subflow ID supplied ( %0 ) not found. Check for process events that changed process flow (timeouts, errors, escalations). ''',
'                            , p0 => p_subflow_id',
'                            )',
'            , p_display_location => apex_error.c_on_error_page',
'            );',
'  end get_subflow_info;',
'',
'  function subflow_start',
'    ( ',
'      p_process_id                in flow_processes.prcs_id%type',
'    , p_parent_subflow            in flow_subflows.sbfl_id%type',
'    , p_starting_object           in flow_objects.objt_bpmn_id%type',
'    , p_current_object            in flow_objects.objt_bpmn_id%type',
'    , p_route                     in flow_subflows.sbfl_route%type',
'    , p_last_completed            in flow_objects.objt_bpmn_id%type',
'    , p_status                    in flow_subflows.sbfl_status%type default flow_constants_pkg.gc_sbfl_status_running',
'    , p_parent_sbfl_proc_level    in flow_subflows.sbfl_process_level%type',
'    , p_new_proc_level            in boolean default false',
'    , p_dgrm_id                   in flow_diagrams.dgrm_id%type',
'    ) return flow_subflows.sbfl_id%type',
'  is ',
'    l_ret flow_subflows.sbfl_id%type;',
'  begin',
'    apex_debug.enter ',
'    ( ''subflow_start''',
'    , ''Process'', p_process_id',
'    , ''Parent Subflow'', p_parent_subflow ',
'    );',
'    insert',
'      into flow_subflows',
'         ( sbfl_prcs_id',
'         , sbfl_sbfl_id',
'         , sbfl_process_level',
'         , sbfl_starting_object',
'         , sbfl_route',
'         , sbfl_last_completed',
'         , sbfl_became_current',
'         , sbfl_current',
'         , sbfl_status',
'         , sbfl_last_update',
'         , sbfl_dgrm_id',
'         )',
'    values',
'         ( p_process_id',
'         , p_parent_subflow',
'         , p_parent_sbfl_proc_level',
'         , p_starting_object',
'         , p_route',
'         , p_last_completed',
'         , systimestamp',
'         , p_current_object',
'         , p_status',
'         , systimestamp',
'         , p_dgrm_id',
'         )',
'    returning sbfl_id into l_ret',
'    ;',
'    if p_new_proc_level then',
'        -- starting new subprocess.  Set sbfl_process_level to new sbfl_id',
'        update flow_subflows',
'           set sbfl_process_level = l_ret',
'         where sbfl_id = l_ret',
'        ;',
'    end if;',
'    apex_debug.info',
'    ( p_message => ''New Subflow started.  Process: %0 Subflow: %1''',
'    , p0        => p_process_id',
'    , p1        => l_ret ',
'    );',
'    return l_ret;',
'  end subflow_start;',
'',
'  procedure terminate_level',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_process_level in flow_subflows.sbfl_process_level%type',
'    )',
'  is',
'  begin',
'    apex_debug.enter',
'    ( ''terminate_level''',
'    , ''Process'',  p_process_id',
'    , ''Process Level'', p_process_level',
'    );',
'    --',
'    /*begin',
'      select sbfl.sbfl_process_level',
'        into l_process_level ',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'    exception',
'      when no_data_found ',
'      then',
'        return;',
'    end;*/',
'    -- find any running subprocesses with parent at this level',
'    begin',
'      for child_proc_levels in (',
'        select distinct child_sbfl.sbfl_process_level',
'          from flow_subflows parent_sbfl',
'          join flow_subflows child_sbfl',
'            on parent_sbfl.sbfl_current = child_sbfl.sbfl_starting_object',
'         where parent_sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_in_subprocess',
'           and parent_sbfl.sbfl_process_level = p_process_level',
'      )',
'      loop',
'        terminate_level',
'        ( p_process_id     => p_process_id',
'        , p_process_level  => child_proc_levels.sbfl_process_level);',
'      end loop;',
'    end;',
'    -- end all subflows in the level',
'    delete from flow_subflows',
'    where sbfl_process_level = p_process_level ',
'      and sbfl_prcs_id = p_process_id',
'      ;',
'    apex_debug.info ',
'    ( p_message => ''Process %0 : All subflows at process level %1 terminated''',
'    , p0 => p_process_id',
'    , p1 => p_process_level',
'    );',
'  end terminate_level;',
'',
'  procedure subflow_complete',
'    ( p_process_id        in flow_processes.prcs_id%type',
'    , p_subflow_id        in flow_subflows.sbfl_id%type',
'    )',
'  is',
'    l_remaining_subflows              number;',
'    l_remaining_siblings              number;',
'    l_current_object                  flow_subflows.sbfl_current%type;',
'    l_current_subflow_status          flow_subflows.sbfl_status%type;',
'    l_parent_subflow_id               flow_subflows.sbfl_sbfl_id%type;',
'    l_parent_subflow_status           flow_subflows.sbfl_status%type;',
'    l_parent_subflow_last_completed   flow_subflows.sbfl_last_completed%type;',
'    l_parent_subflow_current          flow_subflows.sbfl_current%type;',
'  begin',
'    apex_debug.enter',
'    ( ''subflow_complete''',
'    , ''Subflow'' , p_subflow_id ',
'    );',
'    select sbfl.sbfl_sbfl_id',
'         , sbfl.sbfl_current',
'         , sbfl.sbfl_status',
'      into l_parent_subflow_id',
'         , l_current_object',
'         , l_current_subflow_status',
'      from flow_subflows sbfl',
'     where sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_prcs_id = p_process_id',
'    ; ',
'    ',
'    if l_parent_subflow_id is not null then   ',
'      -- get parent subflow info',
'      select sbfl.sbfl_status',
'           , sbfl.sbfl_last_completed',
'           , sbfl.sbfl_current',
'        into l_parent_subflow_status',
'           , l_parent_subflow_last_completed',
'           , l_parent_subflow_current',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_id = l_parent_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'    end if;',
'    -- delete the subflow',
'    delete from flow_subflows',
'     where sbfl_id = p_subflow_id',
'       and sbfl_prcs_id = p_process_id',
'    ;',
'',
'    -- handle parallel flows with their own end events.  Last one completing needs to clear up the parent ''split'' sbfl.',
'    -- if subflow has parent with   ',
'    -- a)  status ''split''  (flow_constants_pkg.gc_sbfl_status_split)',
'    -- b)  no other children, AND',
'    -- c)  is not a merging gateway',
'    -- then we have an ophan parent process to clean up (all opening gateway paths have run to conclusion)',
'    -- need to call this recursively in case you have nested open parallel gateways',
'',
'    if l_parent_subflow_id is not null then   ',
'        ',
'      select count(*)',
'        into l_remaining_siblings',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_prcs_id = p_process_id',
'         and sbfl.sbfl_starting_object = l_parent_subflow_last_completed',
'      ;',
'      ',
'      if (   l_remaining_siblings = 0',
'         and l_parent_subflow_status =  flow_constants_pkg.gc_sbfl_status_split    ',
'         and l_current_subflow_status != flow_constants_pkg.gc_sbfl_status_waiting_gateway',
'         )',
'      then',
'        -- call subflow_complete again recursively in case it has orphan grandparent',
'        subflow_complete ( p_process_id => p_process_id',
'                         , p_subflow_id => l_parent_subflow_id',
'                         );',
'      end if;  ',
'    end if;',
'  end subflow_complete;',
'',
'  function lock_subflow',
'  ( p_subflow_id    in flow_subflows.sbfl_id%type',
'  ) return boolean',
'  is ',
'    l_sbfl_prcs_id   flow_subflows.sbfl_prcs_id%type;',
'  begin ',
'',
'    apex_debug.enter ',
'    ( ''lock_subflow''',
'    , ''Subflow'', p_subflow_id ',
'    );',
'',
'    select sbfl.sbfl_prcs_id',
'      into l_sbfl_prcs_id',
'      from flow_subflows sbfl',
'     where sbfl.sbfl_id = p_subflow_id',
'    for update wait 2',
'    ;',
'    return true;',
'  exception',
'    when no_data_found then',
'      return false;',
'    when lock_timeout then',
'/*      apex_error.add_error',
'      ( p_message => ''Unable to lock subflow ''||p_subflow_id||''.  Select for update timed out''',
'      , p_display_location => apex_error.c_on_error_page',
'      );*/',
'',
'',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id => l_sbfl_prcs_id',
'      , pi_sbfl_id => p_subflow_id',
'      , pi_message_key => ''timeout_locking_subflow''',
'      , p0 => p_subflow_id',
'      );',
'      -- $F4AMESSAGE ''timeout_locking_subflow'' || ''Unable to lock Subflow : %0.''',
'      return false;',
'  end lock_subflow;',
'',
'end flow_engine_util;',
'/',
'',
'create or replace package body flow_engine',
'as ',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'function flow_get_matching_link_object',
'( pi_dgrm_id     in flow_diagrams.dgrm_id%type ',
', pi_link_bpmn_id   in flow_objects.objt_name%type',
') return varchar2',
'is ',
'    l_matching_catch_event  flow_objects.objt_bpmn_id%type;',
'begin ',
'     select catch_objt.objt_bpmn_id',
'       into l_matching_catch_event',
'       from flow_objects catch_objt',
'       join flow_objects throw_objt',
'         on catch_objt.objt_name = throw_objt.objt_name',
'        and catch_objt.objt_dgrm_id = throw_objt.objt_dgrm_id',
'        and catch_objt.objt_objt_id = throw_objt.objt_objt_id',
'      where throw_objt.objt_dgrm_id = pi_dgrm_id',
'        and throw_objt.objt_bpmn_id = pi_link_bpmn_id',
'        and catch_objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_link_event_definition',
'        and throw_objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_link_event_definition',
'        and catch_objt.objt_tag_name = flow_constants_pkg.gc_bpmn_intermediate_catch_event        ',
'        and throw_objt.objt_tag_name = flow_constants_pkg.gc_bpmn_intermediate_throw_event   ',
'        ;',
'    return l_matching_catch_event;',
'exception',
'  when no_data_found then',
'      apex_error.add_error',
'      ( p_message => ''Unable to find matching link catch event named ''||pi_link_bpmn_id||'' .''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'   when too_many_rows then',
'      apex_error.add_error',
'      ( p_message => ''More than one matching link catch event named ''||pi_link_bpmn_id||'' .''',
'      , p_display_location => apex_error.c_on_error_page',
'      );   ',
'end flow_get_matching_link_object;',
'',
'procedure flow_process_link_event',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_sbfl_info     in flow_subflows%rowtype',
'  , p_step_info     in flow_types_pkg.flow_step_info',
'  )',
'is ',
'    l_next_objt      flow_objects.objt_bpmn_id%type;',
'begin ',
'    -- find matching link catching event and step to it',
'    l_next_objt := flow_get_matching_link_object ',
'      ( pi_dgrm_id => p_step_info.dgrm_id',
'      , pi_link_bpmn_id => p_step_info.target_objt_ref',
'      );',
'    -- update current step info before logging',
'    update flow_subflows sbfl',
'       set sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'         , sbfl.sbfl_last_update = systimestamp',
'         , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'     where sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- log throw event as complete',
'   flow_logging.log_step_completion   ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_completed_object => p_step_info.target_objt_ref',
'    );',
'    -- jump into matching catch event',
'    update flow_subflows sbfl',
'    set   sbfl.sbfl_current = l_next_objt',
'        , sbfl.sbfl_last_completed = p_step_info.target_objt_ref',
'        , sbfl.sbfl_became_current = systimestamp ',
'        , sbfl.sbfl_last_update = systimestamp',
'        , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'    where sbfl.sbfl_id = p_subflow_id',
'        and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    flow_complete_step',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );  ',
'end flow_process_link_event;',
'',
'',
'/*',
'============================================================================================',
'  B P M N   O B J E C T   P R O C E S S O R S ',
'============================================================================================',
'*/',
'',
'  procedure process_endEvent',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    )',
'  is',
'    l_sbfl_id_par           flow_subflows.sbfl_id%type;  ',
'    l_boundary_event        flow_objects.objt_bpmn_id%type;',
'    l_subproc_objt          flow_objects.objt_bpmn_id%type;',
'    l_exit_type             flow_objects.objt_sub_tag_name%type default null;',
'    l_remaining_subflows    number;',
'    l_process_end_status    flow_processes.prcs_status%type;',
'  begin',
'    apex_debug.enter ',
'    ( ''process_endEvent''',
'    , ''Process'', p_process_id',
'    , ''Subflow'', p_subflow_id',
'    );',
'    --next step can be either end of process or sub-process returning to its parent',
'    -- get parent'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
' subflow',
'    l_sbfl_id_par := flow_engine_util.get_subprocess_parent_subflow',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_subflow_id',
'      , p_current    => p_sbfl_info.sbfl_current',
'      );',
'    -- update the subflow before logging',
'     update flow_subflows sbfl',
'        set sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'          , sbfl.sbfl_current = p_step_info.target_objt_ref',
'          , sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_completed  ',
'          , sbfl.sbfl_last_update = systimestamp ',
'      where sbfl.sbfl_id = p_subflow_id',
'        and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- log the current endEvent as completed',
'    flow_logging.log_step_completion',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_subflow_id',
'      , p_completed_object => p_step_info.target_objt_ref',
'      );  ',
'    -- process any variable expressions in the onEvent set',
'    flow_expressions.process_expressions',
'    ( pi_objt_id     => p_step_info.target_objt_id',
'    , pi_set         => flow_constants_pkg.gc_expr_set_on_event',
'    , pi_prcs_id     => p_process_id',
'    , pi_sbfl_id     => p_subflow_id',
'    );',
'',
'    if p_sbfl_info.sbfl_process_level = 0 then   ',
'      -- in a top level process',
'      apex_debug.info ',
'      ( p_message => ''Next Step is Process End %0''',
'      , p0        => p_step_info.target_objt_ref ',
'      );',
'      -- check for Terminate sub-Event',
'      if p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_terminate_event_definition then',
'        -- get desired process status after termination from model',
'        begin',
'          select coalesce(obat.obat_vc_value, flow_constants_pkg.gc_prcs_status_completed)',
'            into l_process_end_status',
'            from flow_object_attributes obat',
'          where obat.obat_objt_id = p_step_info.target_objt_id',
'            and obat.obat_key = flow_constants_pkg.gc_terminate_result',
'          ;',
'        exception',
'          when no_data_found then',
'            l_process_end_status := flow_constants_pkg.gc_prcs_status_completed;',
'        end;',
'        -- terminate the main level',
'        flow_engine_util.terminate_level',
'        ( ',
'          p_process_id     => p_process_id',
'        , p_process_level  => p_sbfl_info.sbfl_process_level',
'        );',
'      elsif p_step_info.target_objt_subtag is null then',
'        flow_engine_util.subflow_complete',
'        ( p_process_id => p_process_id',
'        , p_subflow_id => p_subflow_id',
'        );',
'        l_process_end_status := flow_constants_pkg.gc_prcs_status_completed;',
'      end if;',
'      -- check if there are ANY remaining subflows.  If not, close process',
'      select count(*)',
'        into l_remaining_subflows',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_prcs_id = p_process_id;',
'      ',
'      if l_remaining_subflows = 0 then ',
'        -- No remaining subflows so process has completed',
'        update flow_processes prcs ',
'           set prcs.prcs_status = l_process_end_status',
'             , prcs.prcs_last_update = systimestamp',
'         where prcs.prcs_id = p_process_id',
'        ;',
'        -- log the completion',
'        flow_logging.log_instance_event',
'        ( p_process_id => p_process_id',
'        , p_event      => l_process_end_status',
'        );',
'        apex_debug.info ',
'        ( p_message => ''Process Completed with %1 Status: Process %0  ''',
'        , p0        => p_process_id',
'        , p1        => l_process_end_status',
'        );',
'      end if;',
'    else  ',
'      -- in a sub-process',
'      apex_debug.info',
'      ( p_message => ''Next Step is Sub-Process End %0 of type %1 . Parent Subflow : %2''',
'      , p0        => p_step_info.target_objt_ref',
'      , p1        => p_step_info.target_objt_subtag',
'      , p2        => l_sbfl_id_par',
'      ); ',
'      if p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_error_event_definition then',
'        -- error exit event - return to errorBoundaryEvent if it exists and if not to normal exit',
'        begin',
'          select boundary_objt.objt_bpmn_id',
'               , subproc_objt.objt_bpmn_id',
'            into l_boundary_event',
'               , l_subproc_objt',
'            from flow_objects boundary_objt',
'            join flow_objects subproc_objt',
'              on subproc_objt.objt_bpmn_id = boundary_objt.objt_attached_to',
'            join flow_subflows par_sbfl',
'              on par_sbfl.sbfl_current = subproc_objt.objt_bpmn_id',
'            join flow_processes prcs ',
'              on par_sbfl.sbfl_prcs_id = prcs.prcs_id',
'             and prcs.prcs_dgrm_id = boundary_objt.objt_dgrm_id',
'             and prcs.prcs_dgrm_id = subproc_objt.objt_dgrm_id',
'           where par_sbfl.sbfl_id = l_sbfl_id_par',
'             and par_sbfl.sbfl_prcs_id = p_process_id',
'             and boundary_objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_error_event_definition',
'          ;',
'          -- first remove any non-interrupting timers that are on the parent event',
'          flow_boundary_events.unset_boundary_timers (p_process_id, l_sbfl_id_par);',
'          -- set current event on parent process to the error Boundary Event',
'          update flow_subflows sbfl',
'          set sbfl.sbfl_current = l_boundary_event',
'            , sbfl.sbfl_last_completed = l_subproc_objt  -- is this done in next_step?',
'            , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'          where sbfl.sbfl_id = l_sbfl_id_par',
'            and sbfl.sbfl_prcs_id = p_process_id',
'            ;',
'          -- execute the on-event expressions for the boundary event',
'          flow_expressions.process_expressions',
'          ( pi_objt_bpmn_id => l_boundary_event  ',
'          , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'          , pi_prcs_id      => p_process_id',
'          , pi_sbfl_id      => p_subflow_id',
'          );',
'        exception',
'          when no_data_found then',
'            -- error exit with no Boundary Event specified -- return to normal exit',
'            l_boundary_event := null;',
'          when too_many_rows then',
'            apex_error.add_error',
'              ( p_message => ''More than one error boundaryEvent found on sub process ''||l_subproc_objt||''.''',
'            , p_display_location => apex_error.c_on_error_page',
'            );',
'        end;',
'        -- stop processing in sub process and all children',
'        flow_engine_util.terminate_level',
'        ( p_process_id => p_process_id',
'        , p_process_level => p_sbfl_info.sbfl_process_level',
'        );',
'',
'      elsif p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_terminate_event_definition then',
'        -- stop processing in sub process and all children',
'        flow_engine_util.terminate_level',
'        ( p_process_id    => p_process_id',
'        , p_process_level => p_sbfl_info.sbfl_process_level',
'        ); ',
'      elsif p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_escalation_event_definition then',
'        -- this can be interrupting or non-interupting',
'        flow_boundary_events.process_boundary_event',
'        ( p_process_id    => p_process_id',
'        , p_subflow_id    => p_subflow_id',
'        , p_step_info     => p_step_info',
'        , p_par_sbfl      => l_sbfl_id_par',
'        , p_process_level => p_sbfl_info.sbfl_process_level',
'        );',
'      elsif p_step_info.target_objt_subtag is null then ',
'        -- normal end event',
'        flow_engine_util.subflow_complete',
'        ( p_process_id => p_process_id',
'        , p_subflow_id => p_subflow_id',
'        );',
'',
'      end if;',
'      -- check if there are ANY remaining subflows in the subProcess.  If not, close process',
'      select count(*)',
'        into l_remaining_subflows',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_prcs_id = p_process_id',
'         and sbfl.sbfl_process_level = p_sbfl_info.sbfl_process_level;',
'        ',
'      if l_remaining_subflows = 0 then ',
'        -- No remaining subflows so subprocess has completed - return to parent and do next step',
'        flow_complete_step ',
'        ( p_process_id => p_process_id',
'        , p_subflow_id => l_sbfl_id_par',
'        );  ',
'        apex_debug.info (''SubProcess Completed: Process level %0'', p_sbfl_info.sbfl_process_level );',
'',
'      end if;',
'    end if; ',
'  end process_endEvent;',
'',
'  procedure process_subProcess',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    )',
'  is',
'    l_target_objt_sub        flow_objects.objt_bpmn_id%type; --target object in subprocess',
'    l_sbfl_id_sub            flow_subflows.sbfl_id%type;   ',
'  begin',
'    apex_debug.enter ',
'    ( ''process_subprocess''',
'    , ''object'', p_step_info.target_objt_tag ',
'    );',
'    begin',
'       select objt.objt_bpmn_id',
'         into l_target_objt_sub',
'         from flow_objects objt',
'        where objt.objt_objt_id  = p_step_info.target_objt_id',
'          and objt.objt_tag_name = flow_constants_pkg.gc_bpmn_start_event  ',
'          and objt.objt_dgrm_id  = p_step_info.dgrm_id',
'       ;',
'    exception',
'      when no_data_found then',
'        apex_error.add_error',
'        ( p_message => ''Unable to find Sub-Process Start Event.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'      when too_many_rows then',
'        apex_error.add_error',
'        ( p_message => ''More than one Sub-Process Start found..''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    end;',
'    -- start subflow for the sub-process',
'    l_sbfl_id_sub := ',
'      flow_engine_util.subflow_start',
'      ( p_process_id => p_process_id',
'      , p_parent_subflow => p_subflow_id',
'      , p_starting_object => p_step_info.target_objt_ref -- parent subProc activity',
'      , p_current_object => l_target_objt_sub -- subProc startEvent',
'      , p_route => ''sub main''',
'      , p_last_completed => p_sbfl_info.sbfl_last_completed -- previous activity on parent proc',
'      , p_parent_sbfl_proc_level => null',
'      , p_new_proc_level => true',
'      , p_dgrm_id => p_sbfl_info.sbfl_dgrm_id',
'      );',
'',
'    -- Always do all updates to parent data first before performing any next step in the children.',
'    -- Reason: A subflow could immediately disappear if we''re stepping through it completly.',
'',
'    -- run on-event expressions for child startEvent',
'    flow_expressions.process_expressions',
'    ( pi_objt_bpmn_id => l_target_objt_sub  ',
'    , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'    , pi_prcs_id      => p_process_id',
'    , pi_sbfl_id      => l_sbfl_id_sub',
'    );',
'    -- Update parent subflow',
'    update flow_subflows sbfl',
'    set   sbfl.sbfl_current = p_step_info.target_objt_ref -- parent subProc Activity',
'        , sbfl.sbfl_last_completed = p_sbfl_info.sbfl_last_completed',
'        , sbfl.sbfl_last_update = systimestamp',
'        , sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_in_subprocess',
'    where sbfl.sbfl_id = p_subflow_id',
'      and sbfl.sbfl_prcs_id = p_process_id',
'    ;  ',
'    -- set boundaryEvent Timers, if any',
'    flow_boundary_events.set_boundary_timers ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );     ',
'',
'    -- step into sub_process',
'    flow_complete_step   ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => l_sbfl_id_sub',
'    , p_forward_route => null',
'    );',
'  end process_subProcess; ',
'',
'  procedure process_intermediateCatchEvent',
'  ( ',
'    p_process_id in flow_processes.prcs_id%type',
'  , p_subflow_id in flow_subflows.sbfl_id%type',
'  , p_sbfl_info  in flow_subflows%rowtype',
'  , p_step_info  in flow_types_pkg.flow_step_info',
'  )',
'  is ',
'  begin',
'    -- then we make everything behave like a simple activity unless specifically supported',
'    -- currently only supports timer and without checking its type is timer',
'    -- but this will have a case type = timer, emailReceive. ....',
'    -- this is currently just a stub.',
'    apex_debug.enter',
'    ( ''process_IntermediateCatchEvent''',
'    , ''p_step_info.target_objt_ref'', p_step_info.target_objt_ref',
'    );',
'',
'    if p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_timer_event_definition then',
'      -- we have a timer.  Set status to waiting and schedule the timer.',
'      update flow_subflows sbfl',
'         set sbfl.sbfl_current = p_step_info.target_objt_ref',
'           , sbfl.sbfl_last_completed = p_sbfl_info.sbfl_last_completed',
'           , sbfl.sbfl_last_update = systimestamp',
'           , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_waiting_timer',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'      flow_timers_pkg.start_timer',
'      ( ',
'        pi_prcs_id => p_process_id',
'      , pi_sbfl_id => p_subflow_id',
'      );',
'    else',
'      -- not a timer.  Just set it to running for now.  (other types to be implemented later)',
'      -- this includes bpmn:linkEventDefinition which should come here',
'      update flow_subflows sbfl',
'         set sbfl.sbfl_current = p_step_info.target_objt_ref',
'           , sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'           , sbfl.sbfl_last_update = systimestamp',
'           , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'    end if;',
'  end process_intermediateCatchEvent;',
'',
'  procedure process_intermediateThrowEvent',
'  ( ',
'    p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_sbfl_info     in flow_subflows%rowtype',
'  , p_step_info     in flow_types_pkg.flow_step_info',
'  )',
'  is ',
'    l_par_sbfl    flow_subflows.sbfl_id%type;',
'  begin',
'    -- currently only supports none Intermediate throw event (used as a process state marker)',
'    -- but this might later have a case type = timer, message, etc. ....',
'    apex_debug.enter ',
'    (''process_IntermediateThrowEvent''',
'    , ''p_step_info.target_objt_ref'', p_step_info.target_objt_ref',
'    );',
'    -- process on-event expressions for the ITE',
'    flow_expressions.process_expressions',
'    ( pi_objt_id      => p_step_info.target_objt_id  ',
'    , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'    , pi_prcs_id      => p_process_id',
'    , pi_sbfl_id      => p_subflow_id',
'    );',
'',
'    if p_step_info.target_objt_subtag is null then',
'      -- a none event.  Make the ITE the current event then just call flow_complete_step.  ',
'      update flow_subflows sbfl',
'      set   sbfl.sbfl_current = p_step_info.target_objt_ref',
'          , sbfl.sbfl_last_completed = p_sbfl_info.sbfl_last_completed',
'          , sbfl.sbfl_last_update = systimestamp',
'          , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'      where sbfl.sbfl_id = p_subflow_id',
'          and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'      flow_complete_step',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_subflow_id',
'      );',
'    elsif p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_link_event_definition then',
'      flow_process_link_event',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_subflow_id',
'      , p_sbfl_info  => p_sbfl_info',
'      , p_step_info  => p_step_info',
'      );   ',
'    elsif p_step_info.target_objt_subtag = flow_constants_pkg.gc_bpmn_escalation_event_definition then',
'      -- make the ITE the current event',
'      update  flow_subflows sbfl',
'          set sbfl.sbfl_current = p_step_info.target_objt_ref',
'            , sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'            , sbfl.sbfl_last_update = systimestamp',
'            , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'        where sbfl.sbfl_id = p_subflow_id',
'          and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'      -- get the subProcess event in the parent level',
'      l_par_sbfl := flow_engine_util.get_subprocess_parent_subflow',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_subflow_id',
'      , p_current => p_step_info.target_objt_ref',
'      );',
'      -- escalate it to the boundary Event',
'      flow_boundary_events.process_boundary_event',
'      ( p_process_id    => p_process_id',
'      , p_subflow_id    => p_subflow_id',
'      , p_step_info     => p_step_info',
'      , p_par_sbfl      => l_par_sbfl',
'      , p_process_level => p_sbfl_info.sbfl_process_level',
'      );  ',
'    else ',
'      --- other type of intermediateThrowEvent that is not currently supported',
'      apex_error.add_error',
'          ( p_message => ''Currently unsupported type of Intermediate Throw Event encountered at ''||p_sbfl_info.sbfl_current||'' .''',
'          , p_display_location => apex_error.c_on_error_page',
'          );',
'    end if;',
'end process_intermediateThrowEvent;',
'',
'',
'/* ',
'================================================================================',
'   E V E N T   H A N D L I N G ',
'================================================================================',
'*/',
'',
'procedure handle_event_gateway_event',
'  ( p_process_id         in flow_processes.prcs_id%type',
'  , p_parent_subflow_id  in flow_subflows.sbfl_id%type',
'  , p_cleared_subflow_id in flow_subflows.sbfl_id%type',
'  )',
'is ',
'    l_forward_route         flow_connections.conn_id%type;',
'    l_current_object        flow_subflows.sbfl_current%type;',
'    l_child_starting_object flow_subflows.sbfl_starting_object%type;',
'    l_dgrm_id               flow_diagrams.dgrm_id%type;',
'    l_parent_sbfl           flow_subflows.sbfl_id%type;',
'    l_return                varchar2(50);',
'begin',
'    -- called from any event that has cleared (so expired timer, received message or signal, etc) to move eBG forwards',
'    -- procedure has to:',
'    -- - check that gateway has not already been cleared by another event',
'    -- - resume the incoming subflow on the path of the first event to occur and call next_step',
'    -- - stop / terminate all of the child subflows that were created to wait for other events',
'    -- - including making sure any timers, message receivers, etc., are cleared up.',
'',
'    -- note that if this is called from a timer, you might not be in an APEX session so might not get debug',
'    apex_debug.enter',
'    ( ''handle_event_gateway_event'' ',
'    , ''p_process_id'', p_process_id',
'    , ''parent_subflow'', p_parent_subflow_id',
'    , ''p_cleared_subflow_id'', p_cleared_subflow_id',
'    );',
'    begin',
'      select sbfl.sbfl_id',
'        into l_parent_sbfl',
'        from flow_subflows sbfl',
'       where sbfl.sbfl_id = p_parent_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'         and sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_split  ',
'          ;',
'     exception',
'       when no_data_found then',
'        -- gateway aready cleared',
'         raise; ',
'     end;',
'     -- make the incoming (main) (split) parent subflow proceed along the path of the cleared event.clear(',
'    l_dgrm_id := flow_engine_util.get_dgrm_id( p_prcs_id => p_process_id );',
'     select conn.conn_id',
'          , sbfl.sbfl_current',
'          , sbfl.sbfl_starting_object',
'       into l_forward_route',
'          , l_current_object',
'          , l_child_starting_object',
'       from flow_objects objt',
'       join flow_subflows sbfl ',
'         on sbfl.sbfl_current = objt.objt_bpmn_id',
'       join flow_processes prcs',
'         on sbfl.sbfl_prcs_id = prcs.prcs_id',
'        and prcs.prcs_dgrm_id = objt.objt_dgrm_id',
'       join flow_connections conn ',
'         on conn.conn_src_objt_id = objt.objt_id',
'        and conn.conn_dgrm_id = prcs.prcs_dgrm_id',
'      where sbfl.sbfl_id = p_cleared_subflow_id',
'        and prcs.prcs_id = p_process_id',
'        and conn.conn_tag_name = flow_constants_pkg.gc_bpmn_sequence_flow',
'          ;',
'     update flow_subflows sbfl',
'        set sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'          , sbfl_current = l_current_object',
'          , sbfl_last_completed = l_child_starting_object',
'          , sbfl_last_update = systimestamp',
'      where sbfl.sbfl_prcs_id = p_process_id',
'        and sbfl.sbfl_id = p_parent_subflow_id',
'        and sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_split  ',
'          ;',
'    -- now clear up all of the sibling subflows',
'    begin',
'      for child_subflows in (',
'        select sbfl.sbfl_id',
'             , sbfl.sbfl_current',
'             , objt.objt_sub_tag_name',
'          from flow_subflows sbfl',
'          join flow_objects objt ',
'            on sbfl.sbfl_current = objt.objt_bpmn_id',
'          join flow_processes prcs',
'            on sbfl.sbfl_prcs_id = prcs.prcs_id',
'           and objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'         where sbfl.sbfl_sbfl_id = p_parent_subflow_id',
'           and sbfl.sbfl_starting_object = l_child_starting_object',
'           and objt.objt_dgrm_id = l_dgrm_id',
'      )',
'      loop',
'        -- clean up any event handlers (timers, etc.) (add more here when supporting messageEvent, SignalEvent, etc.)',
'        if child_subflows.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition then',
'          flow_timers_pkg.terminate_timer',
'            ( pi_prcs_id => p_process_id',
'            , pi_sbfl_id => child_subflows.sbfl_id',
'            , po_return_code => l_return',
'            );',
'        end if;',
'        -- delete the completed subflow and log it as complete',
'            ',
'        delete',
'          from flow_subflows sbfl',
'         where sbfl.sbfl_prcs_id = p_process_id',
'           and sbfl.sbfl_id = child_subflows.sbfl_id',
'            ;',
'        -- logging - tbd',
'      end loop;',
'    end;  -- cleanup block',
'    -- now step forward on the forward path',
'    flow_complete_step           ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_parent_subflow_id',
'    , p_forward_route => null',
'    );',
'end handle_event_gateway_event;',
'',
'procedure handle_intermediate_catch_event',
'  ( p_process_id   in flow_processes.prcs_id%type',
'  , p_subflow_id   in flow_subflows.sbfl_id%type',
'  , p_current_objt in flow_subflows.sbfl_current%type',
'  ) ',
'is',
'begin',
'  apex_debug.enter',
'  ( ''handle_intermediate_catch_event''',
'  , ''Subflow'', p_subflow_id',
'  );',
'  update flow_subflows sbfl ',
'     set sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'       , sbfl.sbfl_last_update = systimestamp',
'   where sbfl.sbfl_prcs_id = p_process_id',
'     and sbfl.sbfl_id = p_subflow_id',
'  ;',
'  --  process any variable expressions in the OnEvent set',
'  flow_expressions.process_expressions',
'  ( pi_objt_bpmn_id => p_current_objt  ',
'  , pi_set          => flow_constants_pkg.gc_expr_set_on_event',
'  , pi_prcs_id      => p_process_id',
'  , pi_sbfl_id      => p_subflow_id',
'  );',
'  -- move onto next step',
'  flow_complete_step ',
'  ( p_process_id => p_process_id',
'  , p_subflow_id => p_subflow_id',
'  , p_forward_route => null',
'  );',
'end handle_intermediate_catch_event;',
'',
'procedure flow_handle_event',
'  ( p_process_id in flow_processes.prcs_id%type',
'  , p_subflow_id in flow_subflows.sbfl_id%type',
'  ) ',
'is',
'  l_parent_subflow        flow_subflows.sbfl_id%type;',
'  l_prev_objt_tag_name    flow_objects.objt_tag_name%type;',
'  l_curr_objt_tag_name    flow_objects.objt_tag_name%type;',
'  l_dgrm_id               flow_diagrams.dgrm_id%type;',
'  l_sbfl_current          flow_subflows.sbfl_current%type;',
'begin',
'  -- currently handles callbacks from flow_timers when a timer fires',
'  apex_debug.enter ',
'  ( ''flow_handle_event''',
'  , ''subflow_id'', p_subflow_id',
'  , ''process_id'', p_process_id',
'  );',
'  -- look at current event to check if it is a startEvent.  (this also has no previous event!)',
'  -- if not, examine previous event on the subflow to determine if it was eventBasedGateway (eBG)',
'  -- an intermediateCatchEvent (iCE) following an eBG will always have exactly 1 input (from the eBG)',
'  -- an independant iCE (not following an eBG) can have >1 inputs',
'  -- so look for preceding eBG.  If previous event not eBG or there are multiple prev events, it did not follow an eBG.',
'  l_dgrm_id := flow_engine_util.get_dgrm_id (p_prcs_id => p_process_id);',
'  -- set context for scripts and variable expressions',
'  flow_globals.set_context',
'  ( pi_prcs_id => p_process_id',
'  , pi_sbfl_id => p_subflow_id',
'  );',
'  flow_globals.set_is_recursive_step (p_is_recursive_step => true);',
'  -- lock subflow containing event',
'  if flow_engine_util.lock_subflow(p_subflow_id) then',
'    -- subflow_locked',
'    select curr_objt.objt_tag_name',
'         , sbfl.sbfl_sbfl_id',
'         , sbfl.sbfl_current',
'      into l_curr_objt_tag_name',
'         , l_parent_subflow',
'         , l_sbfl_current',
'      from flow_objects curr_objt ',
'      join flow_subflows sbfl ',
'        on sbfl.sbfl_current = curr_objt.objt_bpmn_id',
'       and sbfl.sbfl_dgrm_id = curr_objt.objt_dgrm_id',
'/*      join flow_processes prcs',
'        on prcs.prcs_id = sbfl.sbfl_prcs_id',
'       and prcs_dgrm_id = curr_objt.objt_dgrm_id */',
'     where sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_prcs_id = p_process_id',
'        ;',
'',
'    if l_curr_objt_tag_name in ( flow_constants_pkg.gc_bpmn_start_event   -- startEvent with associated event.',
'                               , flow_constants_pkg.gc_bpmn_boundary_event  ) then',
'      -- required functionality same as iCE currently',
'      handle_intermediate_catch_event ',
'      (',
'        p_process_id   => p_process_id',
'      , p_subflow_id   => p_subflow_id',
'      , p_current_objt => l_sbfl_current',
'      );',
'    elsif l_curr_objt_tag_name in ( flow_constants_pkg.gc_bpmn_subprocess',
'                                  , flow_constants_pkg.gc_bpmn_task ',
'                                  , flow_constants_pkg.gc_bpmn_usertask',
'                                  , flow_constants_pkg.gc_bpmn_manualtask',
'                                  )   -- add any objects that can support timer boundary events here',
'          -- if any of these events have a timer on them, it must be an interrupting timer.',
'          -- because non-interupting timers are set on the boundary event itself',
'    then',
'      -- we have an interrupting boundary event',
'      flow_boundary_events.handle_interrupting_boundary_event ',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => p_subflow_id',
'      );',
'    else',
'      -- we need to look at previous step to see if this follows an eventBasedGateway...',
'      begin',
'        select prev_objt.objt_tag_name',
'          into l_prev_objt_tag_name',
'          from flow_connections conn ',
'          join flow_objects curr_objt ',
'            on conn.conn_tgt_objt_id = curr_objt.objt_id ',
'           and conn.conn_dgrm_id = curr_objt.objt_dgrm_id',
'          join flow_objects prev_objt ',
'            on conn.conn_src_objt_id = prev_objt.objt_id',
'           and conn.conn_dgrm_id = prev_objt.objt_dgrm_id',
'         where conn.conn_dgrm_id = l_dgrm_id',
'           and curr_objt.objt_bpmn_id = l_sbfl_current',
'            ;',
'      exception',
'        when too_many_rows then',
'            l_prev_objt_tag_name := ''other'';',
'      end;',
'      if  l_curr_objt_tag_name = flow_constants_pkg.gc_bpmn_intermediate_catch_event   ',
'          and l_prev_objt_tag_name = flow_constants_pkg.gc_bpmn_gateway_event_based then',
'        -- we have an eventBasedGateway',
'        handle_event_gateway_event ',
'        (',
'          p_process_id => p_process_id',
'        , p_parent_subflow_id => l_parent_subflow',
'        , p_cleared_subflow_id => p_subflow_id',
'        );',
'      elsif l_curr_objt_tag_name = flow_constants_pkg.gc_bpmn_intermediate_catch_event then',
'        -- independant iCE not following an eBG',
'        -- set subflow status to running and call flow_complete_step',
'        handle_intermediate_catch_event ',
'        (',
'          p_process_id => p_process_id',
'        , p_subflow_id => p_subflow_id',
'        , p_current_objt => l_sbfl_current',
'        );',
'      end if;',
'    end if;',
'  end if; -- sbfl locked',
'exception',
'  when others then',
'    flow_errors.handle_instance_error',
'    ( pi_prcs_id  => p_process_id',
'    , pi_sbfl_id  => p_subflow_id',
'    , pi_message_key  => ''eng_handle_event_int''',
'    , p0  => p_process_id',
'    , p1  => p_subflow_id ',
'    , p2  => ''flow_handle_event''',
'    , p3  => l_curr_objt_tag_name',
'    , p4  => l_sbfl_current',
'    );',
'      -- $F4AMESSAGE ''eng_handle_event_int'' || ''Flow Engine Internal Error: Process %0 Subflow %1 Module %2 Current %4 Current Tag %3''',
'',
'end flow_handle_event;',
'',
'/************************************************************************************************************',
'****',
'****                       SUBFLOW  NEXT_STEP',
'****',
'*************************************************************************************************************/',
'',
'procedure finish_current_step',
'( p_sbfl_rec          in flow_subflows%rowtype',
', p_current_step_tag  in flow_objects.objt_tag_name%type',
', p_log_as_completed  in boolean default true',
')',
'is',
'begin',
'  -- runs all of the post-step operations for the old current task (handling post- expressionsa, releasing reservations, etc.)',
'  apex_debug.enter ',
'  ( ''finish_current_step''',
'  , ''Process ID'',  p_sbfl_rec.sbfl_prcs_id',
'  , ''Subflow ID'', p_sbfl_rec.sbfl_id',
'  );',
'  -- evaluate and set any post-step variable expressions on the last object',
'  if p_current_step_tag in ',
'  ( flow_constants_pkg.gc_bpmn_task, flow_constants_pkg.gc_bpmn_usertask, flow_constants_pkg.gc_bpmn_servicetask',
'  , flow_constants_pkg.gc_bpmn_manualtask, flow_constants_pkg.gc_bpmn_scripttask )',
'  then ',
'    flow_expressions.process_expressions',
'      ( pi_objt_bpmn_id   => p_sbfl_rec.sbfl_current',
'      , pi_set            => flow_constants_pkg.gc_expr_set_after_task',
'      , pi_prcs_id        => p_sbfl_rec.sbfl_prcs_id',
'      , pi_sbfl_id        => p_sbfl_rec.sbfl_id',
'    );',
'  end if;',
'  -- clean up any boundary events left over from the previous activity',
'  if (p_current_step_tag in ( flow_constants_pkg.gc_bpmn_subprocess',
'                              , flow_constants_pkg.gc_bpmn_task',
'                              , flow_constants_pkg.gc_bpmn_usertask',
'                              , flow_constants_pkg.gc_bpmn_manualtask',
'                            ) -- boundary event attachable types',
'      and p_sbfl_rec.sbfl_has_events is not null )            -- subflow has events attached',
'  then',
'      -- ',
'      apex_debug.info ',
'      ( p_message => ''boundary event cleanup triggered for subflow %0''',
'      , p0        => p_sbfl_rec.sbfl_id',
'      );',
'      flow_boundary_events.unset_boundary_timers ',
'      ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'      , p_subflow_id => p_sbfl_rec.sbfl_id);',
'  end if;',
'',
'  if p_log_as_completed then',
'    -- log current step as completed before loosing the reservation',
'    flow_logging.log_step_completion   ',
'    ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'    , p_subflow_id => p_sbfl_rec.sbfl_id',
'    , p_completed_object => p_sbfl_rec.sbfl_current',
'  '))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'  );',
'  end if;',
'  -- release subflow reservation',
'  if p_sbfl_rec.sbfl_reservation is not null then',
'    flow_reservations.release_step',
'    ( p_process_id        => p_sbfl_rec.sbfl_prcs_id',
'    , p_subflow_id        => p_sbfl_rec.sbfl_id',
'    , p_called_internally => true',
'    );',
'  end if;',
'',
'  apex_debug.info',
'  ( p_message => ''Post Step Operations completed for current step %1 on subflow %0.''',
'  , p0        => p_sbfl_rec.sbfl_id',
'  , p1        => p_sbfl_rec.sbfl_current',
'  );',
'',
'end finish_current_step;',
'',
'function get_next_step_info',
'( p_process_id        in flow_processes.prcs_id%type',
', p_subflow_id        in flow_subflows.sbfl_id%type',
', p_forward_route     in flow_connections.conn_bpmn_id%type default null',
') return flow_types_pkg.flow_step_info',
'is',
'  l_sbfl_rec              flow_subflows%rowtype;',
'  l_dgrm_id               flow_diagrams.dgrm_id%type;',
'  l_step_info             flow_types_pkg.flow_step_info;',
' -- l_prcs_check_id         flow_processes.prcs_id%type;',
'begin',
'  apex_debug.enter ',
'  ( ''get_next_step_info''',
'  , ''Process ID'',  p_process_id',
'  , ''Subflow ID'', p_subflow_id',
'  );',
'-- Find next subflow step',
'  begin',
'    select sbfl.sbfl_dgrm_id',
'         , objt_source.objt_tag_name',
'         , objt_source.objt_id',
'         , conn.conn_tgt_objt_id',
'         , objt_target.objt_bpmn_id',
'         , objt_target.objt_tag_name    ',
'         , objt_target.objt_sub_tag_name',
'      into l_step_info',
'      from flow_connections conn',
'      join flow_objects objt_source',
'        on conn.conn_src_objt_id = objt_source.objt_id',
'       and conn.conn_dgrm_id = objt_source.objt_dgrm_id',
'      join flow_objects objt_target',
'        on conn.conn_tgt_objt_id = objt_target.objt_id',
'       and conn.conn_dgrm_id = objt_target.objt_dgrm_id',
'--      join flow_processes prcs',
'--        on prcs.prcs_dgrm_id = conn.conn_dgrm_id',
'      join flow_subflows sbfl',
'        on sbfl.sbfl_current = objt_source.objt_bpmn_id ',
'       and sbfl.sbfl_dgrm_id = conn.conn_dgrm_id',
'--       and sbfl.sbfl_prcs_id = prcs.prcs_id',
'     where /*conn.conn_dgrm_id = l_dgrm_id',
'       and */conn.conn_tag_name = flow_constants_pkg.gc_bpmn_sequence_flow',
'       and conn.conn_bpmn_id like nvl2( p_forward_route, p_forward_route, ''%'' )',
'       and sbfl.sbfl_prcs_id = p_process_id',
'       and sbfl.sbfl_id = p_subflow_id',
'    ;',
'    return l_step_info;',
'  exception',
'    when no_data_found then',
'  /*    apex_error.add_error',
'      ( p_message => ''No Next Step Found.  Check your process diagram.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );*/',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => p_process_id',
'      , pi_sbfl_id        => p_subflow_id',
'      , pi_message_key    => ''no_next_step_found''',
'      , p0 => p_subflow_id',
'      );',
'      -- $F4AMESSAGE ''no_next_step_found'' || ''No Next Step Found on subflow %0.  Check your process diagram.''',
'    when too_many_rows then',
'  /*    apex_error.add_error',
'      ( p_message => ''More than 1 forward path found when only 1 allowed''',
'      , p_display_location => apex_error.c_on_error_page',
'      );*/',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => p_process_id',
'      , pi_sbfl_id        => p_subflow_id',
'      , pi_message_key    => ''more_than_1_forward_path''',
'      , p0 => p_subflow_id',
'      );',
'      -- $F4AMESSAGE ''more_than_1_forward_path'' || ''More than 1 forward path found when only 1 allowed.''',
'    when others then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id  => p_process_id',
'      , pi_sbfl_id  => p_subflow_id',
'      , pi_message_key  => ''eng_handle_event_int''',
'      , p0  => p_process_id',
'      , p1  => p_subflow_id ',
'      , p2  => ''get_next_step_info''',
'      , p3  => null',
'      , p4  => null',
'      );',
'      -- $F4AMESSAGE ''eng_handle_event_int'' || ''Flow Engine Internal Error: Process %0 Subflow %1 Module %2 Current %4 Current Tag %3''',
'  end;',
'end get_next_step_info;',
'',
'function get_restart_step_info',
'( p_process_id        in flow_processes.prcs_id%type',
', p_subflow_id        in flow_subflows.sbfl_id%type',
', p_current_bpmn_id   in flow_objects.objt_bpmn_id%type',
') return flow_types_pkg.flow_step_info',
'is',
'  l_sbfl_rec              flow_subflows%rowtype;',
'  l_dgrm_id               flow_diagrams.dgrm_id%type;',
'  l_step_info             flow_types_pkg.flow_step_info;',
'begin',
'  -- used to set up the current step for restarting when a subflow has status = error',
'  apex_debug.enter ',
'  ( ''get_restart_step_info''',
'  , ''Process ID'',  p_process_id',
'  , ''Subflow ID'', p_subflow_id',
'  );',
'-- Find next subflow step',
'  begin',
'    select sbfl.sbfl_dgrm_id',
'         , null ',
'         , null',
'         , objt_current.objt_id',
'         , objt_current.objt_bpmn_id',
'         , objt_current.objt_tag_name    ',
'         , objt_current.objt_sub_tag_name',
'      into l_step_info',
'      from flow_objects objt_current',
'      join flow_subflows sbfl',
'        on sbfl.sbfl_current = objt_current.objt_bpmn_id ',
'       and sbfl.sbfl_dgrm_id = objt_current.objt_dgrm_id',
'     where sbfl.sbfl_prcs_id = p_process_id',
'       and sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_current = p_current_bpmn_id',
'    ;',
'    return l_step_info;',
'  exception',
'  when no_data_found then',
'    apex_error.add_error',
'    ( p_message => ''No Current Error Found.  Check your process diagram.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'  when too_many_rows then',
'    apex_error.add_error',
'    ( p_message => ''More than 1 forward path found when only 1 allowed''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'  end;',
'end get_restart_step_info;',
'',
'procedure run_step',
'( p_sbfl_rec          in flow_subflows%rowtype',
', p_step_info         in flow_types_pkg.flow_step_info',
')',
'is',
'',
'begin',
'  apex_debug.enter ',
'  ( ''run_step''',
'  , ''Process ID'',  p_sbfl_rec.sbfl_prcs_id',
'  , ''Subflow ID'', p_sbfl_rec.sbfl_id',
'  );',
'',
'  apex_debug.info ',
'  ( p_message => ''Running Step - Target object: %s.  More info at APP_TRACE level.''',
'  , p0        => coalesce(p_step_info.target_objt_tag, ''!NULL!'') ',
'  );',
'  apex_debug.trace',
'  ( p_message => ''Runing Step Info - dgrm_id : %0, source_objt_tag : %1, target_objt_id : %2, target_objt_ref : %3''',
'  , p0  => p_step_info.dgrm_id',
'  , p1  => p_step_info.source_objt_tag',
'  , p2  => p_step_info.target_objt_id',
'  , p3  => p_step_info.target_objt_ref',
'  );',
'  apex_debug.trace',
'  ( p_message => ''Running Step Info - target_objt_tag : %0, target_objt_subtag : %1''',
'  , p0 => p_step_info.target_objt_tag',
'  , p1 => p_step_info.target_objt_subtag',
'  );',
'  apex_debug.trace',
'  ( p_message => ''Runing Step Context - sbfl_id : %0, sbfl_last_completed : %1, sbfl_prcs_id : %2''',
'  , p0 => p_sbfl_rec.sbfl_id',
'  , p1 => p_sbfl_rec.sbfl_last_completed',
'  , p2 => p_sbfl_rec.sbfl_prcs_id',
'  );    ',
'',
'  -- evaluate and set any pre-step variable expressions on the next object',
'  if p_step_info.target_objt_tag in ',
'  ( flow_constants_pkg.gc_bpmn_task, flow_constants_pkg.gc_bpmn_usertask, flow_constants_pkg.gc_bpmn_servicetask',
'  , flow_constants_pkg.gc_bpmn_manualtask, flow_constants_pkg.gc_bpmn_scripttask )',
'  then ',
'    flow_expressions.process_expressions',
'      ( pi_objt_id     => p_step_info.target_objt_id',
'      , pi_set         => flow_constants_pkg.gc_expr_set_before_task',
'      , pi_prcs_id     => p_sbfl_rec.sbfl_prcs_id',
'      , pi_sbfl_id     => p_sbfl_rec.sbfl_id',
'    );',
'  elsif p_step_info.target_objt_tag in ',
'  ( flow_constants_pkg.gc_bpmn_start_event, flow_constants_pkg.gc_bpmn_end_event ',
'  , flow_constants_pkg.gc_bpmn_intermediate_throw_event, flow_constants_pkg.gc_bpmn_intermediate_catch_event',
'  , flow_constants_pkg.gc_bpmn_boundary_event )',
'  then',
'    flow_expressions.process_expressions',
'      ( pi_objt_id     => p_step_info.target_objt_id',
'      , pi_set         => flow_constants_pkg.gc_expr_set_before_event',
'      , pi_prcs_id     => p_sbfl_rec.sbfl_prcs_id',
'      , pi_sbfl_id     => p_sbfl_rec.sbfl_id',
'    );',
'  end if;',
'',
'  case (p_step_info.target_objt_tag)',
'    when flow_constants_pkg.gc_bpmn_end_event then  --next step is either end of process or sub-process returning to its parent',
'      flow_engine.process_endEvent',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when flow_constants_pkg.gc_bpmn_gateway_exclusive then',
'      flow_gateways.process_exclusiveGateway',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when flow_constants_pkg.gc_bpmn_gateway_inclusive then',
'      flow_gateways.process_para_incl_Gateway',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when flow_constants_pkg.gc_bpmn_gateway_parallel then',
'      flow_gateways.process_para_incl_Gateway',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when flow_constants_pkg.gc_bpmn_subprocess then',
'      flow_engine.process_subProcess',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when flow_constants_pkg.gc_bpmn_gateway_event_based then',
'        flow_gateways.process_eventBasedGateway',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when  flow_constants_pkg.gc_bpmn_intermediate_catch_event then ',
'        flow_engine.process_intermediateCatchEvent',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when  flow_constants_pkg.gc_bpmn_intermediate_throw_event then ',
'        flow_engine.process_intermediateThrowEvent',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         ); ',
'    when  flow_constants_pkg.gc_bpmn_task then ',
'        flow_tasks.process_task',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         );',
'    when  flow_constants_pkg.gc_bpmn_usertask then',
'        flow_tasks.process_userTask',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         );',
'    when  flow_constants_pkg.gc_bpmn_scripttask then ',
'        flow_tasks.process_scriptTask',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         );',
'    when  flow_constants_pkg.gc_bpmn_manualtask then ',
'        flow_tasks.process_manualTask',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         );',
'    when  flow_constants_pkg.gc_bpmn_servicetask then ',
'    flow_tasks.process_scriptTask',
'         ( p_process_id => p_sbfl_rec.sbfl_prcs_id',
'         , p_subflow_id => p_sbfl_rec.sbfl_id',
'         , p_sbfl_info => p_sbfl_rec',
'         , p_step_info => p_step_info',
'         );',
'    end case;',
'',
'  exception',
'    when case_not_found then',
'      apex_error.add_error',
'      ( p_message => ''Process Model Error: Process BPMN model next step uses unsupported object: ''||p_step_info.target_objt_tag',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    when no_data_found then',
'      apex_error.add_error',
'      ( p_message => ''Next step does not exist. Please check your process diagram.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    when flow_plsql_runner_pkg.e_plsql_script_failed then',
'      /*',
'      apex_error.add_error',
'      (',
'        p_message => ''PL/SQL Call Error: The given PL/SQL code did not execute successfully.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'      */',
'      null;',
'    /*when others then',
'      apex_error.add_error',
'      ( p_message => ''Some other error finding next step''',
'      , p_display_location => apex_error.c_on_error_page',
'      );*/  -- let error run back to run_step',
'end run_step;',
'',
'',
'procedure flow_complete_step',
'( p_process_id        in flow_processes.prcs_id%type',
', p_subflow_id        in flow_subflows.sbfl_id%type',
', p_forward_route     in flow_connections.conn_bpmn_id%type default null',
', p_log_as_completed  in boolean default true',
', p_recursive_call    in boolean default true',
')',
'is',
'  l_sbfl_rec              flow_subflows%rowtype;',
'  l_step_info             flow_types_pkg.flow_step_info;',
'  l_dgrm_id               flow_diagrams.dgrm_id%type;',
' -- l_prcs_check_id         flow_processes.prcs_id%type;',
'begin',
'  apex_debug.enter ',
'  ( ''flow_complete_step''',
'  , ''Process ID'',  p_process_id',
'  , ''Subflow ID'', p_subflow_id',
'  , ''recursive_call'', case when p_recursive_call then ',
'                                                    ''true'' ',
'                                                 else ',
'                                                    ''false'' ',
'                                                 end',
'  );',
'  flow_globals.set_is_recursive_step (p_is_recursive_step => p_recursive_call);',
'  -- Get current object and current subflow info and lock it',
'  l_sbfl_rec := flow_engine_util.get_subflow_info ',
'  ( p_process_id => p_process_id',
'  , p_subflow_id => p_subflow_id',
'  , p_lock_process => false ',
'  , p_lock_subflow => true',
'  );',
'  -- if subflow has any associated non-interrupting timers on current object, lock the subflows and timers',
'  -- (other boundary event types only create a subflow when they fire)',
'  if l_sbfl_rec.sbfl_has_events like ''%:CNT%'' then ',
'    flow_boundary_events.lock_child_boundary_timers',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_parent_objt_bpmn_id => l_sbfl_rec.sbfl_current ',
'    ); ',
'  end if;',
'  -- lock associated timers for interrupting boundary events',
'  if l_sbfl_rec.sbfl_has_events like ''%:S_T%'' then ',
'    flow_timers_pkg.lock_timer(p_process_id, p_subflow_id);',
'  end if;',
'',
'  -- Find next subflow step',
'  l_step_info := get_next_step_info ',
'  ( p_process_id => p_process_id',
'  , p_subflow_id => p_subflow_id',
'  , p_forward_route => p_forward_route',
'  );',
'',
'  -- complete the current step by doing the post-step operations',
'  finish_current_step',
'  ( p_sbfl_rec => l_sbfl_rec',
'  , p_current_step_tag => l_step_info.source_objt_tag',
'  , p_log_as_completed => p_log_as_completed',
'  );',
'',
'  -- end of post-step operations for previous step',
'  if flow_globals.get_step_error then',
'    rollback;',
'    if p_recursive_call then',
'      -- set errort status on instance and subflow',
'      flow_errors.set_error_status',
'      ( pi_prcs_id => p_process_id',
'      , pi_sbfl_id => p_subflow_id',
'      );',
'    end if;',
'    apex_debug.info',
'    ( p_message => ''Subflow %0 : Step End Rollback due to earlier Error on Step %1''',
'    , p0        => p_subflow_id',
'    , p1        => l_sbfl_rec.sbfl_current',
'    );',
'  else',
'    -- update subflow with step completed, and prepare for next step before committing',
'    update flow_subflows sbfl',
'      set sbfl.sbfl_current = l_step_info.target_objt_ref',
'        , sbfl.sbfl_last_completed = l_sbfl_rec.sbfl_current',
'        , sbfl_became_current = systimestamp',
'        , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'        , sbfl_work_started = null',
'    where sbfl.sbfl_prcs_id = p_process_id',
'      and sbfl.sbfl_id = p_subflow_id',
'    ;',
'    commit;',
'',
'    apex_debug.info',
'    ( p_message => ''Subflow %0 : Step End Committed for step %1''',
'    , p0        => p_subflow_id',
'    , p1        => l_sbfl_rec.sbfl_current',
'    );',
'  ',
'',
'    -- start of pre-phase for next step',
'    -- reset step_had_error flag',
'    flow_globals.set_step_error ( p_has_error => false);',
'    -- now into next step so is not part of users current step',
'    flow_globals.set_is_recursive_step (p_is_recursive_step => true);',
'    apex_debug.info ( p_message => ''Step now counted as recursive'');',
'    -- relock subflow',
'    l_sbfl_rec := flow_engine_util.get_subflow_info ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_lock_process => false',
'    , p_lock_subflow => true',
'    );',
'/*',
'    l_sbfl_rec.sbfl_last_completed := l_sbfl_rec.sbfl_current;',
'    -- updating subflows here with became-current time, new current objt, new last completed.  Reset started time',
'    -- set status to running here...',
'    update flow_subflows sbfl',
'      set sbfl.sbfl_current = l_step_info.target_objt_ref',
'        , sbfl.sbfl_last_completed = l_sbfl_rec.sbfl_current',
'        , sbfl_became_current = systimestamp',
'        , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'        , sbfl_work_started = null',
'    where sbfl.sbfl_prcs_id = p_process_id',
'      and sbfl.sbfl_id = p_subflow_id',
'    ;',
'*/',
'    run_step ',
'    ( p_sbfl_rec => l_sbfl_rec',
'    , p_step_info => l_step_info ',
'    );',
'',
'      -- Commit transaction before returning',
'    if flow_globals.get_step_error then',
'      rollback;',
' --     if p_recursive_call then',
'        -- set errort status on instance and subflow',
'        flow_errors.set_error_status',
'        ( pi_prcs_id => p_process_id',
'        , pi_sbfl_id => p_subflow_id',
'        );',
'        commit;',
' --     end if;',
'      apex_debug.info',
'      ( p_message => ''Subflow %0 : Step End Rollback due to earlier Error.  (Error Status Just Committed.)''',
'      , p0        => p_subflow_id',
'      );',
'      ',
'    else',
'      commit;',
'',
'      apex_debug.info',
'      ( p_message => ''Subflow %0 : Step End Committed''',
'      , p0        => p_subflow_id',
'      );',
'    end if;',
'  end if;',
'  end flow_complete_step;',
'',
'  procedure start_step -- just (optionally) records the start time gpr work on the current step',
'    ( p_process_id         in flow_processes.prcs_id%type',
'    , p_subflow_id         in flow_subflows.sbfl_id%type',
'    , p_called_internally  in boolean default false',
'    )',
'  is',
'    l_existing_start       flow_subflows.sbfl_work_started%type;',
'  begin',
'    apex_debug.enter',
'    ( ''start_step''',
'    , ''Subflow '', p_subflow_id',
'    , ''Process '', p_process_id ',
'    );',
'    -- subflow should already be locked when calling internally',
'    if not p_called_internally then ',
'      -- lock  subflow if called externally',
'      select sbfl_work_started',
'        into l_existing_start',
'        from flow_subflows sbfl ',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'         for update of sbfl_work_started wait 2',
'      ;',
'    end if;',
'    -- set the start time if null',
'    if l_existing_start is null then',
'      update flow_subflows sbfl',
'        set sbfl_work_started = systimestamp',
'      where sbfl_prcs_id = p_process_id',
'        and sbfl_id = p_subflow_id',
'      ;',
'      -- commit reservation if this is an external call',
'      if not p_called_internally then ',
'        commit;',
'      end if;',
'    end if;',
'  exception',
'    when no_data_found then',
'      apex_error.add_error',
'      ( p_message => ''Start Work time recording unsuccessful.  Subflow ''||p_subflow_id||'' in Process ''||p_process_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    when lock_timeout then',
'        apex_error.add_error',
'        ( p_message => ''Subflow ''||p_subflow_id||'' currently locked by another user.  Try to start your task later.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'  end start_step;',
'',
'procedure restart_step',
'  ( p_process_id          in flow_processes.prcs_id%type',
'  , p_subflow_id          in flow_subflows.sbfl_id%type',
'  , p_comment             in flow_instance_event_log.lgpr_comment%type default null',
'  )',
'is ',
'  l_sbfl_rec            flow_subflows%rowtype;',
'  l_step_info           flow_types_pkg.flow_step_info;',
'  l_num_error_subflows  number;',
'begin ',
'  apex_debug.enter ',
'  ( ''flow_restart_step''',
'  , ''Process ID'',  p_process_id',
'  , ''Subflow ID'', p_subflow_id',
'  );',
'  flow_globals.set_is_recursive_step (p_is_recursive_step => true);',
'   -- reset step_had_error flag',
'  flow_globals.set_step_error ( p_has_error => false);',
'',
'  -- lock the process and subflow',
'  l_sbfl_rec := flow_engine_util.get_subflow_info ',
'                ( p_process_id => p_process_id',
'                , p_subflow_id => p_subflow_id',
'                , p_lock_process => true',
'                , p_lock_subflow => true',
'                );',
'  -- check subflow current task is in error status',
'  if l_sbfl_rec.sbfl_status <> flow_constants_pkg.gc_sbfl_status_error then ',
'      apex_error.add_error',
'      ( p_message => ''Only Subflows with a status of error can be re-started''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'  end if;',
'  -- set up step context',
'  l_step_info :=  get_restart_step_info',
'                  ( p_process_id => p_process_id',
'                  , p_subflow_id => p_subflow_id',
'                  , p_current_bpmn_id => l_sbfl_rec.sbfl_current',
'                  );',
'  -- set subflow status to running',
'  update flow_subflows sbfl',
'     set sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'       , sbfl_last_update = systimestamp',
'   where sbfl.sbfl_prcs_id = p_process_id',
'     and sbfl.sbfl_id = p_subflow_id',
'  ;',
'  -- log the restart',
'  flow_logging.log_instance_event',
'  ( p_process_id => p_process_id',
'  , p_event      => flow_constants_pkg.gc_prcs_event_restart_step',
'  , p_comment    => ''restart step ''||l_sbfl_rec.sbfl_current||''. Comment: ''||p_comment',
'  );',
'  -- see if instance can be reset to running',
'  select count(sbfl_id)',
'    into l_num_error_subflows',
'    from flow_subflows sbfl ',
'   where sbfl.sbfl_prcs_id = p_process_id',
'     and sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_error ',
'  ;',
'  if l_num_error_subflows = 0 then',
'    update flow_processes prcs',
'       set prcs.prcs_status = flow_constants_pkg.gc_prcs_status_running',
'     where prcs.prcs_id = p_process_id',
'    ;',
'    flow_logging.log_instance_event',
'    ( p_process_id => p_process_id',
'    , p_event      => flow_constants_pkg.gc_prcs_status_running',
'    );',
'  end if;',
'',
'  -- restart current task',
'  run_step ',
'  ( p_sbfl_rec => l_sbfl_rec',
'  , p_step_info => l_step_info',
'  );',
'  -- commit or rollback based on errors',
'  if flow_globals.get_step_error then',
'    rollback;',
'  else',
'    commit;',
'  end if;',
'end restart_step;',
'',
'end flow_engine;',
'/',
'',
'create or replace package body flow_errors',
'as',
'',
'  g_logging_language        flow_configuration.cfig_value%type; ',
'',
'  procedure autonomous_write_to_instance_log',
'  ( pi_prcs_id        in flow_processes.prcs_id%type',
'  , pi_message        in flow_instance_event_log.lgpr_comment%type',
'  , pi_error_info     in flow_instance_event_log.lgpr_error_info%type',
'  )',
'  is',
'    pragma autonomous_transaction;',
'  begin',
'    -- add to instance_event_log',
'    flow_logging.log_instance_event',
'    ( p_process_id        => pi_prcs_id',
'    , p_event             => flow_constants_pkg.gc_prcs_event_error',
'    , p_comment           => pi_message',
'    , p_error_info        => pi_error_info',
'    );',
'    --  commit the autonomous transaction',
'    commit;',
'  end autonomous_write_to_instance_log;',
'',
'  procedure set_error_status',
'  ( pi_prcs_id        in flow_processes.prcs_id%type',
'  , pi_sbfl_id        in flow_subflows.sbfl_id%type',
'  )',
'  is ',
'  begin  ',
'      -- set sbfl & prcs error status',
'      update flow_subflows sbfl',
'        set sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_error',
'          , sbfl.sbfl_last_update = systimestamp',
'      where sbfl.sbfl_id = pi_sbfl_id',
'      ;',
'      update flow_processes prcs',
'        set prcs.prcs_status = flow_constants_pkg.gc_prcs_status_error',
'          , prcs.prcs_last_update = systimestamp',
'      where prcs.prcs_id = pi_prcs_id',
'      ;   ',
'  end set_error_status;',
'',
'  procedure handle_instance_error',
'  ( pi_prcs_id        in flow_processes.prcs_id%type',
'  , pi_sbfl_id        in flow_subflows.sbfl_id%type default null',
'  , pi_message_key    in varchar2',
'  , p0                in varchar2 default null',
'  , p1                in varchar2 default null',
'  , p2                in varchar2 default null',
'  , p3                in varchar2 default null',
'  , p4                in varchar2 default null',
'  , p5                in varchar2 default null',
'  , p6                in varchar2 default null',
'  , p7                in varchar2 default null',
'  , p8                in varchar2 default null',
'  , p9                in varchar2 default null',
'  )',
'  is',
'    l_message_content  flow_messages.fmsg_message_content%type;',
'    l_message          flow_instance_event_log.lgpr_comment%type;',
'    l_error_info       flow_instance_event_log.lgpr_error_info%type;',
'  begin ',
'    apex_debug.enter',
'    ( ''handle_instance_error''',
'    , ''pi_sbfl_id'', pi_sbfl_id',
'    , ''pi_message_key'', pi_message_key',
'    );',
'    -- get the message template in the correct language, or fall through to default language',
'    begin',
'      select fmsg.fmsg_message_content',
'        into l_message_content',
'        from flow_messages fmsg',
'       where fmsg.fmsg_message_key = pi_message_key',
'         and fmsg.fmsg_lang = g_logging_language',
'      ;',
'    exception',
'      when no_data_found then',
'        begin',
'          select fmsg.fmsg_message_content',
'            into l_message_content',
'            from flow_messages fmsg',
'           where fmsg.fmsg_message_key = pi_message_key',
'             and fmsg.fmsg_lang = flow_constants_pkg.gc_config_default_logging_language',
'          ;',
'        exception',
'          when no_data_found then',
'            l_message_content := ''Missing Message Key ''||pi_message_key||'' language ''',
'                                 ||flow_constants_pkg.gc_config_default_logging_language;',
'          when others then',
'            l_message_content := ''Problem getting error message - check flow_messages loaded'';',
'        end;',
'      when others then',
'        l_message_content := ''Problem getting error message - check flow_messages loaded'';',
'    end;',
'    -- now make the error message in local language for log & apex_error',
'    l_message :=  apex_string.format',
'                  ( p_message => l_message_content',
'                  , p0 => p0',
'                  , p1 => p1',
'                  , p2 => p2',
'                  , p3 => p3',
'                  , p4 => p4',
'                  , p5 => p5',
'                  , p6 => p6',
'                  , p7 => p7',
'                  , p8 => p8',
'                  , p9 => p9',
'                  );',
'    -- get the error stack and step type',
'    l_error_info   := dbms_utility.format_error_stack;',
'    -- add to instance_event_log',
'    autonomous_write_to_instance_log',
'    ( pi_prcs_id        => pi_prcs_id',
'    , pi_message        => l_message',
'    , pi_error_info     => l_error_info',
'    );',
'    -- decide where to put error message',
'    if flow_globals.get_is_recursive_step then',
'      -- errors written to log, status already set to error in autonomous session',
'      flow_globals.set_step_error (p_has_error => true);',
'    else',
'      -- step belongs to current user''s current session - use apex_error',
'      apex_error.add_error',
'      ( p_message => l_message',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    end if;',
'  end handle_instance_error;',
'',
'  -- initialize logging parameters',
'',
'  begin ',
'    g_logging_language := flow_engine_util.get_config_value',
'                       ( p_config_key => flow_constants_pkg.gc_config_logging_language',
'                       , p_default_value => flow_constants_pkg.gc_config_default_logging_language',
'                       );',
'',
'end flow_errors;',
'/',
'create or replace package body flow_expressions',
'as ',
'  ',
'  type t_expr_rec is record',
'  ( expr_id             flow_object_expressions.expr_id%type',
'  , expr_objt_id        flow_object_expressions.expr_objt_id%type',
'  , expr_set            flow_object_expressions.expr_set%type',
'  , expr_order          flow_object_expressions.expr_order%type',
'  , expr_var_name       flow_object_expressions.expr_var_name%type',
'  , expr_var_type       flow_object_expressions.expr_var_type%type',
'  , expr_type           flow_object_expressions.expr_type%type',
'  , expr_expression     flow_object_expressions.expr_expression%type',
'  , expr_objt_bpmn_id   flow_objects.objt_bpmn_id%type',
'  );',
'',
'  type t_expr_set is table of t_expr_rec;',
'',
'',
'  function get_expression_set',
'  ( pi_objt_id      flow_objects.objt_id%type',
'  , pi_set          flow_object_expressions.expr_set%type',
'  ) return t_expr_set',
'  as',
'    l_expressions   t_expr_set;',
'  begin',
'    select expr.expr_id',
'         , expr.expr_objt_id',
'         , expr.expr_set',
'         , expr.expr_order',
'         , expr.expr_var_name',
'         , expr.expr_var_type',
'         , expr.expr_type',
'         , expr.expr_expression',
'         , objt.objt_bpmn_id as expr_objt_bpmn_id',
'    bulk collect into l_expressions',
'      from flow_object_expressions expr',
'      join flow_objects objt',
'        on objt.objt_id = expr.expr_objt_id',
'     where expr.expr_objt_id = pi_objt_id',
'       and expr.expr_set = pi_set',
'     order by expr.expr_order asc',
'    ;',
'    return l_expressions;',
'  end get_expression_set;',
'',
'  /**********************************************************************',
'  **',
'  ** Process various expression types',
'  **',
'  ***********************************************************************',
'  */',
'',
'  procedure set_static',
'  ( pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  , pi_expression   t_expr_rec',
'  )',
'  as ',
'    l_expression_text   flow_object_expressions.expr_expression%type;',
'  begin',
'    apex_debug.enter',
'    ( ''flow_expressions.set_static''',
'    , ''expr_var_name'', pi_expression.expr_var_name',
'    , ''pi_expression.expr_var_type'', pi_expression.expr_var_type',
'    , ''pi_expression.expr_expression'' , pi_expression.expr_expression',
'    );',
'',
'    l_expression_text := pi_expression.expr_expression;',
'    -- substitute any F4A Process Variables',
'    flow_process_vars.do_substitution',
'    ( pi_prcs_id => pi_prcs_id',
'    , pi_sbfl_id => pi_sbfl_id',
'    , pio_string => l_expression_text',
'    );',
'    case pi_expression.expr_v'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'ar_type ',
'    when flow_constants_pkg.gc_prov_var_type_varchar2 then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_vc2_value      => l_expression_text',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );',
'    when flow_constants_pkg.gc_prov_var_type_number then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_num_value      => l_expression_text',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );',
'    when flow_constants_pkg.gc_prov_var_type_date then',
'        -- test date is in our required format',
'        begin',
'          if l_expression_text != to_char  ( to_date ( l_expression_text',
'                                                    , flow_constants_pkg.gc_prov_default_date_format )',
'                                          , flow_constants_pkg.gc_prov_default_date_format ) then ',
'          raise e_var_exp_date_format_error;',
'          end if;',
'        exception',
'          when others then',
'            raise e_var_exp_date_format_error;',
'        end;',
'',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_date_value     => to_date(l_expression_text, flow_constants_pkg.gc_prov_default_date_format)',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );',
'    when flow_constants_pkg.gc_prov_var_type_clob then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_clob_value     => l_expression_text',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );  ',
'    end case;',
'  exception',
'    when e_var_exp_date_format_error then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_date_format''',
'      , p0 => pi_sbfl_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_date_format'' || ''Error setting Process Variable %1: Incorrect Date Format (Subflow: %0, Set: %3.)''      ',
'    when others then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_static_general''',
'      , p0 => pi_prcs_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_static_general'' || ''Error setting %2 process variable %1 in process id %0.  See error in event log.''',
'',
'  end set_static;',
'',
'  procedure set_proc_var',
'  ( pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  , pi_expression   t_expr_rec',
'  )',
'  as ',
'  begin',
'    apex_debug.enter',
'    ( ''flow_expressions.set_proc_var''',
'    , ''expr_var_name'', pi_expression.expr_var_name',
'    , ''proc var'' , pi_expression.expr_expression',
'    );',
'    case pi_expression.expr_var_type ',
'    when flow_constants_pkg.gc_prov_var_type_varchar2 then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id   => pi_prcs_id',
'        , pi_var_name  => pi_expression.expr_var_name',
'        , pi_vc2_value => flow_process_vars.get_var_vc2 ',
'                          ( pi_prcs_id => pi_prcs_id',
'                          , pi_var_name => pi_expression.expr_expression',
'                          )',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );      ',
'    when flow_constants_pkg.gc_prov_var_type_date then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id    => pi_prcs_id',
'        , pi_var_name   => pi_expression.expr_var_name',
'        , pi_date_value => flow_process_vars.get_var_date ',
'                           ( pi_prcs_id  => pi_prcs_id',
'                           , pi_var_name => pi_expression.expr_expression',
'                           )',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );     ',
'    when flow_constants_pkg.gc_prov_var_type_number then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id      => pi_prcs_id',
'        , pi_var_name     => pi_expression.expr_var_name',
'        , pi_num_value    => flow_process_vars.get_var_num',
'                             ( pi_prcs_id  => pi_prcs_id',
'                             , pi_var_name => pi_expression.expr_expression',
'                             )',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );    ',
'    when flow_constants_pkg.gc_prov_var_type_clob then',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id    => pi_prcs_id',
'        , pi_var_name   => pi_expression.expr_var_name',
'        , pi_clob_value => flow_process_vars.get_var_clob ',
'                          ( pi_prcs_id  => pi_prcs_id',
'                          , pi_var_name => pi_expression.expr_expression',
'                          )',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );    ',
'    end case; ',
'  exception',
'    when others then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_static_general''',
'      , p0 => pi_prcs_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_static_general'' || ''Error setting %2 process variable %1 in process id %0.  See error in event log.''',
'        ',
'  end set_proc_var;',
'',
'  procedure set_sql',
'  ( pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_expression   t_expr_rec',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  )',
'  as ',
'    l_sql_text      flow_object_expressions.expr_expression%type;',
'    l_result_vc2    flow_process_variables.prov_var_vc2%type;',
'    l_result_date   flow_process_variables.prov_var_date%type;',
'    l_result_num    flow_process_variables.prov_var_num%type;',
'  begin',
'      apex_debug.enter',
'    ( ''flow_expressions.set_sql''',
'    , ''expr_var_name'', pi_expression.expr_var_name',
'    , ''sql text'' , pi_expression.expr_expression',
'    );',
'',
'    l_sql_text := pi_expression.expr_expression;',
'    -- substitute any F4A Process Variables',
'    flow_process_vars.do_substitution',
'    ( pi_prcs_id => pi_prcs_id',
'    , pi_sbfl_id => null',
'    , pio_string => l_sql_text',
'    );',
'    case pi_expression.expr_var_type ',
'    when flow_constants_pkg.gc_prov_var_type_varchar2 then',
'        begin',
'        execute immediate l_sql_text ',
'                    into l_result_vc2;',
'        exception',
'        when no_data_found then',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_no_data''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_no_data'' || ''Error setting %2 process variable %1 in process id %0.  No data found in query.''',
'        when too_many_rows then',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_too_many_rows''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_too_many_rows'' || ''Error setting %2 process variable %1 in process id %0.  Query returns multiple rows.''            ',
'        when others then',
'            apex_debug.error',
'            ( p_message => ''Error setting process variable %s for process id %s. SQLERRM: %s''',
'            , p0        => pi_expression.expr_var_name',
'            , p1        => pi_prcs_id',
'            , p2        => sqlerrm',
'            );',
'',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_other''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_other'' || ''Error setting %2 process variable %1 in process id %0.  SQL error shown in event log.''               ',
'        end;',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_vc2_value      => l_result_vc2',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );',
'    when flow_constants_pkg.gc_prov_var_type_date then',
'        begin',
'        execute immediate l_sql_text ',
'                    into l_result_date;',
'        exception',
'        when no_data_found then',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_no_data''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_no_data'' || ''Error setting %2 process variable %1 in process id %0.  No data found in query.''',
'        when too_many_rows then',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_too_many_rows''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_too_many_rows'' || ''Error setting %2 process variable %1 in process id %0.  Query returns multiple rows.''            ',
'        when others then',
'            apex_debug.error',
'            ( p_message => ''Error setting process variable %s for process id %s. SQLERRM: %s''',
'            , p0        => pi_expression.expr_var_name',
'            , p1        => pi_prcs_id',
'            , p2        => sqlerrm',
'            );',
'',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_other''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_other'' || ''Error setting %2 process variable %1 in process id %0.  SQL error shown in event log.''   ',
'        end;',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_date_value     => l_result_date',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );',
'    when flow_constants_pkg.gc_prov_var_type_number then',
'        begin',
'        execute immediate l_sql_text ',
'                    into l_result_num;',
'        exception',
'        when no_data_found then',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_no_data''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_no_data'' || ''Error setting %2 process variable %1 in process id %0.  No data found in query.''',
'        when too_many_rows then',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_too_many_rows''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_too_many_rows'' || ''Error setting %2 process variable %1 in process id %0.  Query returns multiple rows.''  ',
'        when others then',
'            apex_debug.error',
'            ( p_message => ''Error setting process variable %0 for process id %1. SQLERRM: %2''',
'            , p0        => pi_expression.expr_var_name',
'            , p1        => pi_prcs_id',
'            , p2        => sqlerrm',
'            );',
'',
'            flow_errors.handle_instance_error',
'            ( pi_prcs_id        => pi_prcs_id',
'            , pi_sbfl_id        => pi_sbfl_id',
'            , pi_message_key    => ''var_exp_sql_other''',
'            , p0 => pi_prcs_id',
'            , p1 => pi_expression.expr_var_name',
'            , p2 => pi_expression.expr_set',
'            );',
'            -- $F4AMESSAGE ''var_exp_sql_other'' || ''Error setting %2 process variable %1 in process id %0.  SQL error shown in event log.''   ',
'        end;',
'        flow_process_vars.set_var ',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_var_name       => pi_expression.expr_var_name',
'        , pi_num_value      => l_result_num',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'        , pi_expr_set       => pi_expression.expr_set',
'        );',
'    end case;',
'  end set_sql;',
'',
'  procedure set_sql_delimited',
'  ( pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_expression   t_expr_rec',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  )',
'  as ',
'    l_sql_text        flow_object_expressions.expr_expression%type;',
'    l_result_set_vc2  apex_t_varchar2;',
'    l_result          flow_process_variables.prov_var_vc2%type;',
'  begin',
'      apex_debug.enter',
'    ( ''flow_expressions.set_sql_delimited''',
'    , ''expr_var_name'', pi_expression.expr_var_name',
'    , ''sql text'' , pi_expression.expr_expression',
'    );',
'    l_sql_text := pi_expression.expr_expression;',
'    -- substitute any F4A Process Variables',
'    flow_process_vars.do_substitution',
'    ( pi_prcs_id => pi_prcs_id',
'    , pi_sbfl_id => pi_sbfl_id',
'    , pio_string => l_sql_text',
'    );',
'    begin',
'        execute immediate l_sql_text ',
'        bulk collect into  l_result_set_vc2;',
'    exception',
'    when no_data_found then',
'        /*apex_error.add_error',
'        ( p_message          => ''Error setting process variable ''||pi_expression.expr_var_name||'' for process id ''||pi_prcs_id||''s.  No data found in query.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );*/',
'        flow_errors.handle_instance_error',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_message_key    => ''var_exp_sql_no_data''',
'        , p0 => pi_prcs_id',
'        , p1 => pi_expression.expr_var_name',
'        , p2 => pi_expression.expr_set',
'        );',
'        -- $F4AMESSAGE ''var_exp_sql_no_data'' || ''Error setting %2 process variable %1 in process id %0.  No data found in query.''',
'    when others then',
'        apex_debug.error',
'        ( p_message => ''Error setting process variable %s for process id %s. SQLERRM: %s''',
'        , p0        => pi_expression.expr_var_name',
'        , p1        => pi_prcs_id',
'        , p2        => sqlerrm',
'        );',
'        /*apex_error.add_error',
'        ( p_message          => ''Error setting process variable ''||pi_expression.expr_var_name||'' for process id ''||pi_prcs_id||''.  SQL error shown in debug output.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );*/',
'        flow_errors.handle_instance_error',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_message_key    => ''var_exp_sql_other''',
'        , p0 => pi_prcs_id',
'        , p1 => pi_expression.expr_var_name',
'        , p2 => pi_expression.expr_set',
'        );',
'        -- $F4AMESSAGE ''var_exp_sql_other'' || ''Error setting %2 process variable %1 in process id %0.  SQL error shown in event log.''   ',
'    end;',
'    -- create delimited string output',
'    begin ',
'        l_result := apex_string.join',
'        ( p_table => l_result_set_vc2',
'        , p_sep => '':''',
'        );',
'    exception',
'    when others then',
'        apex_debug.error',
'        ( p_message => ''Error setting process variable %s for process id %s. SQLERRM: %s''',
'        , p0        => pi_expression.expr_var_name',
'        , p1        => pi_prcs_id',
'        , p2        => sqlerrm',
'        );',
'        /*apex_error.add_error',
'        ( p_message          => ''Error setting process variable ''||pi_expression.expr_var_name||'' for process id ''||pi_prcs_id||''.  SQL error shown in debug output.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );*/',
'        flow_errors.handle_instance_error',
'        ( pi_prcs_id        => pi_prcs_id',
'        , pi_sbfl_id        => pi_sbfl_id',
'        , pi_message_key    => ''var_exp_sql_other''',
'        , p0 => pi_sbfl_id',
'        , p1 => pi_expression.expr_var_name',
'        , p2 => pi_expression.expr_set',
'        );',
'        -- $F4AMESSAGE ''var_exp_sql_other'' || ''Error setting %2 process variable %1 in process id %0.  SQL error shown in event log.''',
'    end;',
'    apex_debug.message(p_message => ''Delimited String created %s'', p0 => l_result, p_level => 3);',
'    -- set proc variable',
'    flow_process_vars.set_var ',
'    ( pi_prcs_id        => pi_prcs_id',
'    , pi_var_name       => pi_expression.expr_var_name',
'    , pi_vc2_value      => l_result',
'    , pi_sbfl_id        => pi_sbfl_id',
'    , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'    , pi_expr_set       => pi_expression.expr_set    ',
'    );',
'  end set_sql_delimited;',
'',
'  procedure set_plsql_expression         ',
'  ( pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_expression   t_expr_rec',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  )',
'  as ',
'    l_result_vc2    flow_process_variables.prov_var_vc2%type;',
'    l_result_date   flow_process_variables.prov_var_date%type;',
'    l_result_num    flow_process_variables.prov_var_num%type;',
'  begin',
'    apex_debug.enter',
'    ( ''flow_expressions.set_plsql_expression''',
'    , ''expr_var_name'', pi_expression.expr_var_name',
'    , ''plsql expression'' , pi_expression.expr_expression',
'    );',
'    -- evaluate the expression',
'    l_result_vc2 := apex_plugin_util.get_plsql_expression_result ',
'                    ( p_plsql_expression => pi_expression.expr_expression',
'                    );',
'    case pi_expression.expr_var_type ',
'    when flow_constants_pkg.gc_prov_var_type_varchar2 then',
'',
'      flow_process_vars.set_var ',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_var_name       => pi_expression.expr_var_name',
'      , pi_vc2_value      => l_result_vc2',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'      , pi_expr_set       => pi_expression.expr_set',
'      );',
'    when flow_constants_pkg.gc_prov_var_type_date then',
'      -- test date value returned using our specified format',
'      if l_result_vc2 != to_char  ( to_date ( l_result_vc2 ',
'                                            , flow_constants_pkg.gc_prov_default_date_format )',
'                                  , flow_constants_pkg.gc_prov_default_date_format ) then ',
'         raise e_var_exp_date_format_error;',
'      end if;',
'      flow_process_vars.set_var ',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_var_name       => pi_expression.expr_var_name',
'      , pi_date_value     => to_date(l_result_vc2,flow_constants_pkg.gc_prov_default_date_format)',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'      , pi_expr_set       => pi_expression.expr_set',
'      );',
'    when flow_constants_pkg.gc_prov_var_type_number then',
'      flow_process_vars.set_var ',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_var_name       => pi_expression.expr_var_name',
'      , pi_num_value      => to_number(l_result_vc2)',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'      , pi_expr_set       => pi_expression.expr_set',
'      ); ',
'    else',
'      apex_error.add_error',
'      ( p_message          => ''Error setting process variable.  Incorrect datatype for variable ''||pi_expression.expr_var_name||''.  SQL error shown in debug output.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    end case;',
'  exception',
'    when e_var_exp_date_format_error then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_date_format''',
'      , p0 => pi_sbfl_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_date_format'' || ''Error setting Process Variable %1: Incorrect Date Format (Subflow: %0, Set: %3.)''      ',
'    when others then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_plsql_error''',
'      , p0 => pi_sbfl_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_plsql_error'' || ''Subflow : %0 Error in %2 expression for Variable : %1''',
'  end set_plsql_expression;  ',
'',
'  procedure set_plsql_function        ',
'  ( pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_expression   t_expr_rec',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  )',
'  as ',
'    l_result_vc2    flow_process_variables.prov_var_vc2%type;',
'    l_result_date   flow_process_variables.prov_var_date%type;',
'    l_result_num    flow_process_variables.prov_var_num%type;',
'  begin',
'    apex_debug.enter',
'    ( ''flow_expressions.set_plsql_function''',
'    , ''expr_var_name'', pi_expression.expr_var_name',
'    , ''plsql function body'' , pi_expression.expr_expression',
'    );',
'',
'    -- evaluate the function',
'    l_result_vc2 := apex_plugin_util.get_plsql_function_result ',
'                      ( p_plsql_function => pi_expression.expr_expression',
'                      );',
'    case pi_expression.expr_var_type ',
'    when flow_constants_pkg.gc_prov_var_type_varchar2 then',
'      flow_process_vars.set_var ',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_var_name       => pi_expression.expr_var_name',
'      , pi_vc2_value      => l_result_vc2',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'      , pi_expr_set       => pi_expression.expr_set',
'      );',
'    when flow_constants_pkg.gc_prov_var_type_date then',
'      -- a date value must be returned using our specified format',
'      -- add a test that format is good?',
'      begin',
'        if l_result_vc2 != to_char  ( to_date ( l_result_vc2 ',
'                                              , flow_constants_pkg.gc_prov_default_date_format )',
'                                    , flow_constants_pkg.gc_prov_default_date_format ) then ',
'        raise e_var_exp_date_format_error;',
'        end if;',
'      exception',
'        when others then',
'          raise e_var_exp_date_format_error;',
'      end;',
'',
'      flow_process_vars.set_var ',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_var_name       => pi_expression.expr_var_name',
'      , pi_date_value     => to_date(l_result_vc2, flow_constants_pkg.gc_prov_default_date_format)',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'      , pi_expr_set       => pi_expression.expr_set',
'      );',
'    when flow_constants_pkg.gc_prov_var_type_number then',
'      flow_process_vars.set_var ',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_var_name       => pi_expression.expr_var_name',
'      , pi_num_value      => to_number(l_result_vc2)',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_objt_bpmn_id   => pi_expression.expr_objt_bpmn_id',
'      , pi_expr_set       => pi_expression.expr_set ',
'      ); ',
'    else',
'      apex_error.add_error',
'      ( p_message          => ''Error setting process variable.  Incorrect datatype for variable ''||pi_expression.expr_var_name||''.  SQL error shown in debug output.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    end case;',
'  exception',
'    when e_var_exp_date_format_error then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_date_format''',
'      , p0 => pi_sbfl_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_date_format'' || ''Error setting Process Variable %1: Incorrect Date Format (Subflow: %0, Set: %3.)''      km',
'    when others then',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => pi_prcs_id',
'      , pi_sbfl_id        => pi_sbfl_id',
'      , pi_message_key    => ''var_exp_plsql_error''',
'      , p0 => pi_sbfl_id',
'      , p1 => pi_expression.expr_var_name',
'      , p2 => pi_expression.expr_set',
'      );',
'      -- $F4AMESSAGE ''var_exp_plsql_error'' || ''Subflow : %0 Error in %2 expression for Variable : %1''',
'  end set_plsql_function;',
'',
'  /**********************************************************************',
'  **',
'  ** Main Procedure',
'  **',
'  ***********************************************************************',
'  */',
'',
'  procedure process_expressions',
'  ( pi_objt_id      flow_objects.objt_id%type',
'  , pi_set          flow_object_expressions.expr_set%type',
'  , pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  )',
'  as',
'    l_expressions   t_expr_set;',
'  begin',
'    apex_debug.enter',
'    ( ''process_expressions''',
'    , ''pi_objt_id'', pi_objt_id',
'    , ''pi_set'' , pi_set',
'    );',
'',
'    l_expressions := get_expression_set',
'    ( pi_objt_id => pi_objt_id',
'    , pi_set     => pi_set',
'    );',
'    if l_expressions.count > 0 then ',
'      -- set context',
'      flow_globals.set_context',
'      ( pi_prcs_id => pi_prcs_id',
'      , pi_sbfl_id => pi_sbfl_id',
'      );',
'      apex_debug.trace ',
'      ( p_message => ''l_expressions.count: %0''',
'      , p0        => l_expressions.count',
'      );',
'      -- step through expressions',
'      for i in 1..l_expressions.count loop',
'        -- process expression',
'        case l_expressions(i).expr_type',
'          when flow_constants_pkg.gc_expr_type_static then',
'            set_static ',
'            ( pi_prcs_id      => pi_prcs_id',
'            , pi_sbfl_id      => pi_sbfl_id',
'            , pi_expression   => l_expressions(i)',
'            );',
'          when flow_constants_pkg.gc_expr_type_proc_var then',
'            set_proc_var',
'            ( pi_prcs_id    => pi_prcs_id',
'            , pi_sbfl_id    => pi_sbfl_id',
'            , pi_expression => l_expressions(i));',
'          when flow_constants_pkg.gc_expr_type_sql  then',
'            set_sql',
'            ( pi_prcs_id => pi_prcs_id',
'            , pi_expression => l_expressions(i)',
'            , pi_sbfl_id => pi_sbfl_id);',
'          when flow_constants_pkg.gc_expr_type_sql_delimited_list  then',
'            set_sql_delimited',
'            ( pi_prcs_id => pi_prcs_id',
'            , pi_expression => l_expressions(i)',
'            , pi_sbfl_id => pi_sbfl_id);     ',
'          when flow_constants_pkg.gc_expr_type_plsql_expression then',
'            set_plsql_expression',
'            ( pi_prcs_id => pi_prcs_id',
'            , pi_expression => l_expressions(i)',
'            , pi_sbfl_id => pi_sbfl_id); ',
'          when flow_constants_pkg.gc_expr_type_plsql_function_body then',
'            set_plsql_function',
'            ( pi_prcs_id => pi_prcs_id',
'            , pi_expression => l_expressions(i)',
'            , pi_sbfl_id => pi_sbfl_id);  ',
'          else',
'              null;',
'        end case;',
'      end loop;',
'    end if;',
'  end process_expressions;',
'',
'  -- overloaded process_expressions that accepts a objt_bpmn_id rather than an objt_id',
'  procedure process_expressions',
'  ( pi_objt_bpmn_id flow_objects.objt_bpmn_id%type',
'  , pi_set          flow_object_expressions.expr_set%type',
'  , pi_prcs_id      flow_processes.prcs_id%type',
'  , pi_sbfl_id      flow_subflows.sbfl_id%type',
'  )',
'  is ',
'    l_objt_id       flow_objects.objt_id%type;',
'  begin ',
'    apex_debug.enter',
'    ( ''process_expressions''',
'    , ''pi_objt_bpmn_id'', pi_objt_bpmn_id',
'    , ''pi_set'' , pi_set',
'    );',
'    -- look up the objt_id',
'    select objt.objt_id',
'      into l_objt_id',
'      from flow_objects objt',
'      join flow_subflows sbfl ',
'        on sbfl.sbfl_dgrm_id = objt.objt_dgrm_id',
'     where sbfl.sbfl_id = pi_sbfl_id',
'       and objt.objt_bpmn_id = pi_objt_bpmn_id',
'    ;',
'    process_expressions',
'    ( pi_objt_id      => l_objt_id',
'    , pi_set          => pi_set',
'    , pi_prcs_id      => pi_prcs_id',
'    , pi_sbfl_id      => pi_sbfl_id',
'    );',
'  exception',
'    when no_data_found then',
'      apex_error.add_error',
'      ( p_message          => ''Internal error looking up object ''||pi_objt_bpmn_id||'' in process_expressions.  SQL error shown in debug output.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'  end process_expressions; ',
'  ',
'end flow_expressions;',
'/',
'create or replace package body flow_gateways',
'as ',
'',
'  type t_new_sbfl_rec is record',
'  ( sbfl_id   flow_subflows.sbfl_id%type',
'  , route     flow_subflows.sbfl_route%type',
'  );',
'',
'  type t_new_sbfls is table of t_new_sbfl_rec;',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'  function get_gateway_route',
'    ( pi_process_id     in flow_processes.prcs_id%type',
'    , pi_objt_bpmn_id   in flow_objects.objt_bpmn_id%type',
'    ) return varchar2',
'  is',
'    l_'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'forward_route     varchar2(2000);  -- 1 route for exclusiveGateway, 1 or more for inclusive (:sep)',
'    l_bad_routes        apex_application_global.vc_arr2;',
'    l_bad_route_string  varchar2(2000) := '''';',
'    l_num_bad_routes    number := 0;',
'  begin',
'    -- check if route is in process variable',
'    l_forward_route := flow_process_vars.get_var_vc2(pi_process_id, pi_objt_bpmn_id||'':route'');',
'    if l_forward_route is not null',
'    then',
'       begin',
'        -- test routes are all valid connections before returning',
'        l_num_bad_routes := 0;',
'        for bad_routes in (',
'            select column_value as bad_route ',
'              from table(apex_string.split(l_forward_route,'':''))',
'            minus ',
'            select conn.conn_bpmn_id',
'              from flow_connections conn',
'              join flow_objects objt ',
'                on objt.objt_id = conn.conn_src_objt_id',
'              and conn.conn_dgrm_id = objt.objt_dgrm_id',
'              join flow_processes prcs',
'                on prcs.prcs_dgrm_id = conn.conn_dgrm_id',
'            where prcs.prcs_id = pi_process_id',
'              and objt.objt_bpmn_id = pi_objt_bpmn_id',
'            )',
'        loop',
'           l_num_bad_routes := l_num_bad_routes +1;',
'           l_bad_route_string := l_bad_route_string||bad_routes.bad_route||'', '';',
'        end loop;',
'        if l_num_bad_routes > 0 then',
'            apex_error.add_error( p_message => ''Error routing process flow at ''||pi_objt_bpmn_id||''. Supplied variable ''||pi_objt_bpmn_id||'':route contains invalid route: ''||l_bad_route_string',
'                         , p_display_location => apex_error.c_on_error_page) ;',
'        end if;',
'      exception',
'        when no_data_found then -- all routes good',
'          return l_forward_route',
'          ;',
'      end;',
'    else -- forward route is null -- look for default routing',
'        begin',
'            -- check default route ',
'            select conn_bpmn_id',
'              into l_forward_route',
'              from flow_connections conn',
'              join flow_objects objt ',
'                on objt.objt_id = conn.conn_src_objt_id',
'               and conn.conn_dgrm_id = objt.objt_dgrm_id',
'              join flow_processes prcs ',
'                on prcs.prcs_dgrm_id = conn.conn_dgrm_id',
'             where conn.conn_is_default = 1',
'               and objt.objt_bpmn_id = pi_objt_bpmn_id',
'               and prcs.prcs_id = pi_process_id',
'                ;',
'        exception',
'            when no_data_found then',
'                apex_error.add_error',
'                ( p_message => ''Please specify the connection ID for process variable ''||pi_objt_bpmn_id||'':route or specify a default route for the gateway.''',
'                , p_display_location => apex_error.c_on_error_page',
'                );',
'            when too_many_rows then',
'                apex_error.add_error',
'                ( p_message => ''More than one default route specified on Gateway ''||pi_objt_bpmn_id',
'                , p_display_location => apex_error.c_on_error_page',
'                );',
'        end;',
'    end if; ',
'    return l_forward_route;',
'  end get_gateway_route;',
'',
'  function gateway_merge',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    ) return varchar2 -- returns forward status ''wait'' or ''proceed''',
'  is ',
'    l_num_unfinished_subflows number;',
'    l_gateway_forward_status    varchar2(10)  := ''wait'';',
'  begin  ',
'    apex_debug.enter ',
'    ( ''gateway_merge''',
'    , ''p_sbfl_info.sbfl_current'' , p_sbfl_info.sbfl_current',
'    , ''p_step_info.target_objt_ref'' , p_step_info.target_objt_ref',
'    , ''p_sbfl_info.sbfl_last_completed'', p_sbfl_info.sbfl_last_completed',
'    );',
'    -- set current subflow to status waiting,       ',
'    update flow_subflows sbfl',
'        set sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_waiting_gateway',
'          , sbfl.sbfl_last_update = systimestamp ',
'          , sbfl.sbfl_current = p_step_info.target_objt_ref',
'      where sbfl.sbfl_id = p_subflow_id',
'        and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- check if we are waiting for other flows or can proceed',
'    select count(*)',
'      into l_num_unfinished_subflows',
'      from flow_subflows sbfl',
'      where sbfl.sbfl_prcs_id = p_process_id',
'        and sbfl.sbfl_starting_object = p_sbfl_info.sbfl_starting_object',
'        and (  sbfl.sbfl_current != p_step_info.target_objt_ref',
'            or sbfl.sbfl_status != flow_constants_pkg.gc_sbfl_status_waiting_gateway',
'            )',
'    ;',
'    if l_num_unfinished_subflows = 0 then',
'      -- all task to be merged have completed.  So we do the merge... ',
'      -- lock parent subflow first',
'      if flow_engine_util.lock_subflow(p_sbfl_info.sbfl_sbfl_id) then',
'        -- proceed from gateway, locking child subflows',
'        for completed_subflows in ( select completed_sbfl.sbfl_id',
'                                      from flow_subflows completed_sbfl ',
'                                      where completed_sbfl.sbfl_prcs_id = p_process_id',
'                                        and completed_sbfl.sbfl_starting_object = p_sbfl_info.sbfl_starting_object',
'                                        and completed_sbfl.sbfl_current = p_step_info.target_objt_ref ',
'                                        and completed_sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_waiting_gateway',
'                                        for update wait 2',
'                                  )',
'        loop',
'          flow_engine_util.subflow_complete',
'          ( p_process_id => p_process_id',
'          , p_subflow_id => completed_subflows.sbfl_id',
'          );',
'        end loop;',
'',
'        --mark parent split subflow ready to restart',
'        update flow_subflows parent_sbfl',
'            set parent_sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_proceed_gateway',
'              , parent_sbfl.sbfl_current = p_step_info.target_objt_ref',
'              , parent_sbfl.sbfl_last_update = systimestamp',
'              , parent_sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current  -- last step of final child sbfl pre-merge',
'          where parent_sbfl.sbfl_last_completed = p_sbfl_info.sbfl_starting_object',
'            and parent_sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_split  ',
'            and parent_sbfl.sbfl_id = p_sbfl_info.sbfl_sbfl_id',
'        ;',
'        -- process any after-merge expression set',
'        flow_expressions.process_expressions',
'        ( pi_objt_id     => p_step_info.target_objt_id',
'        , pi_set         => flow_constants_pkg.gc_expr_set_after_merge',
'        , pi_prcs_id     => p_process_id',
'        , pi_sbfl_id     => p_sbfl_info.sbfl_sbfl_id',
'        );',
'        -- commit tx',
'        commit;',
'        l_gateway_forward_status := ''proceed'';',
'      else ',
'        -- unable to lock parent ''split'' subflow.',
'        apex_error.add_error',
'        ( p_message => ''Unable to lock split parent subflow ''||p_subflow_id||'' before merge.  Select for update timed out''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'      end if;',
'      -- start new tx by locking parent subflow',
'      if not flow_engine_util.lock_subflow(p_sbfl_info.sbfl_sbfl_id) then',
'        -- unable to lock parent ''split'' subflow.',
'        apex_error.add_error',
'        ( p_message => ''Unable to lock split parent subflow ''||p_subflow_id||'' after merge.  Select for update timed out''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'      end if;',
'    end if; ',
'    return l_gateway_forward_status;',
'  end gateway_merge;',
'',
'  procedure gateway_split',
'    ( p_process_id     in flow_processes.prcs_id%type',
'    , p_subflow_id     in flow_subflows.sbfl_id%type',
'    , p_sbfl_info      in flow_subflows%rowtype',
'    , p_step_info      in flow_types_pkg.flow_step_info',
'    , p_gateway_routes in varchar2',
'    )',
'  is ',
'    l_new_subflows              t_new_sbfls := t_new_sbfls();',
'    l_new_subflow               t_new_sbfl_rec;',
'  begin ',
'    apex_debug.enter ',
'    ( ''gateway_split''',
'    , ''p_sbfl_info.sbfl_current'' , p_sbfl_info.sbfl_current',
'    , ''p_step_info.target_objt_ref'' , p_step_info.target_objt_ref',
'    );',
'    -- we have splitting gateway going forward',
'    -- Current Subflow into status split ',
'    update flow_subflows sbfl',
'        set sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'          , sbfl.sbfl_current = p_step_info.target_objt_ref',
'          , sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_split  ',
'          , sbfl.sbfl_last_update = systimestamp ',
'      where sbfl.sbfl_id = p_subflow_id',
'        and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- get all forward parallel paths and create subflows for them',
'    -- these are paths forward of p_step_info.target_objt_ref as we are doing double step',
'    -- create subflows in one loop then step through them again in second loop',
'    -- to prevent some subflows getting to following merge gateway before all subflows are created (causes race condition)',
'',
'    for new_path in ( select conn.conn_bpmn_id route',
'                           , ultimate_tgt_objt.objt_bpmn_id target',
'                        from flow_connections conn',
'                        join flow_objects ultimate_tgt_objt -- first object in each child',
'                          on ultimate_tgt_objt.objt_id = conn.conn_tgt_objt_id',
'                         and conn.conn_dgrm_id = ultimate_tgt_objt.objt_dgrm_id',
'                        join flow_objects objt  -- gateway object',
'                          on objt.objt_id = conn.conn_src_objt_id',
'                         and conn.conn_dgrm_id = objt.objt_dgrm_id',
'                       where conn.conn_dgrm_id = p_step_info.dgrm_id',
'                         and conn.conn_src_objt_id = p_step_info.target_objt_id',
'                         and conn.conn_tag_name = flow_constants_pkg.gc_bpmn_sequence_flow',
'                         and ( objt.objt_tag_name = flow_constants_pkg.gc_bpmn_gateway_parallel',
'                             OR ',
'                             ( objt.objt_tag_name = flow_constants_pkg.gc_bpmn_gateway_inclusive',
'                             and ',
'                               conn.conn_bpmn_id member of apex_string.split( p_gateway_routes, '':'' )',
'                             ))',
'                    )',
'    loop',
'      -- path is included in list of chosen forward paths.',
'      apex_debug.info',
'      ( p_message => ''starting parallel flow for %0''',
'      , p0        => p_step_info.target_objt_tag',
'      );',
'',
'      l_new_subflow.sbfl_id :=',
'        flow_engine_util.subflow_start',
'        ( p_process_id             => p_process_id         ',
'        , p_parent_subflow         => p_subflow_id       ',
'        , p_starting_object        => p_step_info.target_objt_ref         ',
'        , p_current_object         => p_step_info.target_objt_ref          ',
'        , p_route                  => new_path.route         ',
'        , p_last_completed         => p_sbfl_info.sbfl_current ',
'        , p_status                 => flow_constants_pkg.gc_sbfl_status_created',
'        , p_parent_sbfl_proc_level => p_sbfl_info.sbfl_process_level',
'        , p_new_proc_level         => false',
'        , p_dgrm_id                => p_sbfl_info.sbfl_dgrm_id',
'        )',
'      ;',
'      l_new_subflow.route   := new_path.route;',
'      l_new_subflows.extend;',
'      l_new_subflows (l_new_subflows.last) := l_new_subflow;',
'    end loop;',
'    -- log gateway as completed',
'    flow_logging.log_step_completion   ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_completed_object => p_step_info.target_objt_ref ',
'    );',
'    -- update parent status now split and no current object',
'     update flow_subflows sbfl',
'        set sbfl.sbfl_current = null',
'          , sbfl.sbfl_last_completed = p_step_info.target_objt_ref',
'          , sbfl.sbfl_last_update = systimestamp ',
'      where sbfl.sbfl_id = p_subflow_id',
'        and sbfl.sbfl_prcs_id = p_process_id;',
'',
'    -- commit the transaction',
'    commit;',
'    ',
'    apex_debug.info ( p_message => ''New Subflow Creation Commited'');',
'    ',
'    for new_subflow in 1.. l_new_subflows.count',
'    loop',
'      -- reset step_had_error flag',
'      flow_globals.set_step_error ( p_has_error => false);',
'      -- check subflow still exists and lock it(in case earlier loop terminated everything in level)',
'      if flow_engine_util.lock_subflow',
'        ( p_subflow_id => l_new_subflows(new_subflow).sbfl_id',
'        )',
'      then',
'        -- step into first step on the new path',
'        flow_engine.flow_complete_step    ',
'        ( p_process_id        => p_process_id',
'        , p_subflow_id        => l_new_subflows(new_subflow).sbfl_id',
'        , p_forward_route     => l_new_subflows(new_subflow).route',
'        , p_log_as_completed  => false',
'        );',
'      end if;',
'    end loop;',
'  end gateway_split;',
'',
'  procedure process_para_incl_Gateway',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    )',
'  is',
'    l_gateway_forward_status    varchar2(10);',
'    l_sbfl_id                   flow_subflows.sbfl_id%type;',
'    l_sbfl_id_sub               flow_subflows.sbfl_id%type;',
'    l_sbfl_id_par               flow_subflows.sbfl_id%type; ',
'    l_num_back_connections      number;   -- number of connections leading into object',
'    l_num_forward_connections   number;   -- number of connections forward from object',
'    l_num_unfinished_subflows   number;',
'    l_forward_routes            varchar2(2000);',
'    l_new_subflows              t_new_sbfls := t_new_sbfls();',
'    l_new_subflow               t_new_sbfl_rec;',
'  begin',
'    apex_debug.enter ',
'    ( ''process_para_incl_Gateway''',
'    , ''p_step_info.target_objt_tag'' , p_step_info.target_objt_tag',
'    , ''p_step_info.target_objt_ref'' , p_step_info.target_objt_ref',
'    );',
'    -- get number of forward and backward connections',
'    flow_engine_util.get_number_of_connections',
'    ( pi_dgrm_id => p_step_info.dgrm_id',
'    , pi_target_objt_id => p_step_info.target_objt_id',
'    , pi_conn_type => flow_constants_pkg.gc_bpmn_sequence_flow',
'    , po_num_back_connections => l_num_back_connections',
'    , po_num_forward_connections => l_num_forward_connections',
'    );',
'',
'    l_gateway_forward_status := ''proceed'';',
'    l_sbfl_id  := p_subflow_id;',
'',
'    if l_num_back_connections > 1  then',
'      apex_debug.info',
'      ( p_message => ''%0 Gateway Merging %1''',
'      , p0        => p_step_info.target_objt_tag',
'      , p1        => p_step_info.target_objt_ref',
'      );  ',
'      -- we have merging gateway.  do the merge. returns ''wait'' if flow is waiting at gateway, ''proceed'' if merged',
'      l_gateway_forward_status := gateway_merge (p_process_id, p_subflow_id, p_sbfl_info, p_step_info);',
'',
'      -- switch to parent subflow ',
'      l_sbfl_id := p_sbfl_info.sbfl_sbfl_id;',
'    end if;',
'    ',
'    -- now do forward path, if you have token to ''proceed''',
'    if l_gateway_forward_status = ''proceed'' then ',
'      if l_num_forward_connections > 1 then',
'        -- we have splitting gateway going forward',
'        apex_debug.info ',
'        ( p_message => ''%0 Gateway Splitting %1 - %2 forward paths''',
'        , p0 => p_step_info.target_objt_tag',
'        , p1 => p_step_info.target_objt_ref',
'        , p2 => l_num_forward_connections',
'        );       ',
'        -- process any before-split expression set',
'        flow_expressions.process_expressions',
'        ( pi_objt_id     => p_step_info.target_objt_id',
'        , pi_set         => flow_constants_pkg.gc_expr_set_before_split',
'        , pi_prcs_id     => p_process_id',
'        , pi_sbfl_id     => p_subflow_id',
'        );        ',
'        case p_step_info.target_objt_tag',
'        when flow_constants_pkg.gc_bpmn_gateway_inclusive then ',
'          l_forward_routes := get_gateway_route(p_process_id, p_step_info.target_objt_ref);',
'          apex_debug.info',
'          ( p_message => ''Forward routes for inclusiveGateway %0 : %1''',
'          , p0 => p_step_info.target_objt_ref',
'          , p1 => l_forward_routes',
'          );',
'        when flow_constants_pkg.gc_bpmn_gateway_parallel then ',
'          l_forward_routes := ''parallel'';  -- just needs to be some not null string',
'        end case;',
'',
'        gateway_split',
'        ( p_process_id => p_process_id',
'        , p_subflow_id => l_sbfl_id',
'        , p_sbfl_info  => p_sbfl_info',
'        , p_step_info  => p_step_info',
'        , p_gateway_routes => l_forward_routes',
'        );',
'',
'      elsif l_num_forward_connections = 1 then',
'        -- only single path going forward',
'        update  flow_subflows sbfl',
'            set sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'              , sbfl.sbfl_current = p_step_info.target_objt_ref',
'              , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'              , sbfl.sbfl_last_update = systimestamp ',
'          where sbfl.sbfl_id = l_sbfl_id',
'            and sbfl.sbfl_prcs_id = p_process_id',
'        ;',
'        -- step into first step on the new path',
'        flow_engine.flow_complete_step   ',
'        ( p_process_id => p_process_id',
'        , p_subflow_id => l_sbfl_id',
'        , p_forward_route => null',
'        );',
'      end if;  -- single path',
'    end if;  -- forward token',
'  end process_para_incl_Gateway;',
'',
'  procedure process_exclusiveGateway',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    )',
'  is ',
'    l_num_forward_connections   number;   -- number of connections forward from object',
'    l_num_back_connections      number;   -- number of connections back from object',
'    l_forward_route             varchar2(2000);',
'  begin',
'    -- handles opening and closing and closing and reopening',
'    apex_debug.enter ',
'    ( ''process_exclusiveGateway''',
'    , ''p_step_info.target_objt_tag'' , p_step_info.target_objt_tag',
'    );',
'    flow_engine_util.get_number_of_connections',
'    ( pi_dgrm_id => p_step_info.dgrm_id',
'    , pi_target_objt_id => p_step_info.target_objt_id',
'    , pi_conn_type => flow_constants_pkg.gc_bpmn_sequence_flow',
'    , po_num_back_connections => l_num_back_connections',
'    , po_num_forward_connections => l_num_forward_connections',
'    );',
'',
'    if l_num_forward_connections > 1 then',
'      -- opening gateway ',
'      -- process any before-split expression set before gateway chooses route',
'      flow_expressions.process_expressions',
'      ( pi_objt_id     => p_step_info.target_objt_id',
'      , pi_set         => flow_constants_pkg.gc_expr_set_before_split',
'      , pi_prcs_id     => p_process_id',
'      , pi_sbfl_id     => p_subflow_id',
'      );',
'      -- get choice',
'      l_forward_route := get_gateway_route(p_process_id, p_step_info.target_objt_ref);',
'    else ',
'      -- closing gateway ',
'      -- process any after-merge expression set',
'      flow_expressions.process_expressions',
'      ( pi_objt_id     => p_step_info.target_objt_id',
'      , pi_set         => flow_constants_pkg.gc_expr_set_after_merge',
'      , pi_prcs_id     => p_process_id',
'      , pi_sbfl_id     => p_subflow_id',
'      );      ',
'      -- keep going',
'      l_forward_route := null;',
'    end if;  ',
'',
'    update flow_subflows sbfl',
'        set sbfl.sbfl_current = p_step_info.target_objt_ref',
'            , sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'            , sbfl.sbfl_last_update = systimestamp',
'            , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_running',
'      where sbfl.sbfl_id = p_subflow_id',
'        and sbfl.sbfl_prcs_id = p_process_id',
'    ;  ',
'    flow_engine.flow_complete_step   ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_forward_route => l_forward_route',
'    );',
'',
'  end process_exclusiveGateway; ',
'',
'  procedure process_eventBasedGateway',
'    ( p_process_id in flow_processes.prcs_id%type',
'    , p_subflow_id in flow_subflows.sbfl_id%type',
'    , p_sbfl_info  in flow_subflows%rowtype',
'    , p_step_info  in flow_types_pkg.flow_step_info',
'    )',
'  is ',
'    l_sbfl_id_sub flow_subflows.sbfl_id%type;',
'  begin',
'    -- eventGateway can have multiple inputs and outputs, but there is no waiting, etc.',
'    -- incoming subflow continues on the first output path.',
'    -- additional output paths create new subflows',
'    apex_debug.enter',
'    (',
'      p_routine_name => ''process_EventBasedGateway''',
'    , p_name01       => ''p_step_info.target_objt_ref''',
'    , p_value01      => p_step_info.target_objt_ref',
'    );',
'    -- process any before-split expression set',
'    flow_expressions.process_expressions',
'    ( pi_objt_id     => p_step_info.target_objt_id',
'    , pi_set         => flow_constants_pkg.gc_expr_set_before_split',
'    , pi_prcs_id     => p_process_id',
'    , pi_sbfl_id     => p_subflow_id',
'    );',
'    -- mark parent flow as split',
'    update flow_subflows sbfl',
'       set sbfl.sbfl_last_completed = p_sbfl_info.sbfl_current',
'         , sbfl.sbfl_current = p_step_info.target_objt_ref',
'         , sbfl.sbfl_status =  flow_constants_pkg.gc_sbfl_status_split  ',
'         , sbfl.sbfl_last_update = systimestamp ',
'     where sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    -- log gateway as completed here so only logged once',
'    flow_logging.log_step_completion   ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_completed_object => p_step_info.target_objt_ref ',
'    );',
'    -- get all forward parallel paths and create subflows for them',
'    -- these are paths forward of p_step_info.target_objt_ref as we are doing double step',
'    for new_path in ( select conn.conn_bpmn_id route',
'                           , objt.objt_bpmn_id target',
'                        from flow_connections conn',
'                        join flow_objects objt',
'                          on objt.objt_id = conn.conn_tgt_objt_id',
'                         and conn.conn_dgrm_id = objt.objt_dgrm_id',
'                       where conn.conn_dgrm_id = p_step_info.dgrm_id',
'                         and conn.conn_tag_name = flow_constants_pkg.gc_bpmn_sequence_flow',
'                         and conn.conn_src_objt_id = p_step_info.target_objt_id',
'                    )',
'    loop',
'      -- create new subflows for forward event paths starting here',
'      l_sbfl_id_sub :=',
'        flow_engine_util.subflow_start',
'        ( ',
'          p_process_id             => p_process_id         ',
'        , p_parent_subflow         => p_subflow_id       ',
'        , p_starting_object        => p_step_info.target_objt_ref         ',
'        , p_current_object         => p_step_info.target_objt_ref          ',
'        , p_route                  => new_path.route         ',
'        , p_last_completed         => p_step_info.target_objt_ref ',
'        , p_status                 => flow_constants_pkg.gc_sbfl_status_waiting_event   ',
'        , p_parent_sbfl_proc_level => p_sbfl_info.sbfl_process_level',
'        , p_new_proc_level         => false    ',
'        , p_dgrm_id                => p_sbfl_info.sbfl_dgrm_id',
'        )',
'      ;',
'      -- step into first step on the new path',
'      flow_engine.flow_complete_step   ',
'      (',
'        p_process_id        => p_process_id',
'      , p_subflow_id        => l_sbfl_id_sub',
'      , p_forward_route     => new_path.route',
'      , p_log_as_completed  => false',
'      );',
'    end loop;',
'  end process_eventBasedGateway;',
'',
'end flow_gateways;',
'/',
'',
'create or replace package body flow_globals',
'as',
'',
'',
'  g_error_on_step  boolean;  ',
'  -- g_error_on_step starts false when every step is processed but is set true if an error',
'  -- occurs in the engine during processing.  It is then used to determine whether to ',
'  -- commit or rollback the engine transaction at the end of step processing',
'  g_is_recursive_step boolean;',
'  -- g_recursive_step is set to false for steps that are being performed by the user, and true',
'  -- for subsequent recursive steps that are performed by the engine (such as gateway steps, scriptTasks, etc.)',
'',
'',
'  procedure set_context',
'  ( pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type default null',
'  )',
'  is',
'  begin ',
'    process_id := pi_prcs_id;',
'    subflow_id := pi_sbfl_id;',
'  ',
'  end set_context;',
'',
'  procedure set_step_error',
'  ( p_has_error  in boolean default false)',
'  is',
'  begin',
'    g_error_on_step := p_has_error;',
'  end set_step_error;',
'',
'  function get_step_error return boolean',
'  is',
'  begin',
'    return g_error_on_step;',
'  end get_step_error; ',
'',
'  procedure set_is_recursive_step',
'  ( p_is_recursive_step  in boolean default false)',
'  is',
'  begin',
'    g_is_recursive_step := p_is_recursive_step;',
'  end set_is_recursive_step;',
'',
'  function get_is_recursive_step return boolean',
'  is',
'  begin',
'    return g_is_recursive_step;',
'  end get_is_recursive_step; ',
'',
'end flow_globals;',
'/',
'',
'create or replace package body flow_instances ',
'as',
'',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'',
'  function create_process',
'    ( p_dgrm_id   in flow_diagrams.dgrm_id%type',
'    , p_prcs_name in flow_processes.prcs_name%type',
'    ) return flow_processes.prcs_id%type',
'  is',
'    l_ret flow_processes.prcs_id%type;',
'  begin',
'    apex_debug.enter',
'    (''create_process''',
'    , ''dgrm_id'', p_dgrm_id',
'    , ''p_prcs_name'', p_prcs_name ',
'    );',
'    insert into flow_processes prcs',
'          ( prcs.prcs_name',
'          , prcs.prcs_dgrm_id',
'          , prcs.prcs_status',
'          , prcs.prcs_init_ts',
'          , prcs.prcs_last_update',
'          )',
'    values',
'          ( p_prcs_name',
'          , p_dgrm_id',
'          , flow_constants_pkg.gc_prcs_status_created',
'          , systimestamp',
'          , systimestamp',
'          )',
'      returning prcs.prcs_id into l_ret',
'    ;',
'    -- log the process creation',
'    flow_logging.log_instance_event',
'    ( p_process_id => l_ret',
'    , p_event      => flow_constants_pkg.gc_prcs_event_created',
'    );',
'    commit;',
'',
'    apex_debug.info',
'    ( p_message => ''Flow Instance created.  DGRM_ID : %0, PRCS_ID : %1''',
'    , p0 => p_dgrm_id',
'    , p1 => l_ret ',
'    );',
'    return l_ret;',
'  end create_process;',
'',
'  procedure start_process',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  )',
'  is',
'    l_dgrm_id               flow_diagrams.dgrm_id%type;',
'    l_process_status        flow_processes.prcs_status%type;',
'    l_objt_bpmn_id          flow_objects.objt_bpmn_id%type;',
'    l_objt_id               flow_objects.objt_id%type;',
'    l_objt_sub_tag_name     flow_objects.objt_sub_tag_name%type;',
'    l_main_subflow_id       flow_subflows.sbfl_id%type;',
'    l_new_subflow_status    flow_subflows.sbfl_status%type;',
'  begin',
'      -- l_dgrm_id := flow_engine_util.get_dgrm_id( p_prcs_id => p_process_id );',
'    apex_debug.enter',
'    (''start_process''',
'    , ''Process_ID'', p_process_id ',
'    );',
'    -- check process exists, is not running, and lock it',
'    begin',
'      select prcs.prcs_status',
'           , prcs.prcs_dgrm_id',
'        into l_process_status',
'           , l_dgrm_id',
'        from flow_processes prcs ',
'       where prcs.prcs_id = p_process_id',
'      for update wait 2',
'      ;',
'      if l_process_status != ''created'' then',
'        apex_error.add_error',
'        ( p_message => ''You tried to start a process that is already running''',
'        , p_display_location => apex_error.c_on_error_page',
'        );  ',
'      end if;',
'    exception',
'      when no_data_found then',
'        apex_error.add_error',
'        ( p_message => ''You tried to start a non-existant process.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );  ',
'      when too_many_rows then',
'        apex_error.add_error',
'        ( p_message => ''Multiple copies of the process already running''',
'        , p_display_location => apex_error.c_on_error_page',
'        );  ',
'    end;',
'    begin',
'      -- get the starting object ',
'      select objt.objt_bpmn_id',
'           , objt.objt_sub_tag_name',
'           , objt.objt_id',
'        into l_objt_bpmn_id',
'           , l_objt_sub_tag_name',
'           , l_objt_id',
'        from flow_objects objt',
'        join flow_objects parent',
'          on objt.objt_objt_id = parent.objt_id',
'       where objt.objt_dgrm_id = l_dgrm_id',
'         and parent.objt_dgrm_id = l_dgrm_id',
'         and objt.objt_tag_name = flow_constants_pkg.gc_bpmn_start_event  ',
'         and parent.objt_tag_name = flow_constants_pkg.gc_bpmn_process',
'      ;',
'    exception',
'      when too_many_rows then',
'        apex_error.add_error',
'        ( p_message => ''You have multiple starting events defined. Make sure your diagram has only one starting event.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'      when no_data_found then',
'        apex_error.add_error',
'        ( p_message => ''No starting event was defined.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    end;',
'    apex_debug.info',
'    ( p_message => ''Found starting object %0''',
'    , p0 =>l_objt_bpmn_id',
'    );',
'    -- mark process as running',
'    update flow_processes prcs',
'       set prcs.prcs_status = flow_constants_pkg.gc_prcs_status_running',
'         , prcs.prcs_last_update = systimestamp',
'     where prcs.prcs_dgrm_id = l_dgrm_id',
'       and prcs.prcs_id = p_process_id',
'         ;    ',
'    -- log the start',
'    flow_logging.log_instance_event',
'    ( p_process_id => p_process_id',
'    , p_event      => flow_constants_pkg.gc_prcs_event_started',
'    );',
'    -- check if start has a timer?  ',
'    if l_objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition then ',
'      l_new_subflow_status := flow_constants_pkg.gc_sbfl_status_waiting_timer;',
'    else',
'      l_new_subflow_status := flow_constants_pkg.gc_sbfl_status_running;',
'    end if;',
'',
'    l_main_subflow_id := flow_engine_util.subflow_start ',
'      ( p_process_id => p_process_id',
'      , p_parent_subflow => null',
'      , p_starting_object => l_objt_bpmn_id',
'      , p_current_object => l_objt_bpmn_id',
'      , p_route => ''main''',
'      , p_last_completed => null',
'      , p_status => l_new_subflow_status ',
'      , p_parent_sbfl_proc_level => 0 ',
'      , p_new_proc_level => false',
'      , p_dgrm_id => l_dgrm_id',
'      );',
'',
'    apex_debug.info',
'    ( p_message => ''Initial Subflow created %0''',
'    , p0 => l_main_subflow_id',
'    );',
'    -- process any variable expressions on the starting object',
'    flow_expressions.process_expressions',
'    ( pi_objt_id     => l_objt_id',
'    , pi_set         => flow_constants_pkg.gc_expr_set_before_event',
'    , pi_prcs_id     => p_process_id',
'    , pi_sbfl_id     => l_main_su'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'bflow_id',
'    );',
'    -- commit the subflow creation',
'    commit;',
'    -- check startEvent sub type for timer or (later releases) other sub types',
'    if l_objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition then ',
'      -- eventStart must be delayed with the timer ',
'      flow_timers_pkg.start_timer',
'      (',
'        pi_prcs_id => p_process_id',
'      , pi_sbfl_id => l_main_subflow_id',
'      );',
'    elsif l_objt_sub_tag_name is null then',
'      -- plain startEvent',
'      -- process any variable expressions on the starting object',
'      flow_expressions.process_expressions',
'      ( pi_objt_id     => l_objt_id',
'      , pi_set         => flow_constants_pkg.gc_expr_set_on_event',
'      , pi_prcs_id     => p_process_id',
'      , pi_sbfl_id     => l_main_subflow_id',
'      );',
'        -- step into first step',
'      flow_engine.flow_complete_step  ',
'      ( p_process_id => p_process_id',
'      , p_subflow_id => l_main_subflow_id',
'      , p_forward_route => null',
'      );',
'    else ',
'      apex_error.add_error',
'      ( p_message => ''You have an unsupported starting event type. Only None (standard) Start Event and Timer Start Event are currently supported.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    end if;',
'  end start_process;',
'',
'  procedure reset_process',
'    ( p_process_id  in flow_processes.prcs_id%type',
'    , p_comment     in flow_instance_event_log.lgpr_comment%type default null',
'    )',
'  is',
'    l_return_code   number;',
'    cursor c_lock_all is ',
'        select prcs.prcs_id, sbfl.sbfl_id, sflg.sflg_last_updated',
'          from flow_subflows sbfl',
'          join flow_processes prcs',
'            on prcs.prcs_id = sbfl.sbfl_prcs_id ',
'          join flow_subflow_log sflg ',
'            on prcs.prcs_id = sflg.sflg_prcs_id',
'          where prcs.prcs_id = p_process_id',
'          order by sbfl.sbfl_process_level, sbfl.sbfl_id',
'            for update of prcs.prcs_id, sbfl.sbfl_id, sflg.sflg_last_updated wait 2',
'    ;',
'  begin',
'    apex_debug.enter',
'    ( ''reset_process''',
'    , ''process_id'', p_process_id',
'    );',
'    -- lock all objects',
'    begin',
'      open c_lock_all;',
'      flow_timers_pkg.lock_process_timers',
'      ( pi_prcs_id => p_process_id',
'      );  ',
'      close c_lock_all;',
'    exception ',
'      when lock_timeout then',
'      apex_error.add_error',
'      ( p_message => ''Process objects for ''||p_process_id||'' currently locked by another user.  Try to reset later.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    end;',
'',
'    -- kill any timers sill running in the process',
'    flow_timers_pkg.terminate_process_timers',
'    ( pi_prcs_id => p_process_id',
'    , po_return_code => l_return_code',
'    );  ',
'',
'    -- clear out run-time object_log',
'',
'    delete',
'      from flow_subflow_log sflg ',
'     where sflg_prcs_id = p_process_id',
'    ;',
'    ',
'    -- delete the subflows',
'    delete',
'      from flow_subflows sbfl',
'     where sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'    ',
'    -- delete all process variables except the builtins (new behaviour in 21.1)',
'    flow_process_vars.delete_all_for_process ',
'    ( pi_prcs_id => p_process_id',
'    , pi_retain_builtins => true',
'    );',
'',
'    update flow_processes prcs',
'       set prcs.prcs_last_update = systimestamp',
'         , prcs.prcs_status = flow_constants_pkg.gc_prcs_status_created',
'     where prcs.prcs_id = p_process_id',
'    ;',
'    -- log the reset',
'    flow_logging.log_instance_event',
'    ( p_process_id => p_process_id',
'    , p_event      => flow_constants_pkg.gc_prcs_event_reset',
'    , p_comment    => p_comment',
'    );',
'    commit;',
'  end reset_process;',
'',
'  procedure terminate_process',
'    (',
'      p_process_id  in flow_processes.prcs_id%type',
'    , p_comment     in flow_instance_event_log.lgpr_comment%type default null',
'    )',
'  is',
'    l_return_code   number;',
'    cursor c_lock_all is ',
'      select prcs.prcs_id, sbfl.sbfl_id, sflg.sflg_last_updated',
'        from flow_subflows sbfl',
'        join flow_processes prcs',
'          on prcs.prcs_id = sbfl.sbfl_prcs_id ',
'        join flow_subflow_log sflg ',
'          on prcs.prcs_id = sflg.sflg_prcs_id',
'       where prcs.prcs_id = p_process_id',
'       order by sbfl.sbfl_process_level, sbfl.sbfl_id',
'         for update of prcs.prcs_id, sbfl.sbfl_id, sflg.sflg_last_updated wait 2;',
'  begin',
'    apex_debug.enter',
'    ( ''terminate_process''',
'    , ''process_id'', p_process_id',
'    );',
'    begin ',
'      -- lock all timers, logs, subflows and the process.  ',
'      open c_lock_all;',
'      flow_timers_pkg.lock_process_timers',
'      ( pi_prcs_id => p_process_id',
'      ); ',
'      close c_lock_all; ',
'',
'    exception ',
'      when lock_timeout then',
'        apex_error.add_error',
'        ( p_message => ''Process objects for ''||p_process_id||'' currently locked by another user.  Try again later.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    end;',
'',
'    -- kill any timers sill running in the process',
'    flow_timers_pkg.delete_process_timers',
'    (',
'        pi_prcs_id => p_process_id',
'      , po_return_code => l_return_code',
'    );  ',
'    -- stop processing ',
'    flow_engine_util.terminate_level',
'    ( p_process_id => p_process_id',
'    , p_process_level => 0',
'    );',
'    apex_debug.info',
'    ( p_message => ''Flow Instance %0 terminated''',
'    , p0        => p_process_id',
'    );',
'    -- mark process as terminated',
'    update flow_processes prcs',
'       set prcs.prcs_status = flow_constants_pkg.gc_prcs_status_terminated',
'         , prcs.prcs_last_update = systimestamp',
'     where prcs.prcs_id = p_process_id',
'    ; ',
'    -- log termination',
'    flow_logging.log_instance_event',
'    ( p_process_id => p_process_id',
'    , p_event      => flow_constants_pkg.gc_prcs_event_terminated',
'    , p_comment    => p_comment',
'    );',
'    -- finalize',
'    commit;',
'  end terminate_process;',
'',
'  procedure delete_process',
'    (',
'      p_process_id  in flow_processes.prcs_id%type',
'    , p_comment     in flow_instance_event_log.lgpr_comment%type default null',
'    )',
'  is',
'    l_return_code   number;',
'    cursor c_lock_all is ',
'      select prcs.prcs_id, sbfl.sbfl_id, sflg.sflg_last_updated',
'        from flow_subflows sbfl',
'        join flow_processes prcs',
'          on prcs.prcs_id = sbfl.sbfl_prcs_id ',
'        join flow_subflow_log sflg ',
'          on prcs.prcs_id = sflg.sflg_prcs_id',
'       where prcs.prcs_id = p_process_id',
'       order by sbfl.sbfl_process_level, sbfl.sbfl_id',
'         for update of prcs.prcs_id, sbfl.sbfl_id, sflg.sflg_last_updated wait 2;',
'  begin',
'    apex_debug.enter',
'    ( ''delete_process''',
'    , ''process_id'', p_process_id',
'    );',
'    begin ',
'      -- lock all timers, logs, subflows and the process',
'      open c_lock_all;',
'      flow_timers_pkg.lock_process_timers',
'      ( pi_prcs_id => p_process_id',
'      ); ',
'      close c_lock_all; ',
'',
'    exception ',
'      when lock_timeout then',
'        apex_error.add_error',
'        ( p_message => ''Process objects for ''||p_process_id||'' currently locked by another user.  Try again later.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    end;',
'    -- log the deletion before process data deleted',
'    flow_logging.log_instance_event',
'    ( p_process_id => p_process_id',
'    , p_event      => flow_constants_pkg.gc_prcs_event_deleted',
'    , p_comment    => p_comment',
'    );',
'    -- kill any timers sill running in the process',
'    flow_timers_pkg.delete_process_timers(',
'        pi_prcs_id => p_process_id',
'      , po_return_code => l_return_code',
'    );  ',
'    -- clear out run-time object_log',
'',
'    delete',
'      from flow_subflow_log sflg ',
'     where sflg_prcs_id = p_process_id',
'    ;',
'    ',
'    delete',
'      from flow_subflows sbfl',
'     where sbfl.sbfl_prcs_id = p_process_id',
'    ;',
'',
'    flow_process_vars.delete_all_for_process ',
'    ( pi_prcs_id => p_process_id',
'    , pi_retain_builtins => false',
'    );',
'    ',
'    delete',
'      from flow_processes prcs',
'     where prcs.prcs_id = p_process_id',
'    ;',
'',
'    commit;',
'  end delete_process;',
'',
'end flow_instances;',
'/',
'',
'create or replace package body flow_logging',
'as',
'',
'  g_logging_level           flow_configuration.cfig_value%type; ',
'  g_logging_hide_userid     flow_configuration.cfig_value%type;',
'',
'  procedure log_instance_event',
'  ( p_process_id        in flow_subflow_log.sflg_prcs_id%type',
'  , p_event             in flow_instance_event_log.lgpr_prcs_event%type ',
'  , p_comment           in flow_instance_event_log.lgpr_comment%type default null',
'  , p_error_info        in flow_instance_event_log.lgpr_error_info%type default null',
'  )',
'  is ',
'  begin ',
'    if g_logging_level in ( flow_constants_pkg.gc_config_logging_level_standard ',
'                          , flow_constants_pkg.gc_config_logging_level_secure',
'                          , flow_constants_pkg.gc_config_logging_level_full',
'                          ) ',
'    then',
'      insert into flow_instance_event_log',
'      ( lgpr_prcs_id ',
'      , lgpr_dgrm_id ',
'      , lgpr_prcs_name ',
'      , lgpr_business_id',
'      , lgpr_prcs_event',
'      , lgpr_timestamp ',
'      , lgpr_user ',
'      , lgpr_comment',
'      , lgpr_error_info',
'      )',
'      select prcs.prcs_id',
'          , prcs.prcs_dgrm_id',
'          , prcs.prcs_name',
'          , flow_process_vars.get_business_ref (p_process_id)  --- ',
'          , p_event',
'          , systimestamp ',
'          , coalesce ( sys_context(''apex$session'',''app_user'') ',
'                      , sys_context(''userenv'',''os_user'')',
'                      , sys_context(''userenv'',''session_user'')',
'                      )  --- check this is complete',
'          , p_comment',
'          , p_error_info',
'        from flow_processes prcs ',
'      where prcs.prcs_id = p_process_id',
'      ;',
'    end if;',
'  exception',
'    when others then',
'      apex_error.add_error',
'      ( p_message => ''Flows - Internal error logging instance event''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'      raise;',
'  end log_instance_event;',
'',
'  procedure log_step_completion',
'  ( p_process_id        in flow_subflow_log.sflg_prcs_id%type',
'  , p_subflow_id        in flow_subflow_log.sflg_sbfl_id%type',
'  , p_completed_object  in flow_subflow_log.sflg_objt_id%type',
'  , p_notes             in flow_subflow_log.sflg_notes%type default null',
'  )',
'  is ',
'  begin',
'    -- current instance status / progress logging',
'    insert into flow_subflow_log sflg',
'    ( sflg_prcs_id',
'    , sflg_objt_id',
'    , sflg_sbfl_id',
'    , sflg_last_updated',
'    , sflg_notes',
'    )',
'    values ',
'    ( p_process_id',
'    , p_completed_object',
'    , p_subflow_id',
'    , sysdate',
'    , p_notes',
'    );',
'    -- system event logging',
'    if g_logging_level in ( flow_constants_pkg.gc_config_logging_level_standard ',
'                          , flow_constants_pkg.gc_config_logging_level_secure',
'                          , flow_constants_pkg.gc_config_logging_level_full',
'                          ) ',
'    then',
'      insert into flow_subflow_event_log',
'      ( lgsf_prcs_id ',
'      , lgsf_objt_id ',
'      , lgsf_sbfl_id ',
'      , lgsf_sbfl_process_level',
'      , lgsf_last_completed',
'      , lgsf_status_when_complete',
'      , lgsf_sbfl_dgrm_id',
'      , lgsf_was_current ',
'      , lgsf_started ',
'      , lgsf_completed',
'      , lgsf_reservation',
'      , lgsf_user',
'      , lgsf_comment',
'      )',
'      select sbfl.sbfl_prcs_id',
'           , p_completed_object',
'           , sbfl.sbfl_id',
'           , sbfl.sbfl_process_level',
'           , sbfl.sbfl_last_completed',
'           , sbfl.sbfl_status',
'           , sbfl.sbfl_dgrm_id',
'           , sbfl.sbfl_became_current',
'           , sbfl.sbfl_work_started',
'           , systimestamp',
'           , sbfl.sbfl_reservation',
'           , coalesce ( sys_context(''apex$session'',''app_user'') ',
'                      , sys_context(''userenv'',''os_user'')',
'                      , sys_context(''userenv'',''session_user'')',
'                      )  --- check this is complete',
'           , p_notes        ',
'        from flow_subflows sbfl ',
'       where sbfl.sbfl_id = p_subflow_id',
'      ;',
'    end if;',
'  exception',
'    when others then',
'      apex_error.add_error',
'      ( p_message => ''Flows - Internal error logging step completion''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'      raise;',
'  end log_step_completion;',
'',
'  procedure log_variable_event -- logs process variable set events',
'  ( p_process_id        in flow_subflow_log.sflg_prcs_id%type',
'  , p_var_name          in flow_process_variables.prov_var_name%type',
'  , p_objt_bpmn_id      in flow_objects.objt_bpmn_id%type default null',
'  , p_subflow_id        in flow_subflow_log.sflg_sbfl_id%type default null',
'  , p_expr_set          in flow_object_expressions.expr_set%type default null',
'  , p_var_type          in flow_process_variables.prov_var_type%type',
'  , p_var_vc2           in flow_process_variables.prov_var_vc2%type default null',
'  , p_var_num           in flow_process_variables.prov_var_num%type default null',
'  , p_var_date          in flow_process_variables.prov_var_date%type default null',
'  , p_var_clob          in flow_process_variables.prov_var_clob%type default null',
'  )',
'  as ',
'  begin ',
'    if g_logging_level in (  flow_constants_pkg.gc_config_logging_level_full ) then',
'      insert into flow_variable_event_log',
'      ( lgvr_prcs_id  ',
'      , lgvr_var_name	  ',
'      , lgvr_objt_id	  ',
'      , lgvr_sbfl_id	  ',
'      , lgvr_expr_set	  ',
'      , lgvr_timestamp  ',
'      , lgvr_var_type	  ',
'      , lgvr_var_vc2 	  ',
'      , lgvr_var_num  ',
'      , lgvr_var_date   ',
'      , lgvr_var_clob   ',
'      )',
'      values',
'      ( p_process_id',
'      , p_var_name          ',
'      , p_objt_bpmn_id    ',
'      , p_subflow_id ',
'      , p_expr_set ',
'      , systimestamp',
'      , p_var_type ',
'      , p_var_vc2 ',
'      , p_var_num  ',
'      , p_var_date ',
'      , p_var_clob  ',
'      );',
'    end if;',
'  exception',
'    when others then',
'      apex_error.add_error',
'      ( p_message => ''Flows - Internal error logging step completion''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'      raise;',
'  end log_variable_event;',
'',
'  -- initialize logging parameters',
'',
'  begin ',
'    g_logging_level := flow_engine_util.get_config_value',
'                       ( p_config_key => flow_constants_pkg.gc_config_logging_level',
'                       , p_default_value => flow_constants_pkg.gc_config_default_logging_level',
'                       );',
'    g_logging_hide_userid := flow_engine_util.get_config_value',
'                       ( p_config_key => flow_constants_pkg.gc_config_logging_hide_userid ',
'                       , p_default_value => flow_constants_pkg.gc_config_default_logging_hide_userid ',
'                       );',
'  ',
'    apex_debug.message ( p_message  => ''Logging level: %0''',
'                       , p0         => g_logging_level',
'                       , p_level    => 4 ',
'                       );',
'end flow_logging;',
'/',
'',
'create or replace package body flow_plsql_runner_pkg',
'as',
'',
'  g_current_prcs_id flow_processes.prcs_id%type;',
'  g_current_sbfl_id flow_subflows.sbfl_id%type;',
'',
'  procedure init_globals',
'  (',
'    pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type',
'  )',
'  as',
'  begin',
'    g_current_prcs_id := pi_prcs_id;',
'    g_current_sbfl_id := pi_sbfl_id;',
'  end init_globals;',
'',
'  function get_current_prcs_id',
'    return flow_processes.prcs_id%type',
'  as',
'  begin',
'    return flow_globals.process_id;',
'  end get_current_prcs_id;',
'',
'  function get_current_sbfl_id',
'    return flow_subflows.sbfl_id%type',
'  as',
'  begin',
'    return flow_globals.subflow_id;',
'  end get_current_sbfl_id;',
'',
'  procedure execute_plsql',
'  (',
'    p_plsql_code in varchar2',
'  )',
'  as',
'  begin',
'    apex_debug.enter ',
'    (''execute_plsql''',
'    , ''p_plsql_code'', p_plsql_code',
'    );',
'    -- Always wrap code into begin..end',
'    -- Developers are allowed to omit those if no declaration section needed',
'',
'    execute immediate',
'      ''begin'' || apex_application.lf ||',
'      p_plsql_code || apex_application.lf ||',
'      ''end;''',
'    ;',
'  end execute_plsql;',
'',
'  procedure run_task_script',
'  (',
'    pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type',
'  , pi_objt_id in flow_objects.objt_id%type',
'  )',
'  as',
'    l_use_apex_exec boolean := false;',
'    l_plsql_code    flow_object_attributes.obat_vc_value%type;',
'    l_do_autobind   boolean := false;',
'',
'    l_sql_parameters apex_exec.t_parameters;',
'  begin',
'    apex_debug.enter ',
'    ( ''run_task_script''',
'    , ''pi_objt_id'', pi_objt_id',
'    );',
'',
'    --init_globals( pi_prcs_id => pi_prcs_id, pi_sbfl_id => pi_sbfl_id );',
'    flow_globals.set_context ',
'    ( pi_prcs_id => pi_prcs_id',
'    , pi_sbfl_id => pi_sbfl_id ',
'    );',
'',
'    for rec in ( select obat.obat_key',
'                      , obat.obat_vc_value',
'                   from flow_object_attributes obat',
'                  where obat.obat_objt_id = pi_objt_id',
'                    and obat.obat_key in ( flow_constants_pkg.gc_apex_scripttask_engine',
'                                         , flow_constants_pkg.gc_apex_scripttask_plsql_code',
'                                         , flow_constants_pkg.gc_apex_scripttask_auto_binds',
'                                         )',
'               )',
'    loop',
'      case rec.obat_key',
'        when flow_constants_pkg.gc_apex_scripttask_engine then',
'          l_use_apex_exec := ( rec.obat_vc_value = flow_constants_pkg.gc_vcbool_true );',
'        when flow_constants_pkg.gc_apex_scripttask_plsql_code then',
'          l_plsql_code := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_apex_scripttask_auto_binds then',
'          l_do_autobind := ( rec.obat_vc_value = flow_constants_pkg.gc_vcbool_true );',
'        else',
'          null;',
'      end case;',
'    end loop;',
'',
'    if l_use_apex_exec then',
'      apex_exec.execute_plsql',
'      (',
'        p_plsql_code      => l_plsql_code',
'      , p_auto_bind_items => l_do_autobind',
'      , p_sql_parameters  => l_sql_parameters',
'      );',
'    else',
'      execute_plsql',
'      (',
'        p_plsql_code => l_plsql_code',
'      );',
'    end if;',
'',
'  exception',
'    when e_plsql_script_requested_stop then ',
'      apex_debug.error',
'      (',
'        p_message => ''User script run by flow_plsql_runner_pkg.run_task_script requested stop.''',
'      , p0        => sqlerrm',
'      );',
'      /*apex_error.add_error',
'      (',
'        p_message          => ''User script run by flow_plsql_runner_pkg.run_task_script requested stop.''',
'      , p_display_location => apex_error.c_inline_in_notification',
'      );*/',
'      raise e_plsql_script_requested_stop;     ',
'    when others then',
'      apex_debug.error',
'      (',
'        p_message => ''Error during flow_plsql_runner_pkg.run_task_script. SQLERRM: %s''',
'      , p0        => sqlerrm',
'      );',
' /*     apex_error.add_error',
'      (',
'        p_message          => ''An error occured while processing user-defined PL/SQL. This is typically caused by an error in the given code.''',
'      , p_display_location => apex_error.c_inline_in_notification',
'      ); */',
'      raise e_plsql_script_failed;',
'  end run_task_script;',
'',
'end flow_plsql_runner_pkg;',
'/',
'',
'create or replace package body flow_process_vars',
'as',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'procedure set_var',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_vc2_value in flow_process_variables.prov_var_vc2%type',
', pi_sbfl_id in flow_subflows.sbfl_id%type default null',
', pi_objt_bpmn_id in flow_objects.objt_bpmn_id%type default null ',
', pi_expr_set in flow_object_expressions.expr_set%type default null',
')',
'is ',
'  l_action  varchar2(20);',
'begin',
'  begin',
'      insert into flow_process_variables ',
'      ( prov_prcs_id',
'      , prov_var_name',
'      , prov_var_type',
'      , prov_var_vc2',
'      ) values',
'      ( pi_prcs_id',
'      , pi_var_name',
'      , flow_constants_pkg.gc_prov_var_type_varchar2 ',
'      , pi_vc2_value',
'      );      ',
'  exception',
'    when dup_val_on_index then',
'      l_action := ''updating'';',
'      update flow_process_variables prov ',
'         set prov.prov_var_vc2 = pi_vc2_value',
'       where prov.prov_prcs_id = pi_prcs_id',
'         and prov.prov_var_name = pi_var_name',
'         and prov.prov_var_type = flow_constants_pkg.gc_prov_var_type_varchar2 ',
'           ;',
'    when others',
'    then',
'      l_action := ''creating'';',
'      raise;',
'  end;',
'  flow_logging.log_variable_event',
'  ( p_process_id        => pi_prcs_id',
'  , p_var_name          => pi_var_name',
'  , p_objt_bpmn_id      => pi_objt_bpmn_id',
'  , p_subflow_id        => pi_sbfl_id',
'  , p_expr_set          => pi_expr_set',
'  , p_var_type          => flow_constants_pkg.gc_prov_var_type_varchar2 ',
'  , p_var_vc2           => pi_vc2_value',
'  );',
'exception',
'  when others',
'  then',
'    apex_error.add_error',
'    ( p_message => ''Error ''||l_action||'' process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||''.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'end set_var;',
'',
'procedure set_var',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_num_value in flow_process_variables.prov_var_num%type',
', pi_sbfl_id in flow_subflows.sbfl_id%type default null',
', pi_objt_bpmn_id in flow_objects.objt_bpmn_id%type default null ',
', pi_expr_set in flow_object_expressions.expr_set%type default null',
')',
'is ',
'  l_action  varchar2(20);',
'begin ',
'  begin',
'      insert into flow_process_variables ',
'      ( prov_prcs_id',
'      , prov_var_name',
'      , prov_var_type',
'      , prov_var_num',
'      ) values',
'      ( pi_prcs_id',
'      , pi_var_name',
'      , flow_constants_pkg.gc_prov_var_type_number',
'      , pi_num_value',
'      );',
'  exception',
'    when dup_val_on_index then',
'      l_action := ''updating'';',
'      update flow_process_variables prov ',
'         set prov.prov_var_num = pi_num_value',
'       where prov.prov_prcs_id = pi_prcs_id',
'         and prov.prov_var_name = pi_var_name',
'         and prov.prov_var_type = flow_constants_pkg.gc_prov_var_type_number',
'           ;',
'    when others',
'    then',
'      l_action := ''creating'';',
'      raise;',
'  end;',
'  flow_logging.log_variable_event',
'  ( p_process_id        => pi_prcs_id',
'  , p_var_name          => pi_var_name',
'  , p_objt_bpmn_id      => pi_objt_bpmn_id',
'  , p_subflow_id        => pi_sbfl_id',
'  , p_expr_set          => pi_expr_set',
'  , p_var_type          => flow_constants_pkg.gc_prov_var_type_number',
'  , p_var_num           => pi_num_value',
'  );',
'exception',
'  when others',
'  then',
'    apex_error.add_error',
'    ( p_message => ''Error ''||l_action||'' process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||''.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'end set_var;',
'',
'procedure set_var',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_date_value in flow_process_variables.prov_var_date%type',
', pi_sbfl_id in flow_subflows.sbfl_id%type default null',
', pi_objt_bpmn_id in flow_objects.objt_bpmn_id%type default null ',
', pi_expr_set in flow_object_expressions.expr_set%type default null',
')',
'is ',
'  l_action  varchar2(20);',
'begin ',
'  begin',
'      insert into flow_process_variables ',
'      ( prov_prcs_id',
'      , prov_var_name',
'      , prov_var_type',
'      , prov_var_date',
'      ) values',
'      ( pi_prcs_id',
'      , pi_var_name',
'      , flow_constants_pkg.gc_prov_var_type_date',
'      , pi_date_value',
'      );',
'  exception',
'    when dup_val_on_index then',
'      l_action := ''updating'';',
'      update flow_process_variables prov ',
'         set prov.prov_var_date = pi_date_value',
'       where prov.prov_prcs_id = pi_prcs_id',
'         and prov.prov_var_name = pi_var_name',
'         and prov.prov_var_type = flow_constants_pkg.gc_prov_var_type_date',
'           ;',
'    when others',
'    then',
'      l_action := ''creating'';',
'      raise;',
'  end;',
'  flow_logging.log_variable_event',
'  ( p_process_id        => pi_prcs_id',
'  , p_var_name          => pi_var_name',
'  , p_objt_bpmn_id      => pi_objt_bpmn_id',
'  , p_subflow_id        => pi_sbfl_id',
'  , p_expr_set          => pi_expr_set',
'  , p_var_type          => flow_constants_pkg.gc_prov_var_type_date ',
'  , p_var_date          => pi_date_value',
'  );',
'exception',
'  when others',
'  then',
'    apex_error.add_error',
'    ( p_message => ''Error ''||l_action||'' process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||''.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'end set_var;',
'',
'procedure set_var',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_clob_value in flow_process_variables.prov_var_clob%type',
', pi_sbfl_id in flow_subflows.sbfl_id%type default null',
', pi_objt_bpmn_id in flow_objects.objt_bpmn_id%type default null ',
', pi_expr_set in flow_object_expressions.expr_set%type default null',
')',
'is ',
'  l_action  varchar2(20);',
'begin ',
'  begin',
'      insert into flow_process_variables ',
'      ( prov_prcs_id',
'      , prov_var_name',
'      , prov_var_type',
'      , prov_var_clob',
'      ) values',
'      ( pi_prcs_id',
'      , pi_var_name',
'      , flow_constants_pkg.gc_prov_var_type_clob',
'      , pi_clob_value',
'      );',
'  exception',
'    when dup_val_on_index then',
'      update flow_process_variables prov ',
'         set prov.prov_var_clob = pi_clob_value',
'       where prov.prov_prcs_id = pi_prcs_id',
'         and prov.prov_var_name = pi_var_name',
'         and prov.prov_var_type = flow_constants_pkg.gc_prov_var_type_clob',
'           ;',
'    when others',
'    then',
'      l_action := ''creating'';',
'      raise;',
'  end;',
'  flow_logging.log_variable_event',
'  ( p_process_id        => pi_prcs_id',
'  , p_var_name          => pi_var_name',
'  , p_objt_bpmn_id      => pi_objt_bpmn_id',
'  , p_subflow_id        => pi_sbfl_id',
'  , p_expr_set          => pi_expr_set',
'  , p_var_type          => flow_constants_pkg.gc_prov_var_type_clob ',
'  , p_var_clob           => pi_clob_value',
'  );',
'exception',
'  when others',
'  then',
'    apex_error.add_error',
'    ( p_message => ''Error ''||l_action||'' process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||''.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'end set_var;',
'',
'-- getters return',
'',
'function get_var_vc2',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_exception_on_null in boolean default false',
') return flow_process_variables.prov_var_vc2%type',
'is ',
'   po_vc2_value  flow_process_variables.prov_var_vc2%type;',
'begin ',
'   select prov.prov_var_vc2',
'     into po_vc2_value',
'     from flow_process_variables prov',
'    where prov.prov_prcs_id = pi_prcs_id',
'      and prov.prov_var_name = pi_var_name',
'        ;',
'   return po_vc2_value;',
'exception',
'  when no_data_found then',
'    if pi_exception_on_null then',
'      apex_error.add_error',
'      ( p_message => ''Process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    else',
'      return null;',
'    end if;',
'end get_var_vc2;',
'',
'function get_var_num',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_exception_on_null in boolean default false',
') return flow_process_variables.prov_var_num%type',
'is ',
'   po_num_value  flow_process_variables.prov_var_num%type;',
'begin ',
'   select prov.prov_var_num',
'     into po_num_value',
'     from flow_process_variables prov',
'    where prov.prov_prcs_id = pi_prcs_id',
'      and prov.prov_var_name = pi_var_name',
'        ;',
'   return po_num_value;',
'exception',
'  when no_data_found then',
'    if pi_exception_on_null then',
'      apex_error.add_error',
'      ( p_message => ''Process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    else',
'      return null;',
'    end if;',
'end get_var_num;',
'',
'function get_var_date',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_exception_on_null in boolean default false',
') return flow_process_variables.prov_var_date%type',
'is ',
'   po_date_value  flow_process_variables.prov_var_date%type;',
'begin ',
'   select prov.prov_var_date',
'     into po_date_value',
'     from flow_process_variables prov',
'    where prov.prov_prcs_id = pi_prcs_id',
'      and prov.prov_var_name = pi_var_name',
'        ;',
'   return po_date_value;',
'exception',
'  when no_data_found then',
'    if pi_exception_on_null then',
'      apex_error.add_error',
'      ( p_message => ''Process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    else',
'      return null;',
'    end if;',
'end get_var_date;',
'',
'function get_var_clob',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
', pi_exception_on_null in boolean default false',
') return flow_process_variables.prov_var_clob%type',
'is ',
'   po_clob_value  flow_process_variables.prov_var_clob%type;',
'begin ',
'   select prov.prov_var_clob',
'     into po_clob_value',
'     from flow_process_variables prov',
'    where prov.prov_prcs_id = pi_prcs_id',
'      and prov.prov_var_name = pi_var_name',
'        ;',
'   return po_clob_value;',
'exception',
'  when no_data_found then',
'    if pi_exception_on_null then',
'      apex_error.add_error',
'      ( p_message => ''Process variable ''||pi_var_name||'' for process id ''||pi_prcs_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    else',
'      return null;',
'    end if;',
'end get_var_clob;',
'',
'-- delete a variable',
'',
'procedure delete_var ',
'( pi_prcs_id in flow_processes.prcs_id%type',
', pi_var_name in flow_process_variables.prov_var_name%type',
')',
'is',
'  l_var_type   flow_process_variables.prov_var_type%type;',
'begin ',
'  select prov_var_type',
'    into l_var_type',
'    from flow_process_variables prov',
'   where prov.prov_prcs_id = pi_prcs_id',
'     and prov.prov_var_name = pi_var_name',
'     for update wait 2;',
'',
'  delete ',
'    from flow_process_variables prov',
'   where prov.prov_prcs_id = pi_prcs_id',
'     and prov.prov_var_name = pi_var_name',
'  ;',
'  flow_logging.log_variable_event',
'  ( p_process_id        => pi_prcs_id',
'  , p_var_name          => pi_var_name',
'  , p_var_type          => l_var_type',
'  );',
'exception',
'  when  no_data_found then',
'      apex_error.add_error',
'      ( p_message          => ''Process variable ''||pi_var_name||'' in process ''||pi_prcs_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'  when lock_timeout then',
'    apex_error.add_error',
'    ( p_message => ''Process variable ''||pi_var_name||'' in process ''||pi_prcs_id||'' already locked by another user. Try to start your task later.''',
'    , p_display_location => apex_error.c_on_error_page',
'    )'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
';',
'end delete_var;',
'',
'-- special cases / built-in standard variables',
'',
'  function get_business_ref',
'  ( pi_prcs_id in flow_processes.prcs_id%type',
'  )',
'  return flow_process_variables.prov_var_vc2%type',
'  is ',
'  begin',
'    return get_var_vc2 ',
'           ( pi_prcs_id => pi_prcs_id',
'           , pi_var_name => flow_constants_pkg.gc_prov_builtin_business_ref',
'           );',
'  end get_business_ref;',
'',
'-- group delete for all vars in a process (used at process deletion, process reset)',
'',
'  procedure delete_all_for_process',
'  ( pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_retain_builtins in boolean default false',
'  )',
'  is',
'  begin',
'    if pi_retain_builtins then ',
'      delete from flow_process_variables prov',
'      where prov.prov_prcs_id = pi_prcs_id',
'        and prov.prov_var_name not in ( flow_constants_pkg.gc_prov_builtin_business_ref )',
'      ;',
'    else',
'      delete from flow_process_variables prov',
'      where prov.prov_prcs_id = pi_prcs_id;',
'    end if;',
'  end delete_all_for_process;',
'',
'  procedure do_substitution',
'  (',
'    pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type',
'  , pio_string in out nocopy varchar2',
'  )',
'  as',
'    l_f4a_substitutions apex_t_varchar2;',
'    l_replacement_value flow_types_pkg.t_bpmn_attribute_vc2;',
'  ',
'    function get_replacement_pattern',
'    (',
'      pi_substitution_variable in varchar2',
'    ) return varchar2',
'    as',
'    begin',
'      return',
'        flow_constants_pkg.gc_substitution_prefix || flow_constants_pkg.gc_substitution_flow_identifier || ',
'        pi_substitution_variable || flow_constants_pkg.gc_substitution_postfix',
'      ;',
'    end get_replacement_pattern;',
'  begin',
'    l_f4a_substitutions :=',
'      apex_string.grep',
'      (',
'        p_str           => pio_string',
'      , p_pattern       => flow_constants_pkg.gc_substitution_pattern',
'      , p_modifier      => ''i''',
'      , p_subexpression => ''1''',
'      )',
'    ;',
'    if l_f4a_substitutions is not null then',
'      for i in 1..l_f4a_substitutions.count',
'      loop',
'        case upper(l_f4a_substitutions(i))',
'          when flow_constants_pkg.gc_substitution_process_id then',
'            pio_string := replace( pio_string, get_replacement_pattern( l_f4a_substitutions(i) ), pi_prcs_id );',
'          when flow_constants_pkg.gc_substitution_subflow_id then',
'            pio_string := replace( pio_string, get_replacement_pattern( l_f4a_substitutions(i) ), pi_sbfl_id );',
'          else',
'            -- own implementation of get_vc_var',
'            -- Reason:',
'            -- The general implementation immediately adds to APEX error stack',
'            begin',
'              select prov.prov_var_vc2',
'                into l_replacement_value',
'                from flow_process_variables prov',
'               where prov.prov_prcs_id  = pi_prcs_id',
'                 and upper(prov.prov_var_name) = upper(l_f4a_substitutions(i))',
'              ;',
'              pio_string := replace( pio_string, get_replacement_pattern( l_f4a_substitutions(i) ), l_replacement_value );',
'            exception',
'              when no_data_found then',
'                -- no data found will be ignored',
'                -- do like APEX and leave original in place',
'                null;',
'            end;',
'        end case;',
'      end loop;',
'    end if;',
'  end do_substitution;',
'',
'end flow_process_vars;',
'/',
'',
'create or replace package body flow_reservations',
'as ',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'  procedure reserve_step',
'    ( p_process_id         in flow_processes.prcs_id%type',
'    , p_subflow_id         in flow_subflows.sbfl_id%type',
'    , p_reservation        in flow_subflows.sbfl_reservation%type',
'    , p_called_internally  in boolean default false',
'    )',
'  is',
'    l_existing_reservation  flow_subflows.sbfl_reservation%type;',
'    e_reserved_by_other     exception;',
'    e_reserved_by_same      exception;',
'  begin',
'    apex_debug.enter',
'    (''reserve_step''',
'    , ''Subflow '', p_subflow_id',
'    , ''Process '', p_process_id',
'    , ''Reservation'', p_reservation',
'    );',
'    -- check step is not already reserved',
'    select sbfl_reservation',
'      into l_existing_reservation',
'      from flow_subflows sbfl ',
'     where sbfl.sbfl_id = p_subflow_id',
'       and sbfl.sbfl_prcs_id = p_process_id',
'       for update of sbfl_reservation wait 2',
'    ;',
'    if l_existing_reservation is not null then',
'      if p_reservation = l_existing_reservation then ',
'        -- step already reserved by required reservation',
'        raise e_reserved_by_same;',
'      else ',
'        raise e_reserved_by_other;',
'      end if;',
'    end if;',
'    -- place the reservation',
'    update flow_subflows sbfl',
'       set sbfl_reservation = p_reservation',
'     where sbfl_prcs_id = p_process_id',
'       and sbfl_id = p_subflow_id',
'    ;',
'    -- commit reservation if this is an external call',
'    if not p_called_internally then ',
'      commit;',
'    end if;',
'',
'  exception',
'    when no_data_found then',
'        apex_error.add_error',
'        ( p_message => ''Reservation unsuccessful.  Subflow ''||p_subflow_id||'' in Process ''||p_process_id||'' not found.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    when e_reserved_by_other then',
'        apex_error.add_error',
'        ( p_message => ''Reservation unsuccessful.  Step already reserved by another user.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );    ',
'    when e_reserved_by_same then',
'        apex_error.add_error',
'        ( p_message => ''Reservation already placed on next task.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    when lock_timeout then',
'        apex_error.add_error',
'        ( p_message => ''Subflow ''||p_subflow_id||'' currently locked by another user.  Try your reservation again later.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'  end reserve_step;',
'',
'  procedure release_step',
'    ( p_process_id         in flow_processes.prcs_id%type',
'    , p_subflow_id         in flow_subflows.sbfl_id%type',
'    , p_called_internally  in boolean default false',
'    )',
'  is',
'    l_existing_reservation  flow_subflows.sbfl_reservation%type;',
'  begin',
'    apex_debug.enter',
'    ( ''release_step''',
'    , ''Subflow '', p_subflow_id',
'    , ''Process '', p_process_id ',
'    );',
'    -- subflow should already be locked when calling internally',
'    if not p_called_internally then ',
'      -- lock  subflow if called externally',
'      select sbfl_reservation',
'        into l_existing_reservation',
'        from flow_subflows sbfl ',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'         for update of sbfl_reservation wait 2',
'      ;',
'    end if;',
'    -- release the reservation',
'    update flow_subflows sbfl',
'      set sbfl_reservation = null',
'    where sbfl_prcs_id = p_process_id',
'      and sbfl_id = p_subflow_id',
'    ;',
'    -- commit reservation if this is an external call',
'    if not p_called_internally then ',
'      commit;',
'    end if;',
'',
'  exception',
'    when no_data_found then',
'      apex_error.add_error',
'      ( p_message => ''Reservation release unsuccessful.  Subflow ''||p_subflow_id||'' in Process ''||p_process_id||'' not found.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    when lock_timeout then',
'        apex_error.add_error',
'        ( p_message => ''Subflow ''||p_subflow_id||'' currently locked by another user.  Try to release your reservation later.''',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'  end release_step;',
'',
'end flow_reservations;',
'/',
'create or replace package body flow_tasks',
'as ',
'',
'',
'  procedure handle_script_error -- largely duplicates flow_errors.handle_instance_error',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_script_object in flow_objects.objt_bpmn_id%type ',
'  , p_error_type    in varchar2',
'  , p_error_stack   in varchar2 default null',
'  )',
'  is ',
'    l_prcs_id   flow_processes.prcs_id%type;',
'    l_sbfl_id   flow_subflows.sbfl_id%type;',
'  begin ',
'        apex_debug.enter ',
'      ( ''handle_script_error''',
'      , ''p_script_object: '', p_script_object',
'      , ''p_error_type '', p_error_type ',
'      );',
'       -- lock process and subflow',
'      select prcs.prcs_id, sbfl.sbfl_id',
'        into l_prcs_id, l_sbfl_id',
'        from flow_processes prcs',
'        join flow_subflows sbfl ',
'          on prcs.prcs_id = sbfl.sbfl_prcs_id',
'       where prcs.prcs_id = p_process_id',
'         and sbfl.sbfl_id = p_subflow_id',
'      for update wait 2;',
'      -- set subflow to error status',
'      update flow_subflows sbfl',
'         set sbfl.sbfl_current = p_script_object',
'           , sbfl.sbfl_last_update = systimestamp',
'           , sbfl.sbfl_status = flow_constants_pkg.gc_sbfl_status_error',
'       where sbfl.sbfl_id = p_subflow_id',
'         and sbfl.sbfl_prcs_id = p_process_id',
'      ;',
'      -- set instance to error status',
'      update flow_processes prcs',
'         set prcs.prcs_status = flow_constants_pkg.gc_prcs_status_error',
'           , prcs.prcs_last_update = systimestamp',
'       where prcs.prcs_id = p_process_id',
'      ;',
'      -- log error as instance event',
'      flow_logging.log_instance_event',
'      ( p_process_id  => p_process_id ',
'      , p_event       => flow_constants_pkg.gc_prcs_event_error',
'      , p_comment     => case p_error_type',
'                         when ''failed''      then ''ScriptTask failed on object ''',
'                         when ''stop_engine'' then ''User Script Requested ScriptTask Stop on object ''',
'                         end ',
'                         || p_script_object|| '' error data....''||p_error_stack',
'      );',
'',
'      apex_debug.message ',
'      ( p_message => ''Script failed in ScriptTask.  Object: %0.''',
'      , p0        => p_script_object',
'      , p_level   => 2',
'      );',
'  end handle_script_error;',
'',
'',
'  procedure process_task',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    )',
'  is',
'  begin',
'    apex_debug.enter ',
'    ( ''process_task''',
'    , ''object: '', p_step_info.target_objt_tag ',
'    );',
'',
'    -- set boundaryEvent Timers, if any',
'    flow_boundary_events.set_boundary_timers',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );  ',
'  end process_task;',
'',
'  procedure process_userTask',
'    ( p_process_id    in flow_processes.prcs_id%type',
'    , p_subflow_id    in flow_subflows.sbfl_id%type',
'    , p_sbfl_info     in flow_subflows%rowtype',
'    , p_step_info     in flow_types_pkg.flow_step_info',
'    )',
'  is ',
'  begin',
'    -- current implementation is limited to one userTask type, which is to run a user defined APEX page',
'    -- future userTask types could include parameterised, standarised template pages , e.g., for approvals??  template scripts ??',
'    -- current implementation is implemented via the process inbox view.  ',
'    apex_debug.enter ',
'    ( ''process_userTask''',
'    , ''p_step_info.target_objt_tag'', p_step_info.target_objt_tag ',
'    );',
'',
'',
'    -- set boundaryEvent Timers, if any',
'    flow_boundary_events.set_boundary_timers ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );  ',
'  end process_userTask;',
'',
'  procedure process_scriptTask',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_sbfl_info     in flow_subflows%rowtype',
'  , p_step_info     in flow_types_pkg.flow_step_info',
'  )',
'  is ',
'  begin',
'    apex_debug.enter ',
'    ( ''process_scriptTask''',
'    , ''p_step_info.target_objt_tag'', p_step_info.target_objt_tag ',
'    );',
'    -- current implementation is limited to one scriptTask type, which is to run a user defined PL/SQL script',
'    -- future scriptTask types could include standarised template scripts ??',
'    -- current implementation is limited to synchronous script execution (i.e., script is run as part of Flows for APEX process)',
'    -- future implementations could include async scriptTasks, where script execution is queued.',
'  ',
'    -- set work started time',
'    flow_engine.start_step ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_called_internally => true',
'    );',
'    ',
'    flow_plsql_runner_pkg.run_task_script(',
'      pi_prcs_id => p_process_id',
'    , pi_sbfl_id => p_subflow_id',
'    , pi_objt_id => p_step_info.target_objt_id',
'    );',
'',
'    flow_engine.flow_complete_step ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id ',
'    );',
'',
'  exception',
'    when flow_plsql_runner_pkg.e_plsql_script_failed then',
'      rollback;',
'      apex_debug.info ',
'      ( p_message => ''Rollback initiated after script failed in plsql script runner''',
'      );',
'      /*handle_script_error',
'      ( p_process_id    => p_process_id',
'      , p_subflow_id    => p_subflow_id',
'      , p_script_object => p_step_info.target_objt_ref',
'      , p_error_type    => ''failed''',
'      , p_error_stack   => ''error stack to be added''',
'      );',
'      commit;*/',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => p_process_id',
'      , pi_sbfl_id        => p_subflow_id',
'      , pi_message_key    => ''plsql_script_failed''',
'      , p0 => p_process_id',
'      , p1 => p_step_info.target_objt_ref',
'      );',
'      -- $F4AMESSAGE ''plsql_script_failed'' || ''Process %0: ScriptTask %1 failed due to PL/SQL error - see event log.''',
'',
'    when flow_plsql_runner_pkg.e_plsql_script_requested_stop then',
'      rollback;',
'      apex_debug.info ',
'      ( p_message => ''Rollback initiated after script requested stop_engine in plsql script runner''',
'      );',
'      /*handle_script_error',
'      ( p_process_id    => p_process_id',
'      , p_subflow_id    => p_subflow_id',
'      , p_script_object => p_step_info.target_objt_ref',
'      , p_error_type    => ''stop_engine''',
'      , p_error_stack   => ''error stack to be added''',
'      );',
'      commit;  */  ',
'      flow_errors.handle_instance_error',
'      ( pi_prcs_id        => p_process_id',
'      , pi_sbfl_id        => p_subflow_id',
'      , pi_message_key    => ''plsql_script_requested_stop''',
'      , p0 => p_process_id',
'      , p1 => p_step_info.target_objt_ref',
'      );  ',
'      -- $F4AMESSAGE ''plsql_script_requested_stop'' || ''Process %0: ScriptTask %1 requested processing stop - see event log.''',
'',
'  end process_scriptTask;',
'',
'  procedure process_serviceTask --- note NOT CURRENTLY BEING USED FOR SERVICETASKS - USING process_scriptTask',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_sbfl_info     in flow_subflows%rowtype',
'  , p_step_info     in flow_types_pkg.flow_step_info',
'  )',
'  is ',
'  begin',
'    apex_debug.enter ',
'    ( ''process_serviceTask''',
'    , ''p_step_info.target_objt_tag'', p_step_info.target_objt_tag ',
'    );',
'',
'',
'    -- current implementation is limited to one serviceTask type, which is for apex message template sent from user defined PL/SQL script',
'    -- future serviceTask types could include text message, tweet, AOP document via email, etc.',
'    -- current implementation is limited to synchronous email send (i.e., email sent as part of Flows for APEX process).',
'    -- future implementations could include async serviceTask, where message generation is queued, or non-email services',
'',
'    flow_engine.start_step ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    , p_called_internally => true',
'    );',
'',
'    flow_plsql_runner_pkg.run_task_script',
'    ( pi_prcs_id => p_process_id',
'    , pi_sbfl_id => p_subflow_id',
'    , pi_objt_id => p_step_info.target_objt_id',
'    );',
'',
'    flow_engine.flow_complete_step ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id ',
'    );',
'',
'  exception',
'    when others then',
'      rollback;',
'      raise flow_plsql_runner_pkg.e_plsql_script_failed;',
'  end process_serviceTask;',
'',
'  procedure process_manualTask',
'  ( p_process_id    in flow_processes.prcs_id%type',
'  , p_subflow_id    in flow_subflows.sbfl_id%type',
'  , p_sbfl_info     in flow_subflows%rowtype',
'  , p_step_info     in flow_types_pkg.flow_step_info',
'  )',
'  is ',
'  begin',
'    apex_debug.enter ',
'    (''process_manualTask''',
'    , ''p_step_info.target_objt_tag'', p_step_info.target_objt_tag ',
'    );',
'',
'    -- current implementation of manualTask performs exactly like a standard Task, without attached boundary timers',
'    -- future implementation could include auto-call of an APEX page telling you what the manual task is and providing information about it?',
'',
'    -- set boundaryEvent Timers, if any',
'    flow_boundary_events.set_boundary_timers ',
'    ( p_process_id => p_process_id',
'    , p_subflow_id => p_subflow_id',
'    );  ',
'  end process_manualTask;',
'  ',
'end flow_tasks;',
'/',
'',
'',
'create or replace package body flow_timers_pkg',
'as',
'',
'',
'  lock_timeout exception;',
'  pragma exception_init (lock_timeout, -3006);',
'',
'  function timer_exists',
'  (',
'    pi_timr_id in flow_timers.timr_id%type',
'  ) return boolean',
'  as',
'    l_cnt number;',
'  begin',
'    select count(*)',
'      into l_cnt',
'      from flow_timers',
'     where timr_id = pi_timr_id',
'    ;',
'    return ( l_cnt = 1 );',
'  end timer_exists;',
'',
'  procedure lock_timer',
'  (',
'    pi_prcs_id  in  flow_processes.prcs_id%type',
'  , pi_sbfl_id  in  flow_subflows.sbfl_id%type',
'  )',
'  as',
'    cursor c_lock is ',
'      select timr.timr_id ',
'        from flow_timers timr',
'       where timr.timr_prcs_id = pi_prcs_id',
'         and timr.timr_sbfl_id = pi_sbfl_id',
'      for update of timr.timr_id;',
'  begin',
'    open c_lock;',
'    close c_lock;',
'  exception',
'    when lock_timeout then',
'      apex_error.add_error',
'      ( p_message => ''Timer for subflow ''||pi_sbfl_id||'' currently locked by another user.  Try again later.''',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'  end lock_timer;',
'',
'  procedure lock_process_timers',
'  (',
'    pi_prcs_id  in  flow_processes.prcs_id%type',
'  )',
'  as',
'    cursor c_lock is ',
'      select timr.timr_id ',
'        from flow_timers timr',
'       where timr.timr_prcs_id = pi_prcs_id',
'       order by timr.timr_id',
'      for update of timr.timr_id;',
'  begin',
'    open c_lock;',
'    close c_lock;',
'  exception',
'  when lock_timeout then',
'    apex_error.add_error',
'    ( p_message => ''Timers for process ''||pi_prcs_id||'' currently locked by another user.  Try again later.''',
'    , p_display_location => apex_error.c_on_error_page',
'    );',
'  end lock_process_timers;',
'',
'  procedure get_timer_definition',
'  (',
'    pi_prcs_id    in         flow_processes.prcs_id%type',
'  , pi_sbfl_id    in         flow_subflows.sbfl_id%type',
'  , po_timer_type out nocopy flow_object_attributes.obat_vc_value%type',
'  , po_timer_def  out nocopy flow_object_attributes.obat_vc_value%type',
'  )',
'  is',
'    l_objt_with_timer             flow_objects.objt_id%type;',
'    l_objt_with_timer_bpmn_id     flow_objects.objt_bpmn_id%type;',
'  begin',
'    -- get objt that timers are attached to (object or attached boundaryEvent)',
'    begin ',
'      select objt.objt_id',
'           , objt.objt_bpmn_id',
'        into l_objt_with_timer',
'           , l_objt_with_timer_bpmn_id',
'        from flow_subflows sbfl',
'        join flow_processes prcs',
'          on prcs.prcs_id = sbfl.sbfl_prcs_id',
'        join flow_objects objt',
'          on objt.objt_bpmn_id = sbfl.sbfl_current',
'         and objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'       where sbfl.sbfl_id = pi_sbfl_id',
'         and sbfl.sbfl_prcs_id = pi_prcs_id',
'         and objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition',
'      ;',
'    exception',
'      when no_data_found then',
'        -- check for an interupting timer boundary event attached',
'        begin',
'          select boundary_objt.objt_id',
'            into l_objt_with_timer',
'            from flow_subflows sbfl',
'            join flow_processes prcs',
'              on prcs.prcs_id = sbfl.sbfl_prcs_id',
'            join flow_objects main_objt',
'              on main_objt.objt_bpmn_id = sbfl.sbfl_current',
'             and main_objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'            join flow_objects boundary_objt',
'              on boundary_objt.objt_attached_to = main_objt.objt_bpmn_id',
'             and boundary_objt.objt_dgrm_id = prcs.prcs_dgrm_id',
'           where sbfl.sbfl_id = pi_sbfl_id',
'             and prcs.prcs_id = pi_prcs_id',
'             and boundary_objt.objt_sub_tag_name = flow_constants_pkg.gc_bpmn_timer_event_definition',
'             and boundary_objt.objt_interrupting = 1',
'          ;',
'        exception',
'          when no_data_found then',
'            apex_error.add_error',
'            ( ',
'              p_message => ''Error finding object with timer in get_timer_definition. Subflow ''||pi_sbfl_id||'' .''',
'            , p_display_location => apex_error.c_on_error_page',
'            );',
'        end;',
'    end;',
'    apex_debug.info',
'    (',
'      p_message => ''get_timer_definition.  Getting timer definition for object %s on subflow %s''',
'    , p0        => l_objt_with_timer_bpmn_id',
'    , p1        => pi_sbfl_id',
'    );',
'',
'    for rec in (',
'                select obat.obat_key',
'                     , obat.obat_vc_value',
'                  from flow_object_attributes obat',
'                 where obat.obat_objt_id = l_objt_with_timer',
'                   and obat.obat_key in ( flow_constants_pkg.gc_timer_type_key, flow_constants_pkg.gc_timer_def_key )',
'               )',
'    loop',
'      case rec.obat_key',
'        when flow_constants_pkg.gc_timer_type_key then',
'          po_timer_type := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_timer_def_key then',
'          po_timer_def := rec.obat_vc_value;',
'        else',
'          null;',
'      end case;',
'    end loop;',
'',
'    if po_timer_type is null or po_timer_def is null then',
'      apex_error.add_error',
'      ( p_message          => apex_string.format',
'                              ( ',
'                                p_message =>''Incomplete timer definitions for object %0. Type: %1; Value: %2''',
'                              , p0        => l_objt_with_timer_bpmn_id',
'                              , p1        => coalesce(po_timer_type, ''!NULL!'')',
'                              , p2        => coalesce(po_timer_def, ''!NULL!'')',
'                              )',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'    elsif po_timer_type = flow_constants_pkg.gc_timer_type_cycle then',
'      -- cycle timers disabled in v21.1 until redone in future release',
'      apex_error.add_error',
'      ( p_message         => apex_string.format',
'                             (',
'                               p_message => ''Cycle Timer defined for object %0 not currently supported.''',
'                             , p0        => l_objt_with_timer_bpmn_id',
'                             )',
'      , p_display_location => apex_error.c_on_error_page',
'      );',
'',
'    end if;',
'  end get_timer_definition;',
'',
'  procedure step_timers',
'  as',
'    e_resource_timeout      exception;',
'    pragma                  exception_init(e_resource_timeout, -30006);',
'',
'    l_timers                flow_timers%rowtype;',
'    l_run_time              flow_timers.timr_last_run%type := systimestamp;',
'    l_new_status            flow_timers.timr_status%type;',
'  begin',
'    loop -- until no records found',
'      -- could add a functional index on flow_timers to improve performance of this query',
'      -- eg. create index flow_timr_n1 on flow_timers (',
'      --          case when timr_status in ( ''C'', ''A'' ) then coalesce( timr_last_run, timr_created_on ) end);',
'      select * into l_timers',
'        from flow_timers',
'       where rowid in (',
'          select max(rowid) keep (dense_rank first order by coalesce( timr_last_run, timr_created_on )) trowid',
'            from flow_timers',
'           where case when timr_status in ( c_created, c_active ) then ',
'                           coalesce( timr_last_run, timr_created_on ) end < l_run_time ',
'             and case timr_type',
'                 when flow_constants_pkg.gc_timer_type_cycle then',
'                      timr_start_on',
'                        + ( timr_interval_ym * coalesce( timr_run_count, 1 ) )',
'                        + ( timr_interval_ds * coalesce( timr_run_count, 1 ) )',
'                 else timr_start_on ',
'              end <= l_run_time',
'          )',
'      for update wait 5',
'      ;',
'      ',
'      case l_timers.timr_type when flow_constants_pkg.gc_timer_type_cycle then ',
'        l_new_status := case when l_timers.timr_run_count + 1 = l_timers.timr_repeat_times then c_ended else c_active end;',
'      else ',
'        l_new_status := c_ended;',
'      end case;',
'',
'      update flow_timers',
'      set timr_last_run = systimestamp',
'          , timr_run_count = timr_run_count + 1',
'          , timr_status = l_new_status',
'      where timr_id = l_timers.timr_id',
'      ;',
'              ',
'      begin',
'      -- ideally the flow_engine should lock the subflow and this procedure should handle the resource ',
'      -- timeout, deadlock and not found exceptions. This would happen if the subflow is locked waiting ',
'      -- to delete the timer through a cascade delete.',
'      flow_engine.flow_handle_event',
'        (',
'          p_process_id => l_timers.timr_prcs_id',
'        , p_subflow_id => l_timers.timr_sbfl_id',
'        );',
'      exception ',
'        -- Some exception happened during processing the timer',
'        -- We trap it here and mark respective timer as broken.',
'        when others then',
'        /*apex_debug.error',
'        (',
'          p_message => ''Timer with ID %s did not work. Check logs.''',
'        , p0        => l_timers.timr_id',
'        );*/',
'        update flow_timers',
'          set timr_status = c_broken',
'        where timr_id = l_timers.timr_id',
'        ;',
'        flow_errors.handle_instance_error',
'        ( pi_prcs_id    => l_timers.timr_prcs_id',
'        , pi_sbfl_id    => l_timers.timr_sbfl_id',
'        , pi_message_key => ''timer_broken''',
'        , p0 => l_timers.timr_id',
'        , p1 => l_timers.timr_prcs_id',
'        , p2 => l_timers.timr_sbfl_id',
'        );',
'        -- $F4AMESSAGE ''timer-broken'' || ''Timer %0 broken in process %1 , subflow : %2.  See error_info.''',
'      end;',
'      commit;',
'    end loop;',
'    exception ',
'      when no_data_found then return;',
'      when e_resource_timeout then',
'        -- record requiring update is locked by another process, could put some logging in here',
'        rollback;',
'        return;',
'',
'  end step_timers;',
'',
'  /*procedure step_timers',
'  as',
'    type t_timer_tab is table of flow_timers%rowtype;',
'    l_timers t_timer_tab;',
'    l_run_now boolean;',
'  begin',
'    select *',
'      bulk collect into l_timers',
'      from flow_timers',
'     where timr_status in ( c_created, c_active )',
'     order by timr_created_on',
'    ;',
'    for i in 1..l_timers.count loop',
'      l_run_now := false;',
'      begin',
'        -- first part is deciding if timer should run now',
'        -- and updates status on respective timer',
'        case l_timers(i).timr_type',
'          when flow_constants_pkg.gc_timer_type_cycle then',
'            if (   l_timers(i).timr_start_on',
'                 + ( l_timers(i).timr_interval_ym * coalesce( l_timers(i).timr_run_count, 1 ) )',
'                 + ( l_timers(i).timr_interval_ds * coalesce( l_timers(i).timr_run_count, 1 ) )',
'               ) <= systimestamp',
'            then',
'              l_run_now := true;',
'              update flow_timers',
'                 set timr_last_run = systimestamp',
'                   , timr_run_count = timr_run_count + 1',
'                   , timr_status = case when timr_run_count + 1 = timr_repeat_times then c_ended else c_active end',
'               where timr_id = l_timers(i).timr_id',
'              ;',
'            end if;',
'          else',
'            if l_timers(i).timr_start_on <= systimestamp then',
'              l_run_now := true;',
'              update flow_timers',
'                 set timr_last_run = systimestamp',
'                   , timr_run_count = timr_run_count + 1',
'                   , timr_status = c_ended',
'               where timr_id = l_timers(i).timr_id',
'              ;',
'            end if;',
'        end case;',
'',
'        -- Timer should run now',
'        -- We apply couple of safeguards here',
'        -- Verifying if timer still in flow_timers table',
'        -- and checking if the connected subflow is still there',
'        if l_run_now then',
'          if timer_exists( pi_timr_id => l_timers(i).timr_id ) then',
'            if flow_engine_util.check_subflow_exists',
'                ( ',
'                  p_process_id => l_timers(i).timr_prcs_id',
'                , p_subflow_id => l_timers(i).timr_sbfl_id',
'                ) ',
'            then',
'              flow_engine.flow_handle_event',
'              (',
'                p_process_id => l_timers(i).timr_prcs_id',
'              , p_subflow_id => l_timers(i).timr_sbfl_id',
'              );',
'            else',
'              apex_debug.warn',
'              (',
'                p_message => ''Timer with ID %s tried to trigger non existing subflow. Process: %s; Subflow: %s''',
'              , p0        => l_timers(i).timr_id',
'              , p1        => l_timers(i).timr_prcs_id',
'              , p2        => l_timers(i).timr_sbfl_id',
'              );',
'            end if;',
'          else',
'            apex_debug.info',
'            (',
'              p_message => ''Timer with ID %s does not exist anymore, skipping.''',
'            , p0        => l_timers(i).timr_id',
'            );',
'          end if;',
'        end if;',
'      exception',
'        -- Some exception happened during processing the timer',
'        -- We trap it here and mark respective timer as broken.',
'        when others then',
'          apex_debug.error',
'          (',
'            p_message => ''Timer with ID %s did not work. Check logs.''',
'          , p0        => l_timers(i).timr_id',
'          );',
'          update flow_timers',
'             set timr_status = c_broken',
'           where timr_id = l_timers(i).timr_id',
'          ;',
'      end;',
'    end loop;',
'  end step_timers;*/',
'',
'  procedure get_duration',
'  (',
'    in_string     in     varchar2',
'  , in_start_ts   in     timestamp with time zone default null',
'  , out_start_ts     out timestamp with time zone',
'  , out_interv_ym in out interval year to month',
'  , out_interv_ds in out interval day to second',
'  )',
'  as',
'    type t_duration_components is table of number index by varchar2(1 char);',
'',
'    l_start_pos_time  pls_integer;',
'    l_token_count     pls_integer;',
'    l_before_t        varcha'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'r2(200 char);',
'    l_after_t         varchar2(200 char);',
'    l_ym_part         varchar2(200 char);',
'    l_ds_part         varchar2(200 char);',
'',
'    l_cur_component   varchar2(200 char);    ',
'  begin',
'    -- first split the string to year-month and day-second parts',
'    -- afterwards operate on both separately',
'    -- because M before T means months and M after T means minutes',
'',
'    l_start_pos_time := instr( in_string, ''T'' );',
'    if l_start_pos_time = 0 then',
'      l_before_t := in_string;',
'    else',
'      l_before_t       := substr( in_string, 1, l_start_pos_time - 1 );',
'      l_after_t        := substr( in_string, l_start_pos_time);',
'    end if;',
'',
'    -- The day indicator comes before the "T"',
'    -- however day needs to be handle with ds_interval',
'    l_token_count := regexp_count( l_before_t, ''\d+\w'' );',
'    for i in 1..l_token_count loop',
'      l_cur_component := regexp_substr(l_before_t, ''\d+\w'', 1, i);',
'',
'      case substr(l_cur_component, -1)',
'        when ''Y'' then l_ym_part := l_ym_part || l_cur_component;',
'        when ''M'' then l_ym_part := l_ym_part || l_cur_component;',
'        when ''D'' then l_ds_part := l_ds_part || l_cur_component;',
'        else null;',
'      end case;',
'    end loop;',
'',
'    l_ds_part := l_ds_part || l_after_t;',
'',
'    out_interv_ym := to_yminterval( ''P'' || coalesce(l_ym_part, ''0Y'') );',
'    out_interv_ds := to_dsinterval( ''P'' || coalesce(l_ds_part, ''0D'') );',
'',
'    out_start_ts  := coalesce( in_start_ts, systimestamp ) + out_interv_ym + out_interv_ds;',
'',
'  end get_duration;',
'',
'/******************************************************************************',
'  START_TIMER',
'******************************************************************************/',
'',
'  procedure start_timer',
'  (',
'    pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type',
'  )',
'  as',
'    l_parsed_ts           flow_timers.timr_start_on%type;',
'    l_parsed_duration_ym  flow_timers.timr_interval_ym%type;',
'    l_parsed_duration_ds  flow_timers.timr_interval_ds%type;',
'    l_repeat_times        flow_timers.timr_repeat_times%type;',
'',
'    l_timer_type flow_object_attributes.obat_vc_value%type;',
'    l_timer_def  flow_object_attributes.obat_vc_value%type;',
'  begin',
'    get_timer_definition',
'    (',
'      pi_prcs_id    => pi_prcs_id',
'    , pi_sbfl_id    => pi_sbfl_id',
'    , po_timer_type => l_timer_type',
'    , po_timer_def  => l_timer_def',
'    );',
'    apex_debug.info',
'    (',
'      p_message => ''starting timer on subflow %0, type %1, def %2''',
'    , p0        => pi_sbfl_id',
'    , p1        => l_timer_type',
'    , p2        => l_timer_def',
'    );',
'    case l_timer_type',
'      when flow_constants_pkg.gc_timer_type_date then',
'        -- check for substitution of process variable',
'        if upper(substr(l_timer_def,1,5)) = flow_constants_pkg.gc_substitution_prefix || flow_constants_pkg.gc_substitution_flow_identifier then',
'          l_parsed_ts :=',
'            flow_process_vars.get_var_date',
'            ( ',
'              pi_prcs_id  => pi_prcs_id',
'            , pi_var_name => substr(l_timer_def,6,length(l_timer_def)-6)',
'            )',
'          ;',
'        else',
'          l_parsed_ts := to_timestamp_tz( replace ( l_timer_def, ''T'', '' '' ), ''YYYY-MM-DD HH24:MI:SS TZR'' );',
'        end if;',
'      when flow_constants_pkg.gc_timer_type_duration then',
'        -- check for substitution of process variable',
'        if upper(substr(l_timer_def,1,5)) = flow_constants_pkg.gc_substitution_prefix || flow_constants_pkg.gc_substitution_flow_identifier then',
'          l_timer_def :=',
'            flow_process_vars.get_var_vc2',
'            ( ',
'              pi_prcs_id  => pi_prcs_id',
'            , pi_var_name => substr(l_timer_def,6,length(l_timer_def)-6)',
'            )',
'          ;',
'        end if;     ',
'        get_duration',
'        (',
'          in_string     => l_timer_def',
'        , in_start_ts   => systimestamp',
'        , out_start_ts  => l_parsed_ts',
'        , out_interv_ym => l_parsed_duration_ym',
'        , out_interv_ds => l_parsed_duration_ds',
'        );',
'      when flow_constants_pkg.gc_timer_type_cycle then',
'        if upper( substr( l_timer_def, 1, 5 ) ) = flow_constants_pkg.gc_substitution_prefix || flow_constants_pkg.gc_substitution_flow_identifier then',
'          l_timer_def :=',
'            flow_process_vars.get_var_vc2',
'            ( pi_prcs_id  => pi_prcs_id',
'            , pi_var_name => substr( l_timer_def, 6, length(l_timer_def) - 6 )',
'            )',
'          ;',
'        end if;',
'        l_repeat_times := substr( l_timer_def, 2, instr( l_timer_def, ''/'', 1, 1 ) - 2 );',
'        l_timer_def    := substr( l_timer_def, instr( l_timer_def, ''/'', 1, 1 ) + 1 );',
'        get_duration',
'        (',
'          in_string     => l_timer_def',
'        , in_start_ts   => systimestamp',
'        , out_start_ts  => l_parsed_ts',
'        , out_interv_ym => l_parsed_duration_ym',
'        , out_interv_ds => l_parsed_duration_ds',
'        );',
'      else',
'        apex_error.add_error',
'        ( ',
'          p_message => ''No timer definitions found in start_timer on subflow ''||pi_sbfl_id||'' type ''||l_timer_type||'' def ''||l_timer_def',
'        , p_display_location => apex_error.c_on_error_page',
'        );',
'    end case;',
'',
'    insert into flow_timers',
'      (',
'        timr_prcs_id',
'      , timr_sbfl_id',
'      , timr_type',
'      , timr_created_on',
'      , timr_status',
'      , timr_start_on',
'      , timr_interval_ym',
'      , timr_interval_ds',
'      , timr_repeat_times',
'      )',
'      values',
'      (',
'        pi_prcs_id',
'      , pi_sbfl_id',
'      , l_timer_type',
'      , systimestamp',
'      , c_created',
'      , l_parsed_ts',
'      , l_parsed_duration_ym',
'      , l_parsed_duration_ds',
'      , l_repeat_times',
'      )',
'    ;',
'  end start_timer;',
'',
'/******************************************************************************',
'  EXPIRE_TIMER',
'******************************************************************************/',
'',
'  procedure expire_timer',
'  (',
'    pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type ',
'  )',
'  is',
'  begin',
'    update flow_timers',
'       set timr_status = c_expired',
'     where timr_prcs_id = pi_prcs_id',
'       and timr_sbfl_id = pi_sbfl_id',
'       and timr_status not in (c_ended, c_expired, c_terminated)',
'    ;',
'  end expire_timer;',
'',
'/******************************************************************************',
'  TERMINATE_TIMER',
'******************************************************************************/',
'',
'  procedure terminate_timer',
'  (',
'    pi_prcs_id      in flow_processes.prcs_id%type',
'  , pi_sbfl_id      in flow_subflows.sbfl_id%type',
'  , po_return_code out number',
'  )',
'  is',
'  begin',
'    update flow_timers',
'       set timr_status = c_terminated',
'     where timr_prcs_id = pi_prcs_id',
'       and timr_sbfl_id = pi_sbfl_id',
'       and timr_status not in (c_ended, c_expired, c_terminated)',
'    ;',
'  end terminate_timer;',
'',
'/******************************************************************************',
'  TERMINATE_PROCESS_TIMERS',
'******************************************************************************/',
'',
'  procedure terminate_process_timers',
'  (',
'    pi_prcs_id      in flow_processes.prcs_id%type',
'  , po_return_code out number',
'  )',
'  is',
'  begin',
'    update flow_timers',
'       set timr_status = c_terminated',
'     where timr_prcs_id = pi_prcs_id',
'       and timr_status not in (c_ended, c_expired, c_terminated)',
'    ;',
'  end terminate_process_timers;',
'',
'/******************************************************************************',
'  TERMINATE_ALL_TIMERS',
'******************************************************************************/',
'',
'  procedure terminate_all_timers',
'  (',
'    po_return_code  out  number',
'  )',
'  is',
'  begin',
'    update flow_timers',
'       set timr_status = c_terminated',
'     where timr_status not in (c_ended, c_expired, c_terminated)',
'    ;',
'  end terminate_all_timers;',
'',
'/******************************************************************************',
'  delete_process_timers',
'    delete all the timers of a process.',
'******************************************************************************/',
'',
'  procedure delete_process_timers',
'  (',
'    pi_prcs_id      in flow_processes.prcs_id%type',
'  , po_return_code out number',
'  )',
'  is ',
'  begin',
'    delete',
'      from flow_timers',
'     where timr_prcs_id = pi_prcs_id',
'    ;',
'  end delete_process_timers;',
'',
'  procedure disable_scheduled_job',
'  as',
'  begin',
'    execute immediate',
'    q''[begin',
'    sys.dbms_scheduler.disable( name => ''apex_flow_step_timers_j'' );',
'    end;]'';',
'  end;',
'',
'  procedure enable_scheduled_job',
'  as',
'  begin',
'    execute immediate',
'    q''[begin',
'    sys.dbms_scheduler.enable( name => ''apex_flow_step_timers_j'' );',
'    end;]'';',
'  end;',
'',
'end flow_timers_pkg;',
'/',
'',
'create or replace package body flow_usertask_pkg',
'as',
'',
'  function get_url',
'  (',
'    pi_prcs_id in flow_processes.prcs_id%type',
'  , pi_sbfl_id in flow_subflows.sbfl_id%type',
'  , pi_objt_id in flow_objects.objt_id%type',
'  ) return varchar2',
'  as',
'    l_application flow_object_attributes.obat_vc_value%type;',
'    l_page        flow_object_attributes.obat_vc_value%type;',
'    l_request     flow_object_attributes.obat_vc_value%type;',
'    l_clear_cache flow_object_attributes.obat_vc_value%type;',
'    l_items       flow_object_attributes.obat_vc_value%type;',
'    l_values      flow_object_attributes.obat_vc_value%type;',
'  begin',
'    for rec in (',
'      select obat.obat_key',
'           , obat.obat_vc_value',
'        from flow_object_attributes obat',
'       where obat.obat_objt_id = pi_objt_id',
'         and obat.obat_key in ( flow_constants_pkg.gc_apex_usertask_application',
'                              , flow_constants_pkg.gc_apex_usertask_page',
'                              , flow_constants_pkg.gc_apex_usertask_request',
'                              , flow_constants_pkg.gc_apex_usertask_cache',
'                              , flow_constants_pkg.gc_apex_usertask_item',
'                              , flow_constants_pkg.gc_apex_usertask_value',
'                              )',
'    )',
'    loop',
'      case rec.obat_key',
'        when flow_constants_pkg.gc_apex_usertask_application then',
'          l_application := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_apex_usertask_page then',
'          l_page := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_apex_usertask_request then',
'          l_request := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_apex_usertask_cache then',
'          l_clear_cache := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_apex_usertask_item then',
'          l_items := rec.obat_vc_value;',
'        when flow_constants_pkg.gc_apex_usertask_value then',
'          l_values := rec.obat_vc_value;',
'          flow_process_vars.do_substitution( pi_prcs_id => pi_prcs_id, pi_sbfl_id => pi_sbfl_id, pio_string => l_values );',
'        else',
'          null;',
'      end case;',
'    end loop;',
'',
'    return',
'      apex_page.get_url',
'      (',
'        p_application => l_application',
'      , p_page        => l_page',
'      , p_request     => l_request',
'      , p_clear_cache => l_clear_cache',
'      , p_items       => l_items',
'      , p_values      => l_values',
'      )',
'    ;',
'  end get_url;',
'',
'end flow_usertask_pkg;',
'/',
'',
'create or replace package body flow_p0005_api',
'as',
'',
'  function get_file_name',
'  (',
'    p_dgrm_id in number',
'  , p_include_version in varchar2',
'  , p_include_status in varchar2',
'  , p_include_category in varchar2',
'  , p_include_last_change_date in varchar2',
'  , p_download_as in varchar2',
'  ) ',
'  return varchar2',
'  is',
'    l_file_name      varchar2(300 char);',
'',
'    l_dgrm_name        flow_diagrams.dgrm_name%type;',
'    l_dgrm_version     flow_diagrams.dgrm_version%type;',
'    l_dgrm_status      flow_diagrams.dgrm_status%type;',
'    l_dgrm_category    flow_diagrams.dgrm_category%type;',
'    l_dgrm_last_update flow_diagrams.dgrm_last_update%type;',
'  begin',
'    select dgrm_name',
'         , dgrm_version',
'         , dgrm_status',
'         , dgrm_category',
'         , dgrm_last_update',
'      into l_dgrm_name',
'         , l_dgrm_version',
'         , l_dgrm_status',
'         , l_dgrm_category',
'         , l_dgrm_last_update',
'      from flow_diagrams',
'     where dgrm_id = p_dgrm_id',
'    ;',
'    ',
'    l_file_name := to_char(sysdate, ''YYYYMMDD-HH24MI'') || ''_'' || l_dgrm_name;',
'    ',
'    if (p_include_category = ''Y'' and l_dgrm_category is not null) then',
'      l_file_name := l_file_name || ''_'' || l_dgrm_category;',
'    end if;',
'    if (p_include_status = ''Y'') then',
'      l_file_name := l_file_name || ''_'' || l_dgrm_status;',
'    end if;',
'    if (p_include_version = ''Y'') then',
'      l_file_name := l_file_name || ''_'' || l_dgrm_version;',
'    end if;',
'    if (p_include_last_change_date = ''Y'') then',
'      l_file_name := l_file_name || ''_'' || to_char(l_dgrm_last_update, ''YYYYMMDD-HH24MI'');',
'    end if;',
'',
'    if (p_download_as = ''SQL'') then',
'      l_file_name := l_file_name || ''.sql'';',
'    end if;',
'    if (p_download_as = ''BPMN'') then',
'      l_file_name := l_file_name || ''.bpmn'';',
'    end if;',
'    return l_file_name;',
'  end get_file_name;',
'',
'',
'  function get_sql_script(',
'      p_dgrm_id in number',
'  ) ',
'  return clob',
'  is',
'    l_split_content apex_t_varchar2;',
'    l_sql clob;',
'    l_buffer varchar2(32767);  ',
'    r_diagrams flow_diagrams%rowtype;',
'  begin ',
'    dbms_lob.createtemporary(l_sql,true, DBMS_LOB.CALL);',
'',
'    select *',
'    into r_diagrams',
'    from flow_diagrams',
'    where dgrm_id = p_dgrm_id;',
'',
'    l_buffer := ''declare''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''  l_dgrm_content clob;''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''begin''||utl_tcp.crlf;',
'    dbms_lob.writeappend(l_sql, length(l_buffer), l_buffer);',
'',
'    l_split_content := apex_string.split(p_str => replace(r_diagrams.dgrm_content,  apex_application.CRLF,  apex_application.LF));',
'    l_buffer := ''  l_dgrm_content := apex_string.join_clob(''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''    apex_t_varchar2(''||utl_tcp.crlf;',
'    dbms_lob.writeappend(l_sql, length(l_buffer), l_buffer);',
'',
'    for i in l_split_content.first..l_split_content.last',
'    loop',
'      if (i = l_split_content.first) then',
'        l_buffer := ''      q''''[''||l_split_content(i)||'']''''''||utl_tcp.crlf;',
'      else',
'        l_buffer := ''      ,q''''[''||l_split_content(i)||'']''''''||utl_tcp.crlf;',
'      end if;',
'      dbms_lob.writeappend(l_sql, length(l_buffer), l_buffer);',
'    end loop;',
'    l_buffer := ''  ));'';',
'    l_buffer := l_buffer||utl_tcp.crlf;',
'    l_buffer := l_buffer||''  flow_bpmn_parser_pkg.upload_and_parse(''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''    pi_dgrm_name => ''||dbms_assert.enquote_literal(r_diagrams.dgrm_name)||'',''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''    pi_dgrm_version => ''||dbms_assert.enquote_literal(r_diagrams.dgrm_version)||'',''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''    pi_dgrm_category => ''||dbms_assert.enquote_literal(r_diagrams.dgrm_category)||'',''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''    pi_dgrm_content => l_dgrm_content''||utl_tcp.crlf||'');''||utl_tcp.crlf;',
'    l_buffer := l_buffer||''end;''||utl_tcp.crlf||''/''||utl_tcp.crlf;',
'    dbms_lob.writeappend(l_sql, length(l_buffer), l_buffer);',
'    ',
'    return l_sql;',
'  end get_sql_script;',
'  ',
'',
'  function get_bmpn_content(',
'      p_dgrm_id in number',
'  ) return clob',
'  is ',
'    l_dgrm_content flow_diagrams.dgrm_content%type;',
'  begin',
'    select dgrm_content',
'    into l_dgrm_content',
'    from flow_diagrams',
'    where dgrm_id = p_dgrm_id;',
'',
'    return l_dgrm_content;',
'  end get_bmpn_content;',
'',
'  function sanitize_file_name(',
'    p_file_name in varchar2',
'  )',
'  return varchar2',
'  is',
'    l_file_name varchar2(300 char);',
'  begin',
'    l_file_name := p_file_name;',
'    l_file_name := replace(l_file_name, ''/'', ''_'');',
'    l_file_name := replace(l_file_name, ''\'', ''_'');',
'    l_file_name := replace(l_file_name, ''*'', ''_'');',
'    l_file_name := replace(l_file_name, '':'', ''_'');',
'    l_file_name := replace(l_file_name, ''?'', ''_'');',
'    l_file_name := replace(l_file_name, ''|'', ''_'');',
'    l_file_name := replace(l_file_name, ''<'', ''_'');',
'    l_file_name := replace(l_file_name, ''>'', ''_'');',
'    return l_file_name;',
'  end sanitize_file_name;',
'',
'  function clob_to_blob(',
'    p_clob in clob',
'  )',
'  return blob',
'  is',
'    l_blob         BLOB;',
'    l_dest_offset  PLS_INTEGER := 1;',
'    l_src_offset   PLS_INTEGER := 1;',
'    l_lang_context PLS_INTEGER := DBMS_LOB.default_lang_ctx;',
'    l_warning      PLS_INTEGER := DBMS_LOB.warn_inconvertible_char;',
'  begin',
'    dbms_lob.createtemporary(',
'      lob_loc => l_blob,',
'      cache   => TRUE',
'    );',
'    dbms_lob.converttoblob(',
'      dest_lob      => l_blob,',
'      src_clob      => p_clob,',
'      amount        => DBMS_LOB.lobmaxsize,',
'      dest_offset   => l_dest_offset,',
'      src_offset    => l_src_offset, ',
'      blob_csid     => DBMS_LOB.default_csid,',
'      lang_context  => l_lang_context,',
'      warning       => l_warning',
'    );',
'  ',
'    return l_blob;',
'  end clob_to_blob;',
'',
'  procedure download_file(',
'      p_dgrm_id in number,',
'      p_file_name in varchar2,',
'      p_download_as in varchar2,',
'      p_multi_file in boolean default false',
'  )',
'  is ',
'    l_clob        clob;',
'    l_blob        blob;',
'    l_zip_file    blob;',
'    l_buffer      varchar2(32767);  ',
'    l_length      integer;',
'    l_desc_offset pls_integer := 1;',
'    l_src_offset  pls_integer := 1;',
'    l_lang        pls_integer := 0;',
'    l_warning     pls_integer := 0;',
'    l_mime_type   varchar2(100) := ''application/octet'';',
'    type r_flow   is record (',
'      dgrm_id       flow_diagrams.dgrm_id%type, ',
'      dgrm_name     flow_diagrams.dgrm_name%type,',
'      dgrm_version  flow_diagrams.dgrm_version%type,',
'      dgrm_status   flow_diagrams.dgrm_status%type,',
'      dgrm_category flow_diagrams.dgrm_category%type,',
'      filename      varchar2(300)',
'    );',
'    type t_flows  is table of r_flow;',
'    l_flows       t_flows;',
'    l_json_array  json_array_t;',
'    l_json_object json_object_t;',
'    l_json_clob   clob;',
'    l_sql_clob    clob;',
'    l_file_name   varchar2(300);',
'  begin',
'    l_file_name := p_file_name;',
'',
'    if ( p_download_as = ''BPMN'' ) then',
'      l_json_array := json_array_t(''[]'');',
'    end if;',
'',
'    if ( p_multi_file ) then',
'      select ',
'        dgrm_id, ',
'        dgrm_name,',
'        dgrm_version,',
'        dgrm_status,',
'        dgrm_category,',
'        dgrm_name||''_''||dgrm_version as filename',
'      bulk collect into l_flows',
'      from flow_diagrams ',
'      where dgrm_id in (',
'        select n001',
'        from apex_collections',
'        where collection_name = ''C_SELECT''',
'      );',
'',
'    else',
'      l_flows := t_flows(r_flow(p_dgrm_id, p_file_name));',
'    end if;',
'',
'    for i in 1..l_flows.count()',
'    loop',
'      if (p_download_as = ''BPMN'') then',
'          l_clob := flow_p0005_api.get_bmpn_content(p_dgrm_id => l_flows(i).dgrm_id);',
'          apex_debug.message(dbms_lob.getlength(l_clob));',
'      end if;',
'      if (p_download_as = ''SQL'') then',
'        l_clob := flow_p0005_api.get_sql_script(p_dgrm_id => l_flows(i).dgrm_id);',
'      end if;',
'',
'      l_blob := clob_to_blob(l_clob);',
'',
'      if ( p_multi_file ) then',
'        apex_zip.add_file (',
'          p_zipped_blob => l_zip_file,',
'          p_file_name   => sanitize_file_name(l_flows(i).filename) || ''.'' || lower(p_download_as),',
'          p_content     => l_blob',
'        );',
'',
'        if ( p_download_as = ''BPMN'' ) then',
'          l_json_object := json_object_t(''{}'');',
'          l_json_object.put(''dgrm_name'' ,  l_flows(i).dgrm_name);',
'          l_json_object.put(''dgrm_version'' ,  l_flows(i).dgrm_version);',
'          l_json_object.put(''dgrm_status'' ,  l_flows(i).dgrm_status);',
'          l_json_object.put(''dgrm_category'' ,  l_flows(i).dgrm_category);',
'          l_json_object.put(''file'' ,  sanitize_file_name(l_flows(i).filename) || ''.bpmn'');',
'',
'          l_json_array.append(l_json_object);',
'        elsif ( p_download_as = ''SQL'' ) then',
'          l_sql_clob := l_sql_clob||''@"''||sanitize_file_name(l_flows(i).filename) || ''.'' || lower(p_download_as)||''";''||utl_tcp.crlf;',
'        end if;',
'      end if;',
'    end loop;',
'',
'    if ( p_multi_file ) then',
'      if ( p_download_as = ''BPMN'' ) then',
'        l_json_clob := treat(l_json_array as json_element_t).to_clob(); ',
'',
'        l_blob := clob_to_blob(l_json_clob);',
'',
'        apex_zip.add_file (',
'          p_zipped_blob => l_zip_file,',
'          p_file_name   => ''import.json'',',
'          p_content     => l_blob',
'        );',
'      elsif ( p_download_as = ''SQL'' ) then',
'        l_sql_clob := ''set define off;'' || utl_tcp.crlf || l_sql_clob || utl_tcp.crlf;',
'        l_blob := clob_to_blob(l_sql_clob);',
'        apex_zip.add_file (',
'          p_zipped_blob => l_zip_file,',
'          p_file_name   => ''import.sql'',',
'          p_content     => l_blob',
'        );',
'      end if;',
'',
'      apex_zip.finish (',
'        p_zipped_blob => l_zip_file ',
'      );',
'      l_blob := l_zip_file;',
'      l_mime_type := ''application/zip'';',
'',
'      l_file_name := ''F4A_''||to_char(systimestamp, ''YYYYMMDD_HH24MISS'')||''.zip'';',
'    end if;',
'',
'    l_length := dbms_lob.getlength(l_blob);',
'',
'    owa_util.mime_header(l_mime_type, false) ;',
'    htp.p(''Content-length: '' || l_length);',
'    htp.p(''Content-Disposition: attachment; filename="''||sanitize_file_name(l_file_name)||''"'');',
'    owa_util.http_header_close;',
'    wpg_docload.download_file(l_blob);',
'',
'    apex_application.stop_apex_engine;',
'  end download_file;',
'',
'end flow_p0005_api;',
'/',
'',
'create or replace package body flow_p0006_api',
'as',
'',
'    function is_file_uploaded(',
'        pi_file_name in varchar2',
'    )',
'    return boolean',
'    is',
'        l_dgrm_content flow_diagrams.dgrm_content%type;',
'        l_err boolean := true;',
'    begin',
'        begin',
'            select to_clob(blob_content)',
'            into l_dgrm_content',
'            from apex_application_temp_files',
'            where name = pi_file_name;',
'        exception when no_data_found then',
'            l_err := false;',
'        end;',
' ',
'        return l_err;',
'    end is_file_uploaded;',
'',
'    function is_valid_xml(',
'        pi_import_from in varchar2,',
'        pi_dgrm_content in flow_diagrams.dgrm_content%type,',
'        pi_file_name in varchar2',
'    )',
'    return boolean',
'    is',
'        l_dgrm_content flow_diagrams.dgrm_content%type;',
'        l_xmltype xmltype;',
'        l_err boolean := true;',
'    begin',
'        if (pi_import_from = ''text'') then',
'            l_dgrm_content := pi_dgrm_content;',
'        else',
'            select to_clob(blob_content)',
'            into l_dgrm_content',
'            from apex_application_temp_files',
'            where name = pi_file_name;',
'        end if;',
'        begin',
'            l_xmltype := xmltype.createXML(l_dgrm_content);',
'        exception when others then',
'            l_err := false;',
'        end;',
'        return l_err;',
'    end is_valid_xml;',
'',
'    function is_valid_multi_file_archive(',
'        pi_file_name in varchar2',
'    )',
'    return varchar2',
'    is',
'        l_mime_type    apex_application_temp_files.mime_type%type;',
'        l_blob_content apex_application_temp_files.blob_content%type;',
'        l_error        varchar2(4000);',
'        l_files        apex_zip.t_files;',
'        l_found_json   boolean := false;',
'    begin',
'        select mime_type, blob_content',
'        into l_mime_type, l_blob_content',
'        from apex_application_temp_files',
'        where name = pi_file_name;',
'',
'        if ( l_mime_type != ''application/zip'') then',
'            l_error := ''You should provide a valid Flows for APEX zip export file.'';',
'        else',
'            l_files := apex_zip.get_files(',
'                p_zipped_blob => l_blob_content',
'            );',
'            for i in 1..l_files.count loop',
'                apex_debug.message(l_files(i));',
'                if ( l_files(i) = ''import.json'' ) then',
'                    l_found_json := true;',
'                end if;',
'                exit when l_found_json;',
'            end loop;',
'            if ( l_found_json = false ) then',
'                l_error := ''Missing import.json file in the zip export file.'';',
'            end if;',
'        end if;',
'        return l_error;',
'    end;',
'',
'    function upload_and_parse(',
'        pi_import_from in varchar2,',
'        pi_dgrm_name in flow_diagrams.dgrm_name%type,',
'        pi_dgrm_category in flow_diagrams.dgrm_category%type,',
'        pi_dgrm_version in flow_diagrams.dgrm_version%type,',
'        pi_dgrm_content in flow_diagrams.dgrm_content%type,',
'        pi_file_name in varchar2,',
'        pi_force_overwrite in varchar2',
'    ) ',
'    return flow_diagrams.dgrm_id%type',
'    is',
'        l_dgrm_id flow_diagrams.dgrm_id%type;',
'        l_dgrm_content flow_diagrams.dgrm_content%type;',
'        l_dgrm_exists number;',
'        l_dgrm_status flow_diagrams.dgrm_status%type;',
'    begin',
'        select count(*)',
'          into l_dgrm_exists',
'          from flow_diagrams',
'         where dgrm_name = pi_dgrm_name',
'           and dgrm_version = pi_dgrm_version',
'        ;',
'',
'        if (l_dgrm_exists > 0) then',
'            select dgrm_status',
'            into l_dgrm_status',
'            from flow_diagrams',
'            where dgrm_name = pi_dgrm_name',
'            and dgrm_version = pi_dgrm_version',
'            ;',
'        end if;',
'',
'        if (l_dgrm_exists = 0 or (l_dgrm_exists > 0 and pi_force_overwrite = ''Y'' and l_dgrm_status = flow_constants_pkg.gc_dgrm_status_draft)) then',
'            if (pi_import_from = ''text'') then',
'                l_dgrm_content := pi_dgrm_content;',
'            else',
'                select to_clob(blob_content)',
'                into l_dgrm_content',
'                from apex_application_temp_files',
'                where name = pi_file_name;',
'            end if;',
'        ',
'            l_dgrm_id := flow_bpmn_parser_pkg.upload_diagram(',
'                pi_dgrm_name => pi_dgrm_name',
'                , pi_dgrm_version => pi_dgrm_version',
'                , pi_dgrm_category => pi_dgrm_category',
'                , pi_dgrm_content => l_dgrm_content',
'                , pi_force_overwrite => case pi_force_overwrite when ''Y'' then true else false end',
'            );',
'',
'            flow_bpmn_parser_pkg.parse(pi_dgrm_id => l_dgrm_id);',
'        else',
'            if (l_dgrm_status = flow_constants_pkg.gc_dgrm_status_draft) then',
'                apex_error.add_error(',
'                    p_message => ''Model already exists.''',
'                    , p_display_location => apex_error.c_on_error_page',
'                );',
'            else',
'                apex_error.add_error(',
'                    p_message => ''Overwrite only possible for draft models.''',
'                    , p_display_location => apex_error.c_on_error_page',
'                );',
'            end if;',
'        end if;',
'        return l_dgrm_id;',
'    end upload_and_parse;',
'',
'    procedure multiple_flow_import(',
'        pi_file_name       in varchar2,',
'        pi_force_overwrite in varchar2',
'    )',
'    is',
'        l_dgrm_id       flow_diagrams.dgrm_id%type;',
'        l_dgrm_name     flow_diagrams.dgrm_name%type;',
'        l_dgrm_category flow_diagrams.dgrm_category%type;',
'        l_dgrm_version  flow_diagrams.dgrm_version%type;',
'        l_dgrm_content  flow_diagrams.dgrm_content%type;',
'        l_file          varchar2(300);',
'        l_json_array    json_array_t;',
'        l_json_object   json_object_t;',
'        l_blob_content  blob;',
'        l_json_file     blob;',
'        l_bpmn_file     blob;',
'        l_clob          clob;',
'    begin',
'        select blob_content',
'        into l_blob_content',
'        from apex_application_temp_files',
'        where name = pi_file_name;',
'',
'        l_json_file := apex_zip.get_file_content(',
'            p_zipped_blob => l_blob_content,',
'            p_file_name   => ''import.json''',
'        );',
'',
'        l_json_array := json_array_t.parse(l_json_file);',
'',
'        for i in 0..l_json_array.get_size() - 1 loop',
'            l_json_object := treat(l_json_array.get(i) as json_object_t);',
'',
'            l_dgrm_name     := l_json_object.get_String(''dgrm_name'');',
'            l_dgrm_version  := l_json_object.get_String(''dgrm_version'');',
'            l_dgrm_category := l_json_object.get_String(''dgrm_category'');',
'            l_dgrm_name     := l_json_object.get_String(''dgrm_name'');',
'            l_file          := l_json_object.get_String(''file'');   ',
'',
'            l_bpmn_file := apex_zip.get_file_content(',
'                p_zipped_blob => l_blob_content,',
'                p_file_name   => l_file',
'            );',
'',
'            select to_clob(l_bpmn_file)',
'            into l_clob',
'            from dual;',
'            ',
'            l_dgrm_id := flow_p0006_api.upload_and_parse(',
'                  pi_import_from => ''text''',
'                , pi_dgrm_name => l_dgrm_name',
'                , pi_dgrm_category => l_dgrm_category',
'                , pi_dgrm_version => l_dgrm_version',
'                , pi_dgrm_content => l_clob',
'                , pi_file_name => null',
'                , pi_force_overwrite => pi_force_overwrite',
'            );',
'        end loop;',
'    end multiple_flow_import;',
'',
'end flow_p0006_api;',
'/',
'',
'create or replace package body flow_p0007_api',
'as',
'',
'  procedure delete_diagram',
'  (',
'    pi_dgrm_id in flow_diagrams.dgrm_id%type',
'  , pi_cascade in varchar2',
'  )',
'  is',
'  begin',
'    if  pi_cascade = ''Y'' then',
'      delete from flow_processes where prcs_dgrm_id = pi_dgrm_id;',
'    end if;',
'    delete from flow_diagrams where dgrm_id = pi_dgrm_id;',
'  end delete_diagram;',
'',
'  function add_diagram_version',
'  (',
'    pi_dgrm_id in flow_diagrams.dgrm_id%type',
'  , pi_dgrm_version in flow_diagrams.dgrm_version%type',
'  ) return flow_diagrams.dgrm_id%type',
'  is',
'    l_dgrm_id flow_diagrams.dgrm_id%type;',
'    r_diagrams flow_diagrams%rowtype;',
'  begin',
'    select * ',
'      into r_diagrams',
'      from flow_diagrams',
'     where dgrm_id = pi_dgrm_id',
'    ;',
'    ',
'    l_dgrm_id :=',
'      flow_bpmn_parser_pkg.upload_diagram',
'      (',
'        pi_dgrm_name => r_diagrams.dgrm_name',
'      , pi_dgrm_version => pi_dgrm_version',
'      , pi_dgrm_category => r_diagrams.dgrm_category',
'      , pi_dgrm_content => r_diagrams.dgrm_content',
'      , pi_dgrm_status => flow_constants_pkg.gc_dgrm_status_draft',
'      );',
'    ',
'    flow_bpmn_parser_pkg.parse',
'    (',
'      pi_dgrm_id => l_dgrm_id',
'    );',
'    return l_dgrm_id;',
'  end add_diagram_version;',
'',
'  procedure process_page',
'  (',
'    pio_dgrm_id      in out nocopy flow_diagrams.dgrm_id%type',
'  , pi_dgrm_name     in flow_diagrams.dgrm_name%type',
'  , pi_dgrm_version  in flow_diagrams.dgrm_version%type',
'  , pi_dgrm_category in flow_diagrams.dgrm_category%type',
'  , pi_new_version   in flow_diagrams.dgrm_version%type',
'  , pi_cascade       in varchar2',
'  , pi_req'))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'uest       in varchar2',
'  )',
'  as',
'    l_dgrm_category flow_diagrams.dgrm_category%type;',
'  begin',
'    case pi_request',
'      when ''CREATE'' then',
'        begin',
'          select dgrm_id',
'          into pio_dgrm_id',
'          from flow_diagrams',
'          where dgrm_name = pi_dgrm_name',
'          and dgrm_version = pi_dgrm_version;',
'',
'          apex_error.add_error(',
'              p_message => apex_lang.message(p_name => ''DGRM_UK'')',
'            , p_display_location => apex_error.c_on_error_page',
'          );',
'        exception when no_data_found then',
'          pio_dgrm_id :=',
'            flow_bpmn_parser_pkg.upload_diagram',
'            (',
'              pi_dgrm_name     => pi_dgrm_name',
'            , pi_dgrm_version  => pi_dgrm_version',
'            , pi_dgrm_category => pi_dgrm_category',
'            , pi_dgrm_content  => flow_constants_pkg.gc_default_xml',
'            , pi_dgrm_status   => flow_constants_pkg.gc_dgrm_status_draft',
'            );',
'          flow_bpmn_parser_pkg.parse',
'          (',
'            pi_dgrm_id => pio_dgrm_id',
'          );',
'        end;',
'      when ''SAVE'' then',
'        select dgrm_category',
'          into l_dgrm_category',
'          from flow_diagrams',
'         where dgrm_id = pio_dgrm_id',
'        ;',
'',
'        if coalesce(l_dgrm_category, chr(10)) != coalesce(pi_dgrm_category, chr(10) ) then',
'          update flow_diagrams',
'             set dgrm_category = pi_dgrm_category',
'           where dgrm_name = ( select dgrm_name from flow_diagrams where dgrm_id = pio_dgrm_id )',
'          ;',
'        end if;',
'',
'        update flow_diagrams',
'           set dgrm_name = pi_dgrm_name',
'             , dgrm_version = pi_dgrm_version',
'             , dgrm_category = pi_dgrm_category',
'         where dgrm_id = pio_dgrm_id',
'        ;',
'      when ''DELETE'' then',
'        delete_diagram',
'        (',
'          pi_dgrm_id => pio_dgrm_id',
'        , pi_cascade => pi_cascade',
'        );',
'      when ''ADD_VERSION'' then',
'        pio_dgrm_id :=',
'          add_diagram_version',
'          (',
'            pi_dgrm_id      => pio_dgrm_id',
'          , pi_dgrm_version => pi_new_version',
'          );',
'      when ''RELEASE'' then',
'        update flow_diagrams',
'           set dgrm_status = flow_constants_pkg.gc_dgrm_status_deprecated',
'         where dgrm_name = pi_dgrm_name',
'         and dgrm_status = flow_constants_pkg.gc_dgrm_status_released;',
'',
'        update flow_diagrams',
'           set dgrm_status = flow_constants_pkg.gc_dgrm_status_released',
'         where dgrm_id = pio_dgrm_id',
'        ;',
'      when ''DEPRECATE'' then',
'        update flow_diagrams',
'           set dgrm_status = flow_constants_pkg.gc_dgrm_status_deprecated',
'         where dgrm_id = pio_dgrm_id',
'        ;',
'      when ''ARCHIVE'' then',
'        update flow_diagrams',
'           set dgrm_status = flow_constants_pkg.gc_dgrm_status_archived',
'         where dgrm_id = pio_dgrm_id',
'        ;',
'      else',
'        raise_application_error(-20002, ''Unknown operation requested.'');',
'    end case;',
'  end process_page;',
'',
'end flow_p0007_api;',
'/',
'',
'create or replace package body flow_engine_app_api',
'as',
'',
'  procedure handle_ajax',
'  as ',
'    l_error_occured boolean := false;',
'    l_url           varchar2(4000);',
'    l_clob          clob;',
'    l_before_prcs_status flow_instances_vw.prcs_status%type;',
'    l_after_prcs_status flow_instances_vw.prcs_status%type;',
'    l_reload boolean := false;',
'  begin',
'    apex_debug.message( p_message => ''Action: %s'', p0 => apex_application.g_x01 );',
'    if instr(apex_application.g_x01, ''bulk-'') > 0 then',
'      apex_debug.message( p_message => ''This is a bulk action'');',
'      if ( upper(apex_application.g_x01) = ''BULK-COMPLETE-STEP'' or upper(apex_application.g_x01) = ''BULK-RESTART-STEP'' ) then',
'        select prcs_status',
'        into l_before_prcs_status',
'        from flow_instances_vw',
'        where prcs_id = apex_application.g_f01(1);',
'      end if;',
'      for i in apex_application.g_f01.first..apex_application.g_f01.last',
'      loop',
'        apex_debug.message( p_message => ''Action: %s, PRCS: %s'', p0 => apex_application.g_x01, p1 => apex_application.g_f01(i) );',
'        case upper(apex_application.g_x01)',
'          when ''BULK-RESET-FLOW-INSTANCE'' then',
'            flow_api_pkg.flow_reset( p_process_id => apex_application.g_f01(i), p_comment => apex_application.g_x02 );',
'          when ''BULK-START-FLOW-INSTANCE'' then',
'            flow_api_pkg.flow_start( p_process_id => apex_application.g_f01(i) );',
'          when ''BULK-DELETE-FLOW-INSTANCE'' then',
'            flow_api_pkg.flow_delete( p_process_id => apex_application.g_f01(i), p_comment => apex_application.g_x02 );',
'          when ''BULK-TERMINATE-FLOW-INSTANCE'' then ',
'            flow_api_pkg.flow_terminate ( p_process_id => apex_application.g_f01(i), p_comment => apex_application.g_x02 );',
'          when ''BULK-RESERVE-STEP'' then',
'            flow_api_pkg.flow_reserve_step',
'            (',
'              p_process_id => apex_application.g_f01(i)',
'            , p_subflow_id => apex_application.g_f02(i)',
'            , p_reservation => coalesce(apex_application.g_x02, V(''APP_USER''))',
'            );',
'          when ''BULK-RELEASE-STEP'' then',
'            flow_api_pkg.flow_release_step',
'            (',
'              p_process_id => apex_application.g_f01(i)',
'            , p_subflow_id => apex_application.g_f02(i)',
'            );        ',
'          when ''BULK-COMPLETE-STEP'' then',
'            flow_api_pkg.flow_complete_step',
'            (',
'              p_process_id => apex_application.g_f01(i)',
'            , p_subflow_id => apex_application.g_f02(i)',
'            );',
'          when ''BULK-RESTART-STEP'' then ',
'            flow_api_pkg.flow_restart_step ',
'            (',
'              p_process_id => apex_application.g_f01(i)',
'            , p_subflow_id => apex_application.g_f02(i)',
'            , p_comment       => apex_application.g_x02           ',
'            );',
'          when ''BULK-DELETE-PROCESS-VARIABLE'' then ',
'            flow_process_vars.delete_var(',
'              pi_prcs_id => apex_application.g_f01(i)',
'            , pi_var_name => apex_application.g_f02(i)',
'          );',
'          else',
'            apex_error.add_error',
'            (',
'              p_message          => ''Unknow action requested.''',
'            , p_display_location => apex_error.c_on_error_page',
'            );',
'        end case;',
'      end loop;',
'      if ( upper(apex_application.g_x01) = ''BULK-COMPLETE-STEP'' or upper(apex_application.g_x01) = ''BULK-RESTART-STEP'' ) then',
'        select prcs_status',
'        into l_after_prcs_status',
'        from flow_instances_vw',
'        where prcs_id = apex_application.g_f01(1);',
'',
'        if l_before_prcs_status != l_after_prcs_status then',
'          l_reload := true;',
'        end if;',
'      end if;',
'    else',
'      apex_debug.message( p_message => ''Action: %s, PRCS: %s, SBFL: %s'', p0 => apex_application.g_x01, p1 => apex_application.g_x02, p2 => apex_application.g_x03 );',
'',
'      if ( upper( apex_application.g_x01 ) = ''COMPLETE-STEP'' or upper( apex_application.g_x01 ) = ''RESTART-STEP'' ) then',
'        select prcs_status',
'        into l_before_prcs_status',
'        from flow_instances_vw',
'        where prcs_id = apex_application.g_x02;',
'      end if;',
'',
'',
'      case upper(apex_application.g_x01)',
'        when ''RESET-FLOW-INSTANCE'' then',
'          flow_api_pkg.flow_reset( p_process_id => apex_application.g_x02, p_comment => apex_application.g_x03 );',
'        when ''START-FLOW-INSTANCE'' then',
'          flow_api_pkg.flow_start( p_process_id => apex_application.g_x02 );',
'        when ''DELETE-FLOW-INSTANCE'' then',
'          flow_api_pkg.flow_delete( p_process_id => apex_application.g_x02, p_comment => apex_application.g_x03 );',
'          l_url := apex_page.get_url(',
'                p_page => 10',
'              , p_clear_cache => 10',
'          );',
'        when ''RESERVE-STEP'' then',
'          flow_api_pkg.flow_reserve_step',
'          (',
'            p_process_id => apex_application.g_x02',
'          , p_subflow_id => apex_application.g_x03',
'          , p_reservation => coalesce(apex_application.g_x04, V(''APP_USER''))',
'          );',
'        when ''TERMINATE-FLOW-INSTANCE'' then ',
'          flow_api_pkg.flow_terminate ( p_process_id => apex_application.g_x02, p_comment => apex_application.g_x03 );',
'        when ''RELEASE-STEP'' then',
'          flow_api_pkg.flow_release_step',
'          (',
'            p_process_id => apex_application.g_x02',
'          , p_subflow_id => apex_application.g_x03',
'          );    ',
'        when ''COMPLETE-STEP'' then',
'          flow_api_pkg.flow_complete_step',
'          (',
'            p_process_id    => apex_application.g_x02',
'          , p_subflow_id    => apex_application.g_x03',
'          );',
'        when ''RESTART-STEP'' then ',
'          flow_api_pkg.flow_restart_step ',
'          (',
'            p_process_id    => apex_application.g_x02',
'          , p_subflow_id    => apex_application.g_x03',
'          , p_comment       => apex_application.g_x04       ',
'          );',
'        when ''FLOW-INSTANCE-AUDIT'' then',
'          l_url := apex_page.get_url(',
'              p_page => 14',
'            , p_items => ''P14_PRCS_ID,P14_TITLE''',
'            , p_values => apex_application.g_x02||'',''||apex_application.g_x03',
'            , p_clear_cache => ''RP''',
'          );',
'        when ''EDIT-FLOW-DIAGRAM'' then',
'          l_url := apex_page.get_url(',
'              p_page => 7',
'            , p_items => ''P7_DGRM_ID''',
'            , p_values => apex_application.g_x02',
'          );',
'        when ''OPEN-FLOW-INSTANCE-DETAILS'' then',
'          l_url := apex_page.get_url(',
'              p_page => 8',
'            , p_items => ''P8_PRCS_ID''',
'            , p_values => apex_application.g_x02',
'            , p_clear_cache => 8',
'          );',
'        when ''VIEW-FLOW-INSTANCE'' then',
'          l_url := apex_page.get_url(',
'              p_page => 12',
'            , p_items => ''P12_PRCS_ID''',
'            , p_values => apex_application.g_x02',
'            , p_clear_cache => 12',
'          );',
'        when ''PROCESS-VARIABLE'' then',
'          case apex_application.g_x04',
'            when ''VARCHAR2'' then',
'              flow_process_vars.set_var',
'              (',
'                pi_prcs_id   => apex_application.g_x02',
'              , pi_var_name  => apex_application.g_x03',
'              , pi_vc2_value => apex_application.g_x05',
'              );',
'            when ''NUMBER'' then',
'              flow_process_vars.set_var',
'              (',
'                pi_prcs_id   => apex_application.g_x02',
'              , pi_var_name  => apex_application.g_x03',
'              , pi_num_value => to_number(apex_application.g_x05)',
'              );',
'            when ''DATE'' then',
'              flow_process_vars.set_var',
'              (',
'                pi_prcs_id    => apex_application.g_x02',
'              , pi_var_name   => apex_application.g_x03',
'              , pi_date_value => to_date(apex_application.g_x05, v(''APP_DATE_TIME_FORMAT''))',
'              );',
'            when ''CLOB'' then',
'              for i in apex_application.g_f01.first..apex_application.g_f01.last',
'              loop',
'                l_clob := l_clob || apex_application.g_f01(i);',
'              end loop;',
'              flow_process_vars.set_var',
'              (',
'                pi_prcs_id    => apex_application.g_x02',
'              , pi_var_name   => apex_application.g_x03',
'              , pi_clob_value => l_clob',
'              );',
'            else',
'              null;',
'          end case;',
'        when ''DELETE-PROCESS-VARIABLE'' then',
'          flow_process_vars.delete_var(',
'            pi_prcs_id => apex_application.g_x02',
'            , pi_var_name => apex_application.g_x03',
'          );',
'        else',
'          apex_error.add_error',
'          (',
'            p_message          => ''Unknow action requested.''',
'          , p_display_location => apex_error.c_on_error_page',
'          );',
'      end case;',
'',
'      if ( upper( apex_application.g_x01 ) = ''COMPLETE-STEP'' or upper( apex_application.g_x01 ) = ''RESTART-STEP'' ) then',
'        select prcs_status',
'        into l_after_prcs_status',
'        from flow_instances_vw',
'        where prcs_id = apex_application.g_x02;',
'',
'        if l_before_prcs_status != l_after_prcs_status then',
'          l_reload := true;',
'        end if;',
'      end if;',
'',
'    end if;',
'',
'    apex_json.open_object;',
'    apex_json.write( p_name => ''success'', p_value => not apex_error.have_errors_occurred );',
'    if l_url is not null then',
'      apex_json.write( p_name => ''url'', p_value => l_url );',
'    end if;',
'    if l_reload then ',
'      apex_json.write( p_name => ''reloadPage'', p_value => true );',
'    end if;',
'    apex_json.close_all;',
'    ',
'  exception',
'      when others then',
'        l_error_occured := true;',
'  end handle_ajax;',
'',
'end flow_engine_app_api;',
'/',
'',
'create or replace package body flow_plugin_manage_instance as',
'',
'   procedure log_attributes(',
'      p_process  in  apex_plugin.t_process',
'    , p_plugin   in  apex_plugin.t_plugin',
'   )',
'   is',
'   begin',
'',
'      apex_debug.info(',
'           p_message => '' > Process plug-in attributes''',
'      );',
'      apex_debug.info(',
'           p_message => ''...Action: %s''',
'         , p0        => p_process.attribute_01',
'      );',
'      ',
'      apex_debug.info(',
'           p_message => ''...Flow %s define by: %s''',
'         , p0        => case ',
'                           when p_process.attribute_01 in ( ''create'', ''create_and_start'' ) then  ',
'                              ''Diagram''',
'                           else ',
'                              ''Instance ID''',
'                        end',
'         , p1        => p_process.attribute_03',
'      );',
'',
'      if p_process.attribute_03 = ''item'' then ',
'         apex_debug.info(',
'            p_message => ''......Item used: %s - Session state value: %s''',
'            , p0        => p_process.attribute_04',
'            , p1        => apex_util.get_session_state(p_item => p_process.attribute_02)',
'         );',
'      elsif p_process.attribute_03 = ''sql''  then',
'         apex_debug.info(',
'            p_message => ''......Query''',
'         );',
'         apex_debug.log_long_message(',
'              p_message => p_process.attribute_06',
'            , p_level   => apex_debug.c_log_level_info',
'         );',
'      elsif p_process.attribute_03 = ''static''  then',
'         apex_debug.info(',
'              p_message => ''......Static value: %s''',
'            , p0        => p_process.attribute_05',
'         );',
'      elsif p_process.attribute_03 = ''component'' then',
'        apex_debug.info(',
'            p_message => ''......Component Setting: %s''',
'            , p0        => p_plugin.attribute_01',
'         );',
'      end if;',
'',
'      if p_process.attribute_09 is not null then',
'         apex_debug.info(',
'            p_message => ''...Return Instance ID into: %s''',
'            , p0        => p_process.attribute_09',
'         );',
'      end if;',
'',
'      if p_process.attribute_01 in ( ''create'', ''create_and_start'' ) then',
'',
'         if p_process.attribute_08 is not null then',
'            apex_debug.info(',
'               p_message => ''...Process Variable BUSINESS_REF set with item: %s - Session State Value: %s''',
'               , p0        => p_process.attribute_08',
'               , p1        => apex_util.get_session_state( p_process.attribute_08 )',
'            );',
'         end if;',
'      end if;',
'',
'      if p_process.attribute_01 in ( ''create'', ''create_and_start'', ''start'' ) then',
'         apex_debug.info(',
'            p_message => ''...Set Process Variables: %s''',
'            , p0        => p_process.attribute_10',
'         );',
'         if p_process.attribute_10 = ''json'' then',
'            apex_debug.info(',
'               p_message => ''......JSON''',
'            );',
'            apex_debug.log_long_message(',
'               p_message => p_process.attribute_11',
'               , p_level   => apex_debug.c_log_level_info',
'            );',
'         elsif p_process.attribute_10 = ''sql'' then',
'            apex_debug.info(',
'               p_message => ''......Query''',
'            );',
'            apex_debug.log_long_message(',
'               p_message => p_process.attribute_12',
'               , p_level   => apex_debug.c_log_level_info',
'            );',
'         end if;',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => '' < Process plug-in attributes''',
'      );',
'   end log_attributes;',
'',
'   function execution (',
'      p_process  in  apex_plugin.t_process',
'    , p_plugin   in  apex_plugin.t_plugin',
'   ) return apex_plugin.t_process_exec_result ',
'   as',
'      l_result          apex_plugin.t_process_exec_result;',
'',
'      --exceptions',
'      e_missing_version          exception;',
'      e_incorrect_variable_type  exception;',
'',
'      --attributes',
'      l_attribute1      p_process.attribute_01%type := p_process.attribute_01; -- Action (create/start/create_and_start/reset/delete)',
'      l_attribute2      p_process.attribute_02%type := p_process.attribute_02; -- Flow Instance Name',
'      l_attribute3      p_process.attribute_03%type := p_process.attribute_03; -- Select Flow using (static/item/sql/component)',
'      l_attribute4      p_process.attribute_04%type := p_process.attribute_04; -- APEX item(s) for Instance or Diagram',
'      l_attribute5      p_process.attribute_05%type := p_process.attribute_05; -- Static Text for Instance or Diagram',
'      l_attribute6      p_process.attribute_06%type := p_process.attribute_06; -- SQL Query for Instance or Diagram',
'      l_attribute7      p_process.attribute_07%type := p_process.attribute_07; -- Flow (Diagram) selection based on',
'      l_attribute8      p_process.attribute_08%type := p_process.attribute_08; -- Set Business Reference',
'      l_attribute9      p_process.attribute_09%type := p_process.attribute_09; -- Return Instance ID',
'      l_attribute10     p_process.attribute_10%type := p_process.attribute_10; -- Set Process Variables (json/sql)',
'      l_attribute11     p_process.attribute_11%type := p_process.attribute_11; -- JSON (variables)',
'      l_attribute12     p_process.attribute_12%type := p_process.attribute_12; -- SQL (variables)',
'',
'      l_g_attribute1    p_plugin.attribute_01%type  := p_plugin.attribute_01;  -- Global Flow',
'',
'      l_context                  apex_exec.t_context;',
'      l_dgrm_id                  flow_diagrams.dgrm_id%type;',
'      l_dgrm_name                flow_diagrams.dgrm_name%type;',
'      l_dgrm_version             flow_diagrams.dgrm_version%type;',
'      l_prcs_name                flow_processes.prcs_name%type;',
'      l_prcs_id                  flow_processes.prcs_id%type;',
'      l_json                     clob;',
'      l_process_variables        json_array_t;',
'      l_process_variables_count  number;',
'      l_process_variable         json_object_t;',
'      l_var_name                 varchar2(4000);',
'      l_var_type                 varchar2(4000);',
'      l_split_values             apex_t_varchar2;',
'',
'   begin',
'',
'      --debug',
'      log_attributes(',
'           p_plugin   => p_plugin',
'         , p_process  => p_process',
'      );',
'',
'      apex_debug.info(',
'         p_message => '' > Start %s instance.''',
'         , p0      => case l_attribute1',
'                         when ''start'' then ''starting''',
'                         when ''delete'' then ''deleting''',
'                         when ''reset'' then ''reseting''',
'                         when ''terminate'' then ''terminating''',
'                         when ''create'' then ''creating''',
'                         when ''create_and_start'' then ''creating and starting''',
'                      end  ',
'      );',
'',
'      if l_attribute3 = ''item'' then',
'         if l_attribute1 in ( ''start'', ''delete'', ''reset'', ''terminate'' ) then',
'            l_prcs_id  := apex_util.get_session_state( p_item => l_attribute4 );',
'         else',
'            --Flow is define by name only',
'            if l_attribute7 = ''name'' then',
'               l_dgrm_name := apex_util.get_session_state( p_item => l_attribute4 );',
'            --Flow is define by name and version',
'            elsif l_attribute7 = ''name_and_version'' then',
'               --Value is coma separated',
'               l_split_values  := apex_string.split( l_attribute4, '','' );',
'               --Check if item value contains two values otherwise raise error',
'               if (l_split_values.count != 2) then',
'                  raise e_missing_version;',
'               end if;',
'               l_dgrm_name     := apex_util.get_session_state(p_item => l_split_values(1));',
'               l_dgrm_version  := apex_util.get_session_state(p_item => l_split_values(2));',
'            -- Flow is define by id',
'            elsif l_attribute7 = ''id'' then',
'               --Add test number to raise error',
'               l_dgrm_id := apex_util.get_session_state( p_item => l_attribute4 );',
'            end if;',
'         end if;',
'   ',
'      elsif l_attribute3 = ''sql'' then',
'         l_context         := apex_exec.open_query_context(',
'            p_location   => apex_exec.c_location_local_db',
'         , p_sql_query  => l_attribute6',
'         );',
'',
'         while apex_exec.next_row(l_context) loop',
'            if l_attribute1 in ( ''start'', ''delete'', ''reset'', ''terminate'' ) then',
'               l_prcs_id  := apex_exec.get_number(l_context, 1);',
'            else',
'               if l_attribute7 in ( ''name'', ''name_and_version'' ) then',
'                  l_dgrm_name := apex_exec.get_varchar2( l_context, 1 );',
'                  -- Flow is define by name & version, second column contains flow version',
'                  if l_attribute7 = ''name_and_version'' then',
'                     l_dgrm_version := apex_exec.get_varchar2( l_context, 2 );',
'                  end if;',
'               else',
'                  -- Flow is define by id, first column contains flow id',
'                  l_dgrm_id := apex_exec.get_number( l_context, 1 );',
'               end if;',
'            end if;',
'         end loop;',
'         apex_exec.close(l_context);',
'',
'      elsif l_attribute3 = ''static'' then',
'         if l_attribute1 in ( ''start'', ''delete'', ''reset'', ''terminate'' ) then',
'            l_prcs_id := l_attribute5;',
'         else',
'            --Flow is define by name only',
'            if l_attribute7 = ''name'' then',
'               l_dgrm_name := l_attribute5;',
'            --Flow is define by name & version, coma separated',
'            elsif l_attribute7 = ''name_and_version'' then',
'               l_split_values  := apex_string.split( l_attribute5, '','');',
'               --Check if item value contains two values otherwise raise error',
'               if l_split_values.count != 2 then',
'                  raise e_missing_version;',
'               end if;',
'               l_dgrm_name     := l_split_values(1);',
'               l_dgrm_version  := l_split_values(2);',
'            -- Flow is define by id',
'            elsif l_attribute7 = ''id'' then',
'               l_dgrm_id := l_attribute5;',
'            end if;',
'         end if;',
'      elsif l_attribute3 = ''component'' then',
'         if l_attribute1 in ( ''start'', ''delete'', ''reset'', ''terminate'' ) then',
'            l_prcs_id := l_g_attribute1;',
'         else',
'            --Flow is define by name only',
'            if l_attribute7 = ''name'' then',
'               l_dgrm_name := l_g_attribute1;',
'            --Flow is define by name & version',
'            elsif l_attribute7 = ''name_and_version'' then',
'               l_split_values  := apex_string.split( l_g_attribute1, '','' );',
'               --Check if item value contains two values otherwise raise error',
'               if l_split_values.count != 2 then',
'                  raise e_missing_version;',
'               end if;',
'               l_dgrm_name     := l_split_values(1);',
'               l_dgrm_version  := l_split_values(2);',
'            -- Flow is define by id',
'            elsif l_attribute7 = ''id'' then',
'               l_dgrm_id := l_g_attribute1;',
'            end if;',
'         end if;',
'      end if;',
'      ',
'      if l_attribute1 = ''delete'' then',
'         -- Call API to delete the instance',
'         apex_debug.info(',
'            p_message => ''...Delete Flow Instance Id %s''',
'            , p0        => l_prcs_id',
'         );',
'         flow_api_pkg.flow_delete(',
'            p_process_id  => l_prcs_id',
'         );',
'      elsif l_attribute1 = ''start'' then',
'         -- Call API to start the instance',
'         apex_debug.info(',
'            p_message => ''...Start Flow Instance Id %s''',
'            , p0        => l_prcs_id',
'         );',
'         flow_api_pkg.flow_start(',
'            p_process_id  => l_prcs_id',
'         );',
'      elsif l_attribute1 = ''reset'' then',
'         -- Call API to reset the instance',
'         apex_debug.info(',
'            p_message => ''...Reset Flow Instance Id %s''',
'            , p0        => l_prcs_id',
'         );',
'         flow_api_pkg.flow_reset(',
'            p_process_id  => l_prcs_id',
'         );',
'      elsif l_attribute1 = ''terminate'' then',
'         -- Call API to terminate the instance',
'         apex_debug.info(',
'            p_message => ''...Terminate Flow Instance Id %s''',
'            , p0        => l_prcs_id',
'         );',
'         flow_api_pkg.flow_terminate(',
'            p_process_id  => l_prcs_id',
'         );',
'      elsif l_attribute1 in ( ''create'', ''create_and_start'' ) then',
'         apex_debug.info(',
'            p_message => ''...Retrieve FLow Instance Name''',
'         );',
'         l_prcs_name := l_attribute2;',
'',
'         --Create flow instance',
'         if l_attribute7 in ( ''name'', ''name_and_version'' ) then',
'            l_dgrm_name := trim( l_dgrm_name );',
'            l_dgrm_version := trim( l_dgrm_version );',
'               ',
'            apex_debug.info(',
'                 p_message => ''...Create Flow instance "%s" with diagram: %s %s''',
'               , p0        => l_prcs_name',
'               , p1        => l_dgrm_name',
'               , p2        => case when l_dgrm_version is not null then apex_string.format( p_message => ''(version %s)'', p0 => l_dgrm_version) end',
'            );',
'',
'            l_prcs_id :=',
'               flow_api_pkg.flow_create(',
'                 pi_dgrm_name     => l_dgrm_name',
'               , pi_dgrm_version  => l_dgrm_version',
'               , pi_prcs_name     => l_prcs_name',
'            );',
'         else',
'            apex_debug.info(',
'               p_message => ''...Create Flow instance "%s" with diagram id: %s''',
'               , p0      => l_prcs_name',
'               , p1      => l_dgrm_id',
'            );',
'',
'            l_prcs_id := flow_api_pkg.flow_create(',
'               pi_dgrm_id    => l_dgrm_id',
'            , pi_prcs_name  => l_prcs_name',
'            );',
'         end if;',
'',
'         apex_debug.info(',
'            p_message => '' < Flow instance %s created.''',
'            , p0      => l_prcs_id',
'         );',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => '' > Additional actions.''',
'         , p0        => l_prcs_id',
'      );',
'',
'      -- Return instance id in the APEX item provided',
'      if ( l_attribute9 is not null ) then',
'         apex_debug.info(',
'            p_message => ''...Return Flow Instance Id into item "%s"''',
'         , p0        => l_attribute9',
'         );',
'         apex_util.set_session_state( l_attribute9, l_prcs_id );',
'      end if;',
'',
'      if l_attribute1 in ( ''create'', ''create_and_start'', ''start'' ) then',
'',
'         --Get JSON for process variables',
'         if ( l_attribute10 = ''json'' ) then',
'            l_json := l_attribute11;',
'         elsif ( l_attribute10 = ''sql'' ) then',
'            l_context := apex_exec.open_query_context(',
'               p_location   => apex_exec.c_location_local_db',
'            , p_sql_query  => l_attribute12',
'            );',
'',
'            while apex_exec.next_row(l_context) loop',
'               l_json := apex_exec.get_clob(l_context, 1);',
'            end loop;',
'            apex_exec.close(l_context);',
'         end if;',
'',
'         --Set process variables',
'         if ( l_attribute10 in (',
'                  ''json'', ''sql''',
'               ) ) then',
'            apex_debug.info(',
'               p_message => ''...Start setting Flow Instance Variable(s)''',
'            );',
'            l_process_variables        := json_array_t(l_json);',
'            l_process_variables_count  := l_process_variables.get_size();',
'            for object in 0..l_process_variables_count - 1 loop',
'               l_process_variable  := json_object_t(l_process_variables.get(object));',
'               l_var_name          := l_process_variable.get_string(''name'');',
'               l_var_type          := l_process_variable.get_string(''type'');',
'               case l_var_type',
'                  when ''varchar2'' then',
'                     apex_debug.info(',
'                        p_message => ''.....Name: %s - Type: %s - Value %s''',
'                        , p0 => l_var_name',
'                        , p1 => l_var_type',
'                        , p2 => l_process_variable.get_string(''value'')',
'                     );',
'                     flow_process_vars.set_var(',
'                        pi_prcs_id    => l_prcs_id',
'                     , pi_var_name   => l_var_name',
'                     , pi_vc2_value  => l_process_variable.get_string(''value'')',
'                     );',
'                  when ''number'' then',
'                     apex_debug.info(',
'                        p_message => ''......Name: %s - Type: %s - Value %s''',
'                        , p0 => l_var_name',
'                        , p1 => l_var_type',
'                        , p2 => l_process_variable.get_number(''value'')',
'                     );',
'                     flow_process_vars.set_var(',
'                        pi_prcs_id    => l_prcs_id',
'                     , pi_var_name   => l_var_name',
'                     , pi_num_value  => l_process_variable.get_number(''value'')',
'                     );',
'                  when ''date'' then',
'                     apex_debug.info(',
'                        p_message => ''......Name: %s - Type: %s - Value %s''',
'                        , p0 => l_var_name',
'                        , p1 => l_var_type',
'                        , p2 => l_process_variable.get_date(''value'')',
'                     );',
'                     flow_process_vars.set_var(',
'                        pi_prcs_id     => l_prcs_id',
'                     , pi_var_name    => l_var_name',
'                     , pi_date_value  => l_process_variable.get_date(''value'')',
'                     );',
'                  when ''clob'' then',
'                     apex_debug.info(',
'                        p_message => ''......Name: %s - Type: %s - Value %s''',
'                        , p0 => l_var_name',
'                        , p1 => l_var_type',
'                        , p2 => l_process_variable.get_clob(''value'')',
'                     );',
'                     flow_process_vars.set_var(',
'                        pi_prcs_id     => l_prcs_id',
'                     , pi_var_name    => l_var_name',
'                     , pi_clob_value  => l_process_variable.get_clob(''value'')',
'                     );',
'                '))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'  else',
'                     raise e_incorrect_variable_type;',
'               end case;',
'            end loop;',
'            apex_debug.info(',
'               p_message => ''...End setting Flow Instance Variable(s)''',
'            );',
'         end if;',
'',
'         if l_attribute1 in ( ''create'', ''create_and_start'' ) and l_attribute8 is not null then',
'            apex_debug.info(',
'               p_message => ''...Setting BUSINESS_REF Variable: "%s"''',
'            , p0        => apex_util.get_session_state(l_attribute8)',
'            );',
'            flow_process_vars.set_var(',
'               pi_prcs_id    => l_prcs_id',
'            , pi_var_name   => ''BUSINESS_REF''',
'            , pi_vc2_value  => apex_util.get_session_state(l_attribute8)',
'            );',
'         end if;',
'',
'         --Start flow instance',
'         if l_attribute1 = ''create_and_start'' then',
'            apex_debug.info(',
'               p_message => ''...Starting Flow Instance %s''',
'            , p0        => l_prcs_id',
'            );',
'            flow_api_pkg.flow_start(p_process_id => l_prcs_id);',
'         end if;',
'',
'      end if;',
'',
'      apex_debug.info(',
'            p_message => '' < Additional actions.''',
'            , p0      => l_prcs_id',
'         );',
'',
'      return l_result;',
'   exception ',
'      when e_missing_version then',
'         if apex_application.g_debug then',
'            apex_debug.error(',
'               p_message => ''-- Flows4apex - Plug-in configuration issue, diagram selection is done with name and version but version is not provided.''',
'            );',
'         end if;',
'         apex_error.add_error( ',
'              p_message => ''Version not defined.''',
'            , p_display_location => apex_error.c_on_error_page',
'         );',
'      when e_incorrect_variable_type then',
'         if apex_application.g_debug then',
'            apex_debug.error(',
'               p_message => ''-- Flows4apex - Plug-in configuration issue, process variables JSON contains incorrect variable type.''',
'            );',
'         end if;',
'         apex_error.add_error(',
'              p_message           => ''Error during parsing process variables.''',
'            , p_display_location  => apex_error.c_on_error_page',
'         );',
'   end execution;',
'   ',
'end flow_plugin_manage_instance;',
'/',
'',
'create or replace package body flow_plugin_manage_instance_step as',
'   ',
'   procedure log_attributes(',
'      p_process  in  apex_plugin.t_process',
'    , p_plugin   in  apex_plugin.t_plugin',
'   )',
'   is',
'   begin',
'      apex_debug.info(',
'           p_message => '' > Process plug-in attributes''',
'      );',
'      apex_debug.info(',
'           p_message => ''...Flow Instance & Subflow define by: %s''',
'         , p0        => p_process.attribute_01',
'      );',
'',
'      if p_process.attribute_01 = ''item'' then ',
'         apex_debug.info(',
'            p_message => ''......Flow Instance Item used: %s - Session state value: %s''',
'            , p0        => p_process.attribute_02',
'            , p1        => apex_util.get_session_state(p_item => p_process.attribute_02)',
'         );',
'         apex_debug.info(',
'            p_message => ''......Subflow Item used: %s - Session state value: %s''',
'            , p0        => p_process.attribute_03',
'            , p1        => apex_util.get_session_state(p_item => p_process.attribute_03)',
'         );',
'      elsif p_process.attribute_01 = ''sql''  then',
'         apex_debug.info(',
'            p_message => ''......Query''',
'         );',
'         apex_debug.log_long_message(',
'              p_message => p_process.attribute_03',
'            , p_level   => apex_debug.c_log_level_info',
'         );',
'      elsif p_process.attribute_01 = ''static''  then',
'         apex_debug.info(',
'              p_message => ''......Static value: %s''',
'            , p0        => p_process.attribute_04',
'         );',
'      elsif p_process.attribute_01 = ''component'' then',
'        apex_debug.info(',
'            p_message => ''......Component Setting: %s''',
'            , p0        => p_plugin.attribute_01',
'         );',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => ''...Flow Instance action: %s''',
'         , p0        => p_process.attribute_05',
'      );',
'',
'      if ( p_process.attribute_05 = ''complete'' ) then',
'         apex_debug.info(',
'            p_message => ''...Set Gateway route?: %s''',
'            , p0        => p_process.attribute_06',
'         );',
'',
'         if ( p_process.attribute_06 = ''Y'' ) then',
'            if ( p_process.attribute_07 is not null ) then',
'               apex_debug.info(',
'                  p_message => ''......Gateway "%s"''',
'                  , p0        => p_process.attribute_07',
'               );',
'            else',
'               apex_debug.info(',
'                  p_message => ''......No Gateway define, next gateway will be used.''',
'               );',
'            end if;',
'         end if;',
'         apex_debug.info(',
'            p_message => ''......Route %s''',
'            , p0        => p_process.attribute_08',
'         );',
'',
'         apex_debug.info(',
'            p_message => ''...Auto branching?: %s''',
'            , p0        => p_process.attribute_09',
'         );',
'      elsif ( p_process.attribute_05 = ''reserve'' ) then',
'         apex_debug.info(',
'            p_message => ''...Reservation define by: %s''',
'            , p0        => p_process.attribute_10',
'         );',
'         if ( p_process.attribute_10 = ''static'' ) then',
'            apex_debug.info(',
'                 p_message => ''......Static value: %s''',
'               , p0        => p_process.attribute_11',
'            );',
'         elsif ( p_process.attribute_10 = ''item'' )  then',
'            apex_debug.info(',
'               p_message => ''......Reservation Item used: %s - Session state value: %s''',
'               , p0        => p_process.attribute_12',
'               , p1        => apex_util.get_session_state(p_item => p_process.attribute_12)',
'            );',
'         elsif ( p_process.attribute_10 = ''sql'' )  then',
'            apex_debug.info(',
'               p_message => ''......Query''',
'            );',
'            apex_debug.log_long_message(',
'                 p_message => p_process.attribute_13',
'               , p_level   => apex_debug.c_log_level_info',
'            );',
'         end if;',
'      end if;',
'',
'      if p_process.attribute_11 is not null then',
'         apex_debug.info(',
'            p_message => ''...Return Flow Instance ID and Subflow ID into: %s''',
'            , p0        => p_process.attribute_11',
'         );',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => '' < Process plug-in attributes''',
'      );',
'   end log_attributes;',
'',
'   function execution (',
'      p_process  in  apex_plugin.t_process',
'    , p_plugin   in  apex_plugin.t_plugin',
'   ) return apex_plugin.t_process_exec_result ',
'   as',
'      l_result          apex_plugin.t_process_exec_result;',
'',
'      --exceptions',
'      e_no_gateway         exception;',
'      e_gateway_not_exists exception;',
'      e_no_flow            exception;',
'',
'      --attributes',
'      l_attribute1      p_process.attribute_01%type := p_process.attribute_01; -- Flow instance selection (APEX item/SQL)',
'      l_attribute2      p_process.attribute_02%type := p_process.attribute_02; -- Process ID (APEX item)',
'      l_attribute3      p_process.attribute_03%type := p_process.attribute_03; -- Subflow ID (APEX item)',
'      l_attribute4      p_process.attribute_04%type := p_process.attribute_04; -- SQL query (2 columns process id and subflow id)',
'      l_attribute5      p_process.attribute_05%type := p_process.attribute_05; -- Action (complete/reserve/release)',
'      l_attribute6      p_process.attribute_06%type := p_process.attribute_06; -- Set Gateway route? (Y/N)',
'      l_attribute7      p_process.attribute_07%type := p_process.attribute_07; -- Gateway ID',
'      l_attribute8      p_process.attribute_08%type := p_process.attribute_08; -- Route ID',
'      l_attribute9      p_process.attribute_09%type := p_process.attribute_09; -- Auto branching (Y/N)',
'      l_attribute10     p_process.attribute_10%type := p_process.attribute_10; -- Reservation ',
'      l_attribute11     p_process.attribute_11%type := p_process.attribute_11; -- Return Flow Instance and Subflow ID ',
'',
'      l_process_id      flow_processes.prcs_id%type;',
'      l_subflow_id      flow_subflows.sbfl_id%type;',
'      l_dgrm_id         flow_processes.prcs_dgrm_id%type;',
'      l_gateway_name    flow_objects.objt_bpmn_id%type;',
'      l_gateway_exists  number;',
'      l_context         apex_exec.t_context;',
'      l_url             varchar2(4000);',
'      l_split_items     apex_t_varchar2;',
'',
'       type flow_step_info is record (',
'           dgrm_id            flow_diagrams.dgrm_id%type',
'         , source_objt_tag    flow_objects.objt_tag_name%type',
'         , source_lane_id     flow_objects.objt_objt_lane_id%type',
'         , target_objt_id     flow_objects.objt_id%type',
'         , target_objt_ref    flow_objects.objt_bpmn_id%type',
'         , target_objt_tag    flow_objects.objt_tag_name%type',
'         , target_objt_subtag flow_objects.objt_sub_tag_name%type',
'         , target_lane_id     flow_objects.objt_objt_lane_id%type',
'      );',
'      l_step_info       flow_step_info;',
'',
'      l_reservation flow_subflows.sbfl_reservation%type;',
'   begin',
'',
'      --debug',
'      log_attributes(',
'           p_plugin  => p_plugin',
'         , p_process => p_process',
'      );',
'',
'      apex_debug.info(',
'         p_message => ''...Retrieve FLow Instance Id and Subflow Id''',
'      );',
'      -- Get process Id and subflow Id',
'      if ( l_attribute1 = ''item'' ) then',
'         l_process_id  := apex_util.get_session_state(p_item => l_attribute2);',
'         l_subflow_id  := apex_util.get_session_state(p_item => l_attribute3);',
'      elsif ( l_attribute1 = ''sql'' ) then',
'         l_context         := apex_exec.open_query_context(',
'            p_location   => apex_exec.c_location_local_db',
'          , p_sql_query  => l_attribute4',
'         );',
'',
'         while apex_exec.next_row(l_context) loop',
'            l_process_id  := apex_exec.get_number(l_context, 1);',
'            l_subflow_id  := apex_exec.get_number(l_context, 2);',
'         end loop;',
'         apex_exec.close(l_context);',
'      end if;',
'',
'      --Raise error if unable to find process id or subflow id',
'      if l_process_id is null or l_subflow_id is null then',
'         raise e_no_flow;',
'      end if;',
'',
'      if ( l_attribute5 = ''complete'' ) then',
'         -- Get step informations',
'         select prcs.prcs_dgrm_id',
'            , objt_source.objt_tag_name',
'            , objt_source.objt_objt_lane_id',
'            , conn.conn_tgt_objt_id',
'            , objt_target.objt_bpmn_id',
'            , objt_target.objt_tag_name',
'            , objt_target.objt_sub_tag_name',
'            , objt_target.objt_objt_lane_id',
'         into l_step_info',
'         from flow_connections conn',
'         join flow_objects objt_source',
'            on conn.conn_src_objt_id = objt_source.objt_id',
'            and conn.conn_dgrm_id = objt_source.objt_dgrm_id',
'         join flow_objects objt_target',
'            on conn.conn_tgt_objt_id = objt_target.objt_id',
'            and conn.conn_dgrm_id = objt_target.objt_dgrm_id',
'         join flow_processes prcs',
'            on prcs.prcs_dgrm_id = conn.conn_dgrm_id',
'         join flow_subflows sbfl',
'            on sbfl.sbfl_current = objt_source.objt_bpmn_id',
'            and sbfl.sbfl_prcs_id = prcs.prcs_id',
'         where conn.conn_tag_name = flow_constants_pkg.gc_bpmn_sequence_flow',
'            and prcs.prcs_id = l_process_id',
'            and sbfl.sbfl_id = l_subflow_id;',
'',
'         --Set the gateway route',
'         if ( l_attribute6 = ''Y'' ) then',
'            l_gateway_name := l_attribute7;',
'',
'            -- If attribute 6 is filled, check if gateway define exists',
'            if ( l_gateway_name is not null ) then',
'',
'               select count(*)',
'               into l_gateway_exists',
'               from flow_processes prcs',
'               join flow_objects obj on obj.objt_dgrm_id = prcs.prcs_dgrm_id',
'               where prcs.prcs_id = l_process_id',
'               and obj.objt_tag_name in (flow_constants_pkg.gc_bpmn_gateway_exclusive, flow_constants_pkg.gc_bpmn_gateway_inclusive)',
'               and obj.objt_bpmn_id = l_gateway_name;',
'',
'               if ( l_gateway_exists = 0) then',
'                  raise e_gateway_not_exists;',
'               end if;',
'            end if;',
'            ',
'            --Gateway attribute is not filled so we look at the next target object if it''s exclusive or inclusive gateway',
'            if (',
'               l_attribute7 is null and l_step_info.target_objt_tag in (',
'                        flow_constants_pkg.gc_bpmn_gateway_exclusive, flow_constants_pkg.gc_bpmn_gateway_inclusive',
'                     )',
'            ) then',
'               l_gateway_name := l_step_info.target_objt_ref;',
'            end if;',
'',
'            if ( l_gateway_name is not null ) then',
'',
'               apex_debug.info(',
'                  p_message => ''...Setting Flow Instance Variable "%s" value "%s"''',
'                  , p0      => l_gateway_name || '':route''',
'                  , p1      => l_attribute8',
'               );',
'',
'               flow_process_vars.set_var(',
'                  pi_prcs_id    => l_process_id',
'               , pi_var_name   => l_gateway_name || '':route''',
'               , pi_vc2_value  => l_attribute8',
'               );',
'            else',
'               raise e_no_gateway;',
'            end if;',
'         end if;',
'',
'         apex_debug.info(',
'              p_message => ''...Complete Step - Flow Instance Id %s - Subflow Id %s''',
'            , p0        => l_process_id',
'            , p1        => l_subflow_id',
'         );',
'         -- Call API to complete the step',
'         flow_api_pkg.flow_complete_step(',
'            p_process_id  => l_process_id',
'         , p_subflow_id  => l_subflow_id',
'         );',
'',
'         -- Auto-branching',
'         -- Only if next object is a user task and it''s on the same lane than the current step',
'         if (',
'            l_attribute9 = ''Y'' and l_step_info.target_objt_tag = flow_constants_pkg.gc_bpmn_usertask and ( ( l_step_info.source_lane_id =',
'            l_step_info.target_lane_id ) or (',
'               l_step_info.source_lane_id is null and l_step_info.target_lane_id is null',
'            ) )',
'         ) then',
'            -- Get APEX page url',
'            l_url :=',
'               flow_usertask_pkg.get_url(',
'                  pi_prcs_id  => l_process_id',
'               , pi_sbfl_id  => l_subflow_id',
'               , pi_objt_id  => l_step_info.target_objt_id',
'               );',
'            apex_debug.info(',
'                 p_message => ''...Redirecting to %s''',
'               , p0        => l_url',
'            );',
'            -- Redirect',
'            apex_util.redirect_url(p_url => l_url);',
'         end if;',
'',
'      elsif ( l_attribute5 = ''reserve'' ) then',
'         l_reservation := l_attribute10;',
'',
'         apex_debug.info(',
'              p_message => ''...Reserve Step - Flow Instance Id %s - Subflow Id %s''',
'            , p0        => l_process_id',
'            , p1        => l_subflow_id',
'         );',
'',
'         flow_api_pkg.flow_reserve_step(',
'            p_process_id    => l_process_id',
'            , p_subflow_id  => l_subflow_id',
'            , p_reservation => l_reservation',
'         );',
'',
'      elsif ( l_attribute5 = ''release'' ) then',
'         apex_debug.info(',
'              p_message => ''...Release Step - Flow Instance Id %s - Subflow Id %s''',
'            , p0        => l_process_id',
'            , p1        => l_subflow_id',
'         );',
'',
'         flow_api_pkg.flow_release_step(',
'              p_process_id => l_process_id',
'            , p_subflow_id => l_subflow_id',
'         );',
'      end if;',
'',
'      -- Return Flow Instance Id and Subflow Id in the APEX items provided',
'      if ( l_attribute11 is not null ) then',
'         l_split_items := apex_string.split( l_attribute11, '','' );',
'         apex_debug.info(',
'            p_message => ''...Return Flow Instance Id into item "%s"''',
'         , p0        => l_split_items(1)',
'         );',
'         apex_util.set_session_state( l_split_items(1), l_process_id );',
'',
'         if l_split_items.count() = 2 then',
'            apex_debug.info(',
'               p_message => ''...Return Subflow Id into item "%s"''',
'            , p0        => l_split_items(2)',
'            );',
'            apex_util.set_session_state( l_split_items(2), l_subflow_id );',
'         end if;',
'      end if;',
'',
'      return l_result;',
'   exception ',
'      when e_no_gateway then',
'         apex_error.add_error( ',
'              p_message => ''Gateway is not define for routing.''',
'            , p_display_location => apex_error.c_on_error_page',
'         );',
'      when e_gateway_not_exists then',
'         apex_error.add_error( ',
'              p_message => ''Gateway define does not exists for this flow.''',
'            , p_display_location => apex_error.c_on_error_page',
'         );',
'      when e_no_flow then',
'         apex_error.add_error( ',
'              p_message => ''Unable to get Flow Instance Id and or subflow Id to manage the step.''',
'            , p_display_location => apex_error.c_on_error_page',
'         );',
'   end execution;',
'   ',
'end flow_plugin_manage_instance_step;',
'/',
'',
'create or replace package body flow_plugin_manage_instance_variables as',
'',
'   procedure log_attributes(',
'      p_process  in  apex_plugin.t_process',
'    , p_plugin   in  apex_plugin.t_plugin',
'   )',
'   is',
'   begin',
'      apex_debug.info(',
'           p_message => '' > Process plug-in attributes''',
'      );',
'      apex_debug.info(',
'           p_message => ''...Flow Instance define by: %s''',
'         , p0        => p_process.attribute_01',
'      );',
'',
'      if p_process.attribute_01 = ''item'' then ',
'         apex_debug.info(',
'            p_message => ''......Flow Instance Item used: %s - Session state value: %s''',
'            , p0        => p_process.attribute_02',
'            , p1        => apex_util.get_session_state(p_item => p_process.attribute_02)',
'         );',
'      elsif p_process.attribute_01 = ''sql''  then',
'         apex_debug.info(',
'            p_message => ''......Query''',
'         );',
'         apex_debug.log_long_message(',
'              p_message => p_process.attribute_03',
'            , p_level   => apex_debug.c_log_level_info',
'         );',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => ''...Flow Instance Variables action: %s''',
'         , p0        => p_process.attribute_04',
'      );',
'',
'      apex_debug.info(',
'           p_message => ''...Manage Flow Instance Variables using: %s''',
'         , p0        => p_process.attribute_05',
'      );',
'',
'      if p_process.attribute_05 = ''item'' then ',
'         apex_debug.info(',
'            p_message => ''......Flow Instance Variable(s): %s''',
'            , p0        => p_process.attribute_06',
'         );',
'         apex_debug.info(',
'            p_message => ''......APEX item(s): %s''',
'            , p0        => p_process.attribute_07',
'         );',
'      elsif p_process.attribute_01 = ''sql''  then',
'         apex_debug.info(',
'            p_message => ''......Query''',
'         );',
'         apex_debug.log_long_message(',
'              p_message => p_process.attribute_08',
'            , p_level   => apex_debug.c_log_level_info',
'         );',
'      elsif p_process.attribute_01 = ''json''  then',
'         apex_debug.info(',
'            p_message => ''......JSON''',
'         );',
'         apex_debug.log_long_message(',
'              p_message => p_process.attribute_09',
'            , p_level   => apex_debug.c_log_level_info',
'         );',
'      end if;',
'',
'      if p_process.attribute_10 is not null then',
'         apex_debug.info(',
'            p_message => ''...Return Instance ID into: %s''',
'            , p0        => p_process.attribute_10',
'         );',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => '' < Process plug-in attributes''',
'      );',
'   end log_attributes;',
'   ',
'   function execution (',
'      p_process  in  apex_plugin.t_process',
'    , p_plugin   in  apex_plugin.t_plugin',
'   ) return apex_plugin.t_process_exec_result ',
'   as',
'      l_result  apex_plugin.t_process_exec_result;',
'      l_context apex_exec.t_context;',
'',
'      --attributes',
'      l_attribute1  p_process.attribute_01%type := p_process.attribute_01; -- Flow instance selection (APEX item/SQL)',
'      l_attribute2  p_process.attribute_02%type := p_process.attribute_02; -- Process ID (APEX item)',
'      l_attribute3  p_process.attribute_03%type := p_process.attribute_03; -- SQL query (1 column process id)',
'      l_attribute4  p_process.attribute_04%type := p_process.attribute_04; -- Action (get/set)',
'      l_attribute5  p_process.attribute_05%type := p_process.attribute_05; -- Manage Process Variables using',
'      l_attribute6  p_process.attribute_06%type := p_process.attribute_06; -- Process Variable(s) Name(s)',
'      l_attribute7  p_process.attribute_07%type := p_process.attribute_07; -- APEX item(s)',
'      l_attribute8  p_process.attribute_08%type := p_process.attribute_08; -- JSON',
'      l_attribute9  p_process.attribute_09%type := p_process.attribute_09; -- SQL query (1 column JSON array)',
'      l_attribute10 p_process.attribute_10%type := p_process.attribute_10; -- Return instance Id into',
'',
'      --exceptions',
'      e_var_config              exception;',
'      e_incorrect_variable_type exception;',
'      e_types_different         exception;',
'      e_invalid_number          exception;',
'      e_invalid_date            exception;',
'',
'      --types',
'      type t_prcs_var is table of varchar2(50) index by varchar2(50);',
'      type t_item     is record (item_type varchar2(50), format_mask varchar(50));',
'      type t_items    is table of t_item index by varchar2(50);',
'',
'      --collections',
'      l_prcs_var t_prcs_var;',
'      l_items    t_items;',
'',
'      --json',
'      l_json              clob;',
'      l_process_variables json_array_t;',
'      l_process_variable  json_object_t;',
'      l_json_element      json_element_t;',
'',
'      --variables',
'      l_prcs_id         flow_processes.prcs_id%type;',
'      l_prcs_var_type   flow_process_variables.prov_var_type%type;',
'      l_prcs_var_name   flow_process_variables.prov_var_name%type;',
'      l_split_prcs_var  apex_t_varchar2;',
'      l_split_items     apex_t_varchar2;',
'      l_item_name       varchar2(4000);',
'      l_format_mask     apex_application_page_items.format_mask%type;',
'      l_types_different number;',
'      l_ts              timestamp;',
'   begin',
'',
'      --debug',
'      log_attributes(',
'         p_plugin   => p_plugin',
'       , p_process  => p_process',
'      );',
'',
'',
'      apex_debug.info(',
'         p_message => ''...Retrieve FLow Instance Id''',
'      );',
'      -- Get process Id and subflow Id',
'      if ( l_attribute1 = ''item'' ) then',
'         l_prcs_id  := apex_util.get_session_state(p_item => l_attribute2);',
'      elsif ( l_attribute1 = ''sql'' ) then',
'         l_context         := apex_exec.open_query_context(',
'            p_location   => apex_exec.c_location_local_db',
'          , p_sql_query  => l_attribute3',
'         );',
'',
'         while apex_exec.next_row(l_context) loop',
'            l_prcs_id  := apex_exec.get_number(l_context, 1);',
'         end loop;',
'         apex_exec.close(l_context);',
'      end if;',
'',
'      apex_debug.info(',
'           p_message => ''...Flow Instance Id is %s''',
'         , p0        => l_prcs_id',
'      );',
'',
'      apex_debug.info(',
'           p_message => ''...Start %s Flow Instance Variable(s)''',
'         , p0        => case l_attribute4',
'                           when ''set'' then ''setting''',
'                           when ''get'' then ''getting''',
'                        end',
'      );',
'      --Set process variables',
'      if ( l_attribute5 in (',
'                ''json'', ''sql''',
'             ) ) then',
'         ',
'         --Get JSON for process variables',
'         if ( l_attribute5 = ''json'' ) then',
'            l_json := l_attribute8;',
'         elsif ( l_attribute5 = ''sql'' ) then',
'            l_context := apex_exec.open_query_context(',
'               p_location   => apex_exec.c_location_local_db',
'            , p_sql_query  => l_attribute9',
'            );',
'',
'            while apex_exec.next_row(l_context) loop',
'               l_json := apex_exec.get_clob(l_context, 1);',
'            end loop;',
'            apex_exec.close(l_context);',
'         end if;',
'',
'         ',
'         if ( l_attribute4 = ''set'' ) then',
'            --Check variables types',
'            select count(*)',
'            into l_types_different',
'            from',
'               json_table ( l_json ,',
'               ''$[*]''',
'                  columns (',
'                     name varchar2 ( 4000 ) path ''$.name''',
'                  , type varchar2 ( 4000 ) path ''$.type''',
'                  )',
'               ) set_var',
'               join flow_process_variables prcs_var ',
'               on prcs_var.prov_var_name = set_var.name ',
'               and prcs_var.prov_prcs_id = l_prcs_id',
'               where prcs_var.prov_var_type != upper( set_var.type );',
'            ',
'            -- Raise exception if incoherent value found',
'            if ( l_types_different > 0 ) then',
'               raise e_types_different;',
'            end if;',
'         end if;',
'',
'         l_process_variables        := json_array_t(l_json);',
'         for object in 0..l_process_variables.get_size() - 1 loop',
'            l_process_variable := json_object_t(l_process_variables.get(object));',
'            l_prcs_var_name    := l_process_variable.get_string(''name'');',
'            l_prcs_var_type    := l_process_variable.get_string(''type'');',
'            l_item_name        := l_process_variable.get_string(''item'');',
'            case l_prcs_var_type',
'               when ''varchar2'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then l_process_variable.get_string(''value'')',
'                                 when ''get'' ',
'                                    then flow_process_vars.get_var_vc2(',
'                                              pi_prcs_id  => l_prcs_id',
'                                            , pi_var_name => l_prcs_var_name',
'                                         )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        flow_process_vars.set_var(',
'                           pi_prcs_id   => l_prcs_id',
'                        , pi_var_name   => l_prcs_var_name',
'                        , pi_vc2_value  => l_process_variable.get_string(''value'')',
'                        );',
'                     when ''get'' then',
'                        apex_util.set_session_state( ',
'                             p_name  => l_item_name',
'                           , p_value => flow_process_vars.get_var_vc2(',
'                                             pi_prcs_id  => l_prcs_id',
'                                           , pi_var_name => l_prcs_var_name',
'                                        ) ',
'                        );',
'                  end case;',
'               when ''number'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then l_process_variable.get_number(''value'')',
'                                 when ''get'' ',
'                                    then flow_process_vars.get_var_num(',
'                                              pi_prcs_id  => l_prcs_id',
'                                            , pi_var_name => l_prcs_var_name',
'                                         )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        l_json_element := l_process_variable.get(''value'');',
'                        if ( l_json_element.is_Number() = false ) then',
'                           raise e_invalid_number;',
'                        end if;',
'                        flow_process_vars.set_var(',
'                             pi_prcs_id   => l_prcs_id',
'                           , pi_var_name  => l_prcs_var_name',
'                           , pi_num_value => l_process_variable.get_number(''value'')',
'                        );',
'                     when ''get'' then',
'                        apex_util.set_session_state( ',
'                             p_name  => l_item_name',
'                           , p_value => flow_process_vars.get_var_num(',
'                                             pi_prcs_id  => l_prcs_id',
'                                           , pi_var_name => l_prcs_var_name',
'                                        ) ',
'                        );',
'                  end case;',
'               when ''date'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then l_process_variable.get_date(''value'')',
'                                 when ''get'' ',
'                                    then flow_process_vars.get_var_date(',
'                                              pi_prcs_id  => l_prcs_id',
'                                            , pi_var_name => l_prcs_var_name',
'                                         )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        l_json_element := l_process_variable.get(''value'');',
'                        begin',
'                           if instr( l_process_variable.get_String(''value''), ''T'' ) > 0 then',
'                              l_ts := to_timestamp_tz( replace ( l_process_variable.get_String(''value''), ''T'', '' '' ), ''YYYY-MM-DD HH24:MI:SS TZR'' ); ',
'                           else',
'                              l_ts := to_timestamp_tz( l_process_variable.get_String(''value''), ''YYYY-MM-DD TZR'' ); ',
'                           end if;',
'                        exception when others then',
'                           raise e_invalid_date;',
'                        end;',
'                        flow_process_vars.set_var(',
'                          pi_prcs_id    => l_prcs_id',
'                        , pi_var_name   => l_prcs_var_name',
'                        , pi_date_value => l_process_variable.get_timestamp(''value'')',
'        '))
);
null;
wwv_flow_api.component_end;
end;
/
begin
wwv_flow_api.component_begin (
 p_version_yyyy_mm_dd=>'2020.03.31'
,p_release=>'20.1.0.00.13'
,p_default_workspace_id=>2400405578329584
,p_default_application_id=>100
,p_default_id_offset=>0
,p_default_owner=>'FLOWS4APEX'
);
wwv_flow_api.append_to_install_script(
 p_id=>wwv_flow_api.id(8807340970384277)
,p_script_clob=>wwv_flow_string.join(wwv_flow_t_varchar2(
'                );',
'                     when ''get'' then',
'                        apex_exec.execute_plsql(   ''begin',
'                           :'' || l_item_name || '' :=  flow_process_vars.get_var_date(',
'                                                pi_prcs_id  => ''||l_prcs_id||''',
'                                             , pi_var_name => ''''''||l_prcs_var_name||''''''',
'                                          ); ',
'                           end;'');',
'                  end case;',
'               when ''clob'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then l_process_variable.get_clob(''value'')',
'                                 when ''get'' ',
'                                    then flow_process_vars.get_var_clob(',
'                                              pi_prcs_id  => l_prcs_id',
'                                            , pi_var_name => l_prcs_var_name',
'                                         )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        flow_process_vars.set_var(',
'                        pi_prcs_id    => l_prcs_id',
'                        , pi_var_name   => l_prcs_var_name',
'                        , pi_clob_value => l_process_variable.get_clob(''value'')',
'                        );',
'                     when ''get'' then',
'                        apex_exec.execute_plsql(''begin',
'                           :'' || l_item_name || '' := flow_process_vars.get_var_clob(',
'                                                pi_prcs_id  => ''|| l_prcs_id ||''',
'                                             , pi_var_name => ''''''|| l_prcs_var_name ||''''''',
'                                          );',
'                           end;''',
'                        );',
'                  end case;                   ',
'               else',
'                  raise e_incorrect_variable_type;',
'            end case;',
'         end loop;',
'      elsif ( l_attribute5 = ''item'' ) then',
'         -- Get process variable(s) name(s)',
'         l_split_prcs_var := apex_string.split(l_attribute6, '','');',
'',
'         -- Get APEX item(s) name(s)',
'         l_split_items := apex_string.split(l_attribute7, '','');',
'',
'         --Raise exception if number of process variables is not the same of APEX items',
'         if ( l_split_prcs_var.count() != l_split_items.count() ) then',
'            raise e_var_config;',
'         end if;',
'',
'         -- Get process variables types',
'         for rec in (',
'            select prov_var_name, prov_var_type',
'            from flow_process_variables prov',
'         where prov.prov_prcs_id = l_prcs_id',
'            and prov.prov_var_name in (',
'               select trim(column_value)',
'               from table(l_split_prcs_var)',
'            )',
'         )',
'         loop',
'            l_prcs_var(rec.prov_var_name) := rec.prov_var_type;',
'         end loop;',
'',
'         -- Get items types',
'         for rec in (',
'            select column_value as item_name',
'               , case',
'                     when aapi.display_as_code = ''NATIVE_NUMBER_FIELD''    then',
'                        ''NUMBER''',
'                     when aapi.display_as_code = ''NATIVE_DATE_PICKER''     then',
'                        ''DATE''',
'                     else',
'                        ''VARCHAR2''',
'                  end as item_type',
'               , coalesce(aapi.format_mask, v(''APP_NLS_DATE_FORMAT'')) format_mask',
'            from table(apex_string.split(l_attribute7, '','')) items',
'            left outer join apex_application_page_items aapi',
'               on aapi.item_name = items.column_value',
'            left outer join apex_application_items aai',
'               on aai.item_name = items.column_value',
'         )',
'         loop',
'            l_items(rec.item_name).item_type   := rec.item_type;',
'            l_items(rec.item_name).format_mask := rec.format_mask;',
'         end loop;',
'',
'         -- Loop through variables',
'         for i in l_split_prcs_var.first..l_split_prcs_var.last',
'         loop',
'            -- Get process variable name and item name ',
'            l_prcs_var_name := trim( l_split_prcs_var( i ) );',
'            l_item_name     := trim( l_split_items( i ) );',
'',
'            -- Look for variable type',
'            begin',
'               l_prcs_var_type := l_prcs_var( l_prcs_var_name );',
'            exception ',
'               -- Look for item type',
'               when no_data_found then',
'                  l_prcs_var_type := l_items ( l_item_name ).item_type;',
'            end;',
'            ',
'            case l_prcs_var_type ',
'               when ''VARCHAR2'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then apex_util.get_session_state( p_item => l_item_name )',
'                                 when ''get'' ',
'                                    then flow_process_vars.get_var_vc2(',
'                                              pi_prcs_id  => l_prcs_id',
'                                            , pi_var_name => l_prcs_var_name',
'                                         )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        flow_process_vars.set_var(',
'                           pi_prcs_id    => l_prcs_id',
'                           , pi_var_name   => l_prcs_var_name',
'                           , pi_vc2_value  => apex_util.get_session_state( p_item => l_item_name )',
'                        );',
'                     when ''get'' then',
'                        apex_util.set_session_state( ',
'                             p_name  => l_item_name',
'                           , p_value => flow_process_vars.get_var_vc2(',
'                                             pi_prcs_id  => l_prcs_id',
'                                           , pi_var_name => l_prcs_var_name',
'                                        ) ',
'                        );',
'                  end case;',
'',
'               when ''NUMBER'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then to_number( apex_util.get_session_state( p_item => l_item_name ) )',
'                                 when ''get'' ',
'                                    then flow_process_vars.get_var_num(',
'                                              pi_prcs_id  => l_prcs_id',
'                                            , pi_var_name => l_prcs_var_name',
'                                         )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        flow_process_vars.set_var(',
'                           pi_prcs_id    => l_prcs_id',
'                           , pi_var_name   => l_prcs_var_name',
'                           , pi_num_value  => to_number( apex_util.get_session_state( p_item => l_item_name ) )',
'                        );',
'                     when ''get'' then',
'                        apex_util.set_session_state( ',
'                             p_name  => l_item_name',
'                           , p_value => flow_process_vars.get_var_num(',
'                                             pi_prcs_id  => l_prcs_id',
'                                           , pi_var_name => l_prcs_var_name',
'                                        ) ',
'                        );',
'                  end case;',
'               when ''DATE'' then',
'                  apex_debug.info(',
'                     p_message => ''......Name: %s - Type: %s - Value %s''',
'                     , p0 => l_prcs_var_name',
'                     , p1 => l_prcs_var_type',
'                     , p2 => case l_attribute4',
'                                when ''set'' ',
'                                   then apex_util.get_session_state( p_item => l_item_name )',
'                                 when ''get'' ',
'                                    then to_char(',
'                                            flow_process_vars.get_var_date(',
'                                               pi_prcs_id  => l_prcs_id',
'                                             , pi_var_name => l_prcs_var_name',
'                                            ), l_items(l_item_name).format_mask ',
'                                          )',
'                             end ',
'                  );',
'                  case l_attribute4',
'                     when ''set'' then',
'                        flow_process_vars.set_var(',
'                           pi_prcs_id     => l_prcs_id',
'                           , pi_var_name    => l_prcs_var_name',
'                           , pi_date_value  => to_date( apex_util.get_session_state( p_item => l_item_name ) , l_items(l_item_name).format_mask )',
'                        );',
'                     when ''get'' then',
'                        apex_util.set_session_state( ',
'                             p_name  => l_item_name',
'                           , p_value => to_char(',
'                                          flow_process_vars.get_var_date(',
'                                             pi_prcs_id  => l_prcs_id',
'                                           , pi_var_name => l_prcs_var_name',
'                                        ), l_items(l_item_name).format_mask )',
'                        );',
'                  end case;',
'            when ''CLOB'' then',
'               apex_debug.info(',
'                  p_message => ''......Name: %s - Type: %s - Value %s''',
'                  , p0 => l_prcs_var_name',
'                  , p1 => l_prcs_var_type',
'                  , p2 => case l_attribute4',
'                             when ''set'' ',
'                                then apex_util.get_session_state( p_item => l_item_name )',
'                              when ''get'' ',
'                                 then flow_process_vars.get_var_clob(',
'                                           pi_prcs_id  => l_prcs_id',
'                                         , pi_var_name => l_prcs_var_name',
'                                      )',
'                          end ',
'               );',
'               case l_attribute4',
'                  when ''set'' then',
'                     flow_process_vars.set_var(',
'                        pi_prcs_id     => l_prcs_id',
'                        , pi_var_name    => l_prcs_var_name',
'                        , pi_clob_value  => apex_util.get_session_state( p_item => l_item_name )',
'                     );',
'                  when ''get'' then',
'                     apex_exec.execute_plsql(''begin',
'                        :'' || l_item_name || q''[ := '']'' || flow_process_vars.get_var_clob(',
'                                             pi_prcs_id  => l_prcs_id',
'                                          , pi_var_name => l_prcs_var_name',
'                                       ) || q''['';',
'                        end;]''',
'                     );',
'               end case;',
'            end case;',
'         end loop;',
'      end if;',
'      apex_debug.info(',
'           p_message => ''...End %s Flow Instance Variable(s)''',
'         , p0        => case l_attribute4',
'                           when ''set'' then ''setting''',
'                           when ''get'' then ''getting''',
'                        end ',
'      );',
'',
'      -- Return instance id in the APEX item provided',
'      if ( l_attribute10 is not null ) then',
'         apex_debug.info(',
'            p_message => ''...Return Flow Instance Id into item "%s"''',
'         , p0        => l_attribute10',
'         );',
'         apex_util.set_session_state( l_attribute10, l_prcs_id );',
'      end if;',
'',
'      return l_result;',
'   exception ',
'      when e_var_config then',
'         apex_error.add_error( ',
'              p_message => ''Wrong number of APEX item(s) or process variable(s).''',
'            , p_display_location => apex_error.c_on_error_page',
'         );',
'      when e_incorrect_variable_type then',
'         if apex_application.g_debug then',
'            apex_debug.error(',
'               p_message => ''-- Flows4apex - Plug-in configuration issue, process variables JSON contains incorrect variable type.''',
'            );',
'         end if;',
'         apex_error.add_error(',
'              p_message           => ''Error during parsing process variables.''',
'            , p_display_location  => apex_error.c_on_error_page',
'         );',
'      when e_types_different then',
'         apex_error.add_error(',
'              p_message           => ''One or more process variable(s) are a different type than the one defined in the JSON.''',
'            , p_display_location  => apex_error.c_on_error_page',
'         );',
'      when e_invalid_number then',
'         apex_error.add_error(',
'              p_message           => apex_string.format( ''%s is not a valid number.'', l_json_element.stringify() )',
'            , p_display_location  => apex_error.c_on_error_page',
'         );',
'      when e_invalid_date then',
'         apex_error.add_error(',
'              p_message           => apex_string.format( ''%s is not a valid date.'', l_json_element.stringify() )',
'            , p_display_location  => apex_error.c_on_error_page',
'         );',
'   end execution;',
'',
'end flow_plugin_manage_instance_variables;',
'/',
'',
'create or replace package body flow_modeler',
'as',
'',
'  function render',
'  (',
'    p_region              in  apex_plugin.t_region',
'  , p_plugin              in  apex_plugin.t_plugin',
'  , p_is_printer_friendly in  boolean',
'  )',
'    return apex_plugin.t_region_render_result',
'  as',
'    l_return apex_plugin.t_region_render_result;',
'  begin',
'',
'    apex_plugin_util.debug_region',
'    (',
'      p_plugin => p_plugin',
'    , p_region => p_region',
'    );',
'',
'    sys.htp.p( ''<div id="'' || p_region.static_id || ''_modeler" class="flows4apex-modeler '' || v(''THEME_PLUGIN_CLASS'') || ''">'' );',
'    sys.htp.p( ''<div id="'' || p_region.static_id || ''_canvas" class="canvas"></div>'' );',
'    sys.htp.p( ''<div id="'' || p_region.static_id || ''_properties" class="properties-panel-parent"></div>'' );',
'    sys.htp.p( ''</div>'' );',
'',
'    apex_javascript.add_onload_code',
'    (',
'      p_code =>',
'        ''apex.jQuery("#'' || p_region.static_id || ''").modeler({'' ||',
'        apex_javascript.add_attribute',
'        (',
'          p_name      => ''ajaxIdentifier''',
'        , p_value     => apex_plugin.get_ajax_identifier',
'        , p_add_comma => true',
'        ) ||',
'        apex_javascript.add_attribute',
'        (',
'          p_name      => ''itemsToSubmit''',
'        , p_value     => apex_plugin_util.page_item_names_to_jquery( p_page_item_names => p_region.ajax_items_to_submit )',
'        , p_add_comma => true',
'        ) ||',
'        ''})''',
'    );',
'',
'    return l_return;',
'    ',
'  end render;',
'',
'  procedure load',
'  (',
'    p_region in apex_plugin.t_region',
'  , p_plugin in apex_plugin.t_plugin',
'  )',
'  as',
'    type t_col_position_tab is table of pls_integer index by varchar2(128);',
'    ',
'    l_col_positions t_col_position_tab;',
'    l_context       apex_exec.t_context;',
'',
'    l_id      number;',
'    l_content clob;',
'    l_found   boolean := false;',
'  begin',
'    apex_plugin_util.debug_region',
'    (',
'      p_plugin => p_plugin',
'    , p_region => p_region',
'    );',
'',
'    l_context :=',
'      apex_exec.open_query_context',
'      (',
'        p_first_row => 1',
'      , p_max_rows  => 1',
'      );',
'',
'    l_col_positions(''id'') :=',
'      apex_exec.get_column_position',
'      (',
'        p_context     => l_context',
'      , p_column_name => ''DGRM_ID''',
'      , p_is_required => true',
'      , p_data_type   => apex_exec.c_data_type_number',
'      );',
'    ',
'    l_col_positions(''content'') :=',
'      apex_exec.get_column_position',
'      (',
'        p_context     => l_context',
'      , p_column_name => ''DGRM_CONTENT''',
'      , p_is_required => true',
'      , p_data_type   => apex_exec.c_data_type_clob',
'      );',
'',
'    apex_json.open_object;',
'    apex_json.write',
'    (',
'      p_name  => ''success''',
'    , p_value => true',
'    );',
'',
'    if apex_exec.next_row( p_context => l_context ) then',
'      l_found   := true;',
'      l_id      := apex_exec.get_number( p_context => l_context, p_column_idx => l_col_positions(''id'') );',
'      l_content := apex_exec.get_clob( p_context => l_context, p_column_idx => l_col_positions(''content'') );',
'    else',
'      l_found   := false;',
'    end if;',
'',
'    apex_exec.close( p_context => l_context );',
'',
'    apex_json.write',
'    (',
'      p_name  => ''found''',
'    , p_value => l_found',
'    );',
'',
'    apex_json.open_object',
'    (',
'      p_name => ''data''',
'    );',
'',
'    if l_found then',
'      apex_json.write',
'      (',
'        p_name  => ''id''',
'      , p_value => l_id',
'      );',
'',
'      apex_json.write',
'      (',
'        p_name  => ''content''',
'      , p_value => l_content',
'      );',
'    else',
'      apex_json.write',
'      (',
'        p_name  => ''message''',
'      , p_value => ''No data found. Check if Diagram with given ID exists.''',
'      );',
'    end if;',
'',
'    apex_json.close_all;',
'  exception',
'    when others then',
'      apex_exec.close( p_context => l_context );',
'      apex_json.open_object;',
'      apex_json.write',
'      (',
'        p_name  => ''success''',
'      , p_value => false',
'      );',
'      apex_json.write',
'      (',
'        p_name  => ''message''',
'      , p_value => ''Unexpected error, please contact your administrator.''',
'      );',
'      apex_json.close_all;',
'  end load;',
'',
'  procedure save',
'  (',
'    p_region in apex_plugin.t_region',
'  , p_plugin in apex_plugin.t_plugin',
'  )',
'  as',
'    l_str_tab apex_t_varchar2 := apex_t_varchar2();',
'    l_clob    clob;',
'    l_values  apex_json.t_values;',
'',
'    l_id      number;',
'    l_content clob;',
'  begin',
'    for i in 1..apex_application.g_json.count loop',
'      l_str_tab.extend();',
'      l_str_tab(i) := apex_application.g_json(i);',
'    end loop;',
'    l_clob := apex_string.join_clob( p_table => l_str_tab, p_sep => null );',
'',
'    apex_json.parse',
'    (',
'      p_values => l_values',
'    , p_source => l_clob',
'    );',
'',
'    l_id      := apex_json.get_number( p_values => l_values, p_path => ''regions[1].data.id'' );',
'    l_content := apex_json.get_clob( p_values => l_values, p_path => ''regions[1].data.content'');',
'',
'    flow_bpmn_parser_pkg.update_diagram',
'    (',
'      pi_dgrm_id      => l_id',
'    , pi_dgrm_content => l_content',
'    );',
'',
'    apex_json.open_object;',
'    apex_json.write( p_name => ''success'', p_value => true );',
'    apex_json.close_all;',
'  exception',
'    when others then',
'      apex_json.open_object;',
'      apex_json.write( p_name => ''success'', p_value => false );',
'      apex_json.write',
'      (',
'        p_name  => ''message''',
'      , p_value => ''Diagram could not be parsed.<br />Please review your diagram to ensure that it is supported.''',
'      );',
'      apex_json.close_all;',
'  end save;',
'',
'  function ajax',
'  (',
'    p_region              in  apex_plugin.t_region',
'  , p_plugin              in  apex_plugin.t_plugin',
'  )',
'    return apex_plugin.t_region_ajax_result',
'  as',
'    l_return apex_plugin.t_region_ajax_result;',
'  begin',
'    case upper(apex_application.g_x01)',
'      when ''LOAD'' then load( p_region => p_region, p_plugin => p_plugin );',
'      when ''SAVE'' then save( p_region => p_region, p_plugin => p_plugin );',
'      else null;',
'    end case;',
'',
'    return l_return;',
'  end ajax;',
'',
'end flow_modeler;',
'/',
'',
'create or replace package body flow_viewer',
'as',
'',
'    function render',
'  (',
'    p_region              in  apex_plugin.t_region',
'  , p_plugin              in  apex_plugin.t_plugin',
'  , p_is_printer_friendly in  boolean',
'  )',
'    return apex_plugin.t_region_render_result',
'  as',
'    l_return apex_plugin.t_region_render_result;',
'  begin',
'',
'    apex_plugin_util.debug_region',
'    (',
'      p_plugin => p_plugin',
'    , p_region => p_region',
'    );',
'',
'    sys.htp.p( ''<div id="'' || p_region.static_id || ''_canvas" class="flows4apex-viewer '' || v(''THEME_PLUGIN_CLASS'') || ''" style="display: none;"></div>'' );',
'    sys.htp.p( ''<span id="'' || p_region.static_id || ''_ndf" class="nodatafound" style="display: none;">'' || coalesce(p_region.no_data_found_message, ''No data found.'') || ''</span>'' );',
'',
'    apex_javascript.add_onload_code',
'    (',
'      p_code => ''apex.jQuery("#'' || p_region.static_id || ''").viewer({'' ||',
'                  apex_javascript.add_attribute',
'                  (',
'                    p_name      => ''ajaxIdentifier''',
'                  , p_value     => apex_plugin.get_ajax_identifier',
'                  , p_add_comma => true',
'                  ) ||',
'                  apex_javascript.add_attribute',
'                  (',
'                    p_name      => ''itemsToSubmit''',
'                  , p_value     => apex_plugin_util.page_item_names_to_jquery( p_page_item_names => p_region.ajax_items_to_submit )',
'                  , p_add_comma => true',
'                  ) ||',
'                  apex_javascript.add_attribute',
'                  (',
'                    p_name      => ''noDataFoundMessage''',
'                  , p_value     => p_region.no_data_found_message',
'                  , p_add_comma => true',
'                  ) ||',
'                  apex_javascript.add_attribute',
'                  (',
'                    p_name      => ''refreshOnLoad''',
'                  , p_value     => ( p_region.attribute_08 = ''Y'' )',
'                  , p_add_comma => true',
'                  ) ||',
'                  apex_javascript.add_attribute',
'                  (',
'                    p_name      => ''enableExpandModule''',
'                  , p_value     => ( p_region.attribute_10 = ''Y'' )',
'                  , p_add_comma => true',
'                  ) ||',
'                  apex_javascript.add_attribute',
'                  (',
'                    p_name      => ''useNavigatedViewer''',
'                  , p_value     => ( p_region.attribute_11 = ''Y'' )',
'                  , p_add_comma => true',
'                  ) ||',
'                  ''"config":'' || p_region.init_javascript_code || ''({})'' ||',
'                ''})''',
'    );',
'',
'    return l_return;',
'  end render;',
'',
'  function ajax',
'  (',
'    p_region              in  apex_plugin.t_region',
'  , p_plugin              in  apex_plugin.t_plugin',
'  )',
'    return apex_plugin.t_region_ajax_result',
'  as',
'',
'    l_context           apex_exec.t_context;',
'    l_diagram_col_idx   pls_integer;',
'    l_current_col_idx   pls_integer;',
'    l_completed_col_idx pls_integer;',
'    l_error_col_idx     pls_integer;',
'    l_row_found         boolean;',
'    l_column_value_list apex_plugin_util.t_column_value_list2;',
'    l_data_type_list    apex_application_global.vc_arr2;',
'',
'    l_current_nodes   apex_t_varchar2;',
'    l_completed_nodes apex_t_varchar2;',
'    l_error_nodes     apex_t_varchar2;',
'',
'    l_return apex_plugin.t_region_ajax_result;',
'  begin',
'    apex_plugin_util.debug_region',
'    (',
'      p_plugin => p_plugin',
'    , p_region => p_region',
'    );',
'',
'    l_context :=',
'      apex_exec.open_query_context',
'      (',
'        p_first_row => 1',
'      , p_max_rows  => 1',
'      );',
'',
'    l_diagram_col_idx :=',
'      apex_exec.get_column_position',
'      (',
'        p_context     => l_context',
'      , p_column_name => p_region.attribute_01',
'      , p_is_required => true',
'      , p_data_type   => apex_exec.c_data_type_clob',
'      );',
'',
'    l_current_col_idx :=',
'      apex_exec.get_column_position',
'      (',
'        p_context     => l_context',
'      , p_column_name => p_region.attribute_02',
'      , p_is_required => false',
'      , p_data_type   => apex_exec.c_data_type_varchar2',
'      );',
'',
'    l_completed_col_idx :=',
'      apex_exec.get_column_position',
'      (',
'        p_context     => l_context',
'      , p_column_name => p_region.attribute_04',
'      , p_is_required => false',
'      , p_data_type   => apex_exec.c_data_type_varchar2',
'      );',
'',
'    l_error_col_idx :=',
'      apex_exec.get_column_position',
'      (',
'        p_context     => l_context',
'      , p_column_name => p_region.attribute_06',
'      , p_is_required => false',
'      , p_data_type   => apex_exec.c_data_type_varchar2',
'      );',
'',
'    apex_json.open_object;',
'',
'',
'    if apex_exec.next_row( p_context => l_context ) then',
'',
'      apex_json.write',
'      (',
'        p_name  => ''found''',
'      , p_value => true',
'      );',
'',
'      apex_json.open_object',
'      (',
'        p_name => ''data''',
'      );',
'',
'      apex_json.write',
'      (',
'        p_name  => ''diagram''',
'      , p_value => apex_exec.get_clob( p_context => l_context, p_column_idx => l_diagram_col_idx )',
'      );',
'',
'      apex_json.open_array',
'      (',
'        p_name => ''current''',
'      );',
'',
'      if l_current_col_idx is not null then',
'        l_current_nodes :=',
'          apex_string.split',
'          (',
'            p_str => apex_exec.get_varchar2( p_context => l_context, p_column_idx => l_current_col_idx )',
'          , p_sep => '':''',
'          );',
'        ',
'        for i in 1..l_current_nodes.count loop',
'          apex_json.write( p_value => l_current_nodes(i) );',
'        end loop;',
'      end if;',
'',
'      apex_json.close_array;',
'',
'      apex_json.open_array',
'      (',
'        p_name => ''completed''',
'      );',
'      ',
'      if l_completed_col_idx is not null then',
'        l_completed_nodes :=',
'          apex_string.split',
'          (',
'            p_str => apex_exec.get_varchar2( p_context => l_context, p_column_idx => l_completed_col_idx )',
'          , p_sep => '':''',
'          );',
'        ',
'        for i in 1..l_completed_nodes.count loop',
'          apex_json.write( p_value => l_completed_nodes(i) );',
'        end loop;',
'      end if;',
'',
'      apex_json.close_array;',
'',
'      apex_json.open_array',
'      (',
'        p_name => ''error''',
'      );',
'',
'      if l_error_col_idx is not null then',
'        l_error_nodes :=',
'          apex_string.split',
'          (',
'            p_str => apex_exec.get_varchar2( p_context => l_context, p_column_idx => l_error_col_idx )',
'          , p_sep => '':''',
'          );',
'        ',
'        for i in 1..l_error_nodes.count loop',
'          apex_json.write( p_value => l_error_nodes(i) );',
'        end loop;',
'      end if;',
'',
'    else',
'      apex_json.write',
'      (',
'        p_name  => ''found''',
'      , p_value => false',
'      );',
'',
'    end if;',
'',
'    apex_json.close_all;',
'    return l_return;',
'  end ajax;',
'',
'end flow_viewer;',
'/',
''))
);
null;
wwv_flow_api.component_end;
end;
/
